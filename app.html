<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ProfitPilot — App</title>
  <meta name="description" content="ProfitPilot helps sellers estimate profit, margin, and fee sensitivity. Free trial with one-time PRO unlock.">
  <link rel="icon" href="https://ukwebtools.com/favicon.svg" type="image/svg+xml">

  <style>
    :root{
      --bg:#f6f8fb;
      --bg2:#eef2ff;
      --card:#ffffff;
      --txt:#0b1220;
      --muted:#5b6474;
      --line:rgba(16,24,40,.10);
      --accent:#0ea5a4;
      --accent2:#4f46e5;
      --shadow:0 10px 30px rgba(16,24,40,.08);
      --warn:#f59e0b;
      --bad:#ef4444;
      --ok:#0ea5a4;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(14,165,164,.16), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(79,70,229,.12), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg));
    }
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    .nav{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg, rgba(14,165,164,.18), rgba(79,70,229,.14));
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
    }
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.70);
      font-size:12px;color:var(--muted);
      display:inline-flex;gap:8px;align-items:center
    }
    .pill.ok{border-color:rgba(14,165,164,.30);background:rgba(14,165,164,.10);color:var(--txt)}
    .pill.warn{border-color:rgba(245,158,11,.30);background:rgba(245,158,11,.10);color:var(--txt)}
    .pill.bad{border-color:rgba(239,68,68,.30);background:rgba(239,68,68,.10);color:var(--txt)}

    .btn{
      padding:10px 14px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      color:var(--txt);
      display:inline-flex;gap:8px;align-items:center;
      cursor:pointer;
      box-shadow:0 4px 16px rgba(16,24,40,.06);
    }
    .btn.primary{border-color:rgba(14,165,164,.30);background:rgba(14,165,164,.10)}
    .btn.ghost{background:transparent;box-shadow:none}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:rgba(255,255,255,.82);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .title{font-weight:900;margin:0 0 8px}
    .small{font-size:12px;color:var(--muted);line-height:1.6}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:560px){.row{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.88);
      color:var(--txt);
      outline:none;
    }
    input:focus,select:focus{border-color:rgba(14,165,164,.35)}

    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:560px){.kpi{grid-template-columns:1fr}}
    .k{
      border:1px solid var(--line);
      background:rgba(255,255,255,.65);
      border-radius:16px;
      padding:12px;
    }
    .k .h{font-size:12px;color:var(--muted)}
    .k .v{font-size:20px;font-weight:900;margin-top:6px}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .hint{font-size:12px;color:var(--muted)}
    footer{margin:14px 2px 0;color:var(--muted);font-size:12px;line-height:1.6}

    .overlay{
      position:fixed;inset:0;
      background:rgba(16,24,40,.42);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:999;
    }
    .modal{
      width:min(760px,100%);
      background:rgba(255,255,255,.90);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .modal h2{margin:0 0 8px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media(max-width:840px){.two{grid-template-columns:1fr}}
    .stars button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      color:var(--txt);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
    }
    .stars button.active{
      border-color:rgba(14,165,164,.35);
      background:rgba(14,165,164,.10);
    }
    .toast{margin-top:10px;font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
<div class="wrap">

  <div class="nav">
    <div class="brand">
      <div class="logo">PP</div>
      <div>
        <div style="font-weight:900">ProfitPilot</div>
        <div class="pill">Estimates only • Independent tool</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <a class="btn ghost" href="https://ukwebtools.com/">← Ukwebtools</a>
      <a class="btn ghost" href="index.html">Home</a>
      <a class="btn ghost" href="reviews.html">Reviews</a>
      <span class="pill" id="accessPill">Checking access…</span>
      <button class="btn" id="logoutBtn">Log out</button>
    </div>
  </div>

  <div class="grid">

    <div class="card">
      <div class="title">Profit calculator</div>
      <div class="small">Pick a preset or enter values manually. Outputs are estimates based on your inputs.</div>

      <label>Platform preset</label>
      <select id="preset">
        <option value="manual">Manual (enter fees yourself)</option>
      </select>

      <div class="row">
        <div>
          <label>Selling price</label>
          <input id="sellPrice" inputmode="decimal" placeholder="0.00" value="0">
        </div>
        <div>
          <label>Product cost</label>
          <input id="productCost" inputmode="decimal" placeholder="0.00" value="0">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Shipping cost</label>
          <input id="shipCost" inputmode="decimal" placeholder="0.00" value="0">
        </div>
        <div>
          <label>Packaging / misc cost</label>
          <input id="miscCost" inputmode="decimal" placeholder="0.00" value="0">
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div>
          <label>Platform fee (%)</label>
          <input id="feePct" inputmode="decimal" placeholder="e.g., 12.8" value="0">
        </div>
        <div>
          <label>Fixed fee (per order)</label>
          <input id="feeFixed" inputmode="decimal" placeholder="0.00" value="0">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ads / promo cost (%)</label>
          <input id="adsPct" inputmode="decimal" placeholder="e.g., 3" value="0">
        </div>
        <div>
          <label>Return rate (%)</label>
          <input id="returnPct" inputmode="decimal" placeholder="e.g., 5" value="0">
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn primary" id="calcBtn">Calculate</button>
        <button class="btn" id="resetBtn">Reset to 0</button>
      </div>

      <div class="kpi">
        <div class="k">
          <div class="h">Estimated profit</div>
          <div class="v" id="profitOut">£0.00</div>
          <div class="hint" id="profitHint">—</div>
        </div>
        <div class="k">
          <div class="h">Margin</div>
          <div class="v" id="marginOut">0.0%</div>
          <div class="hint" id="marginHint">—</div>
        </div>
      </div>

      <div class="kpi">
        <div class="k">
          <div class="h">Total fees + ads</div>
          <div class="v" id="feesOut">£0.00</div>
          <div class="hint">Platform fee + fixed fee + ad %</div>
        </div>
        <div class="k">
          <div class="h">Return sensitivity (expected)</div>
          <div class="v" id="returnOut">£0.00</div>
          <div class="hint">Expected impact based on return rate</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="small">
        <b>Disclaimer:</b> Estimates only, not financial/legal/tax advice. Not affiliated with any platform.
        See <a href="https://ukwebtools.com/terms.html">Terms</a> and <a href="https://ukwebtools.com/privacy.html">Privacy</a>.
      </div>
    </div>

    <div class="card">
      <div class="title">Your workspace</div>
      <div class="small" id="userLine">Loading account…</div>

      <div class="divider"></div>

      <div class="title" style="margin:0 0 6px">Leave a review</div>
      <div class="small">Your review is public. Please be respectful — spam/abuse may be removed.</div>

      <label>Name (optional)</label>
      <input id="revName" placeholder="e.g., Faryal">

      <label>Category</label>
      <select id="revCat">
        <option>General</option>
        <option>UI/UX</option>
        <option>Accuracy</option>
        <option>Speed</option>
        <option>Features</option>
      </select>

      <label>Rating</label>
      <div class="stars" style="display:flex;gap:8px;flex-wrap:wrap" id="starsRow">
        <button type="button" data-star="1">★ 1</button>
        <button type="button" data-star="2">★ 2</button>
        <button type="button" data-star="3">★ 3</button>
        <button type="button" data-star="4">★ 4</button>
        <button type="button" data-star="5">★ 5</button>
      </div>

      <label>Review</label>
      <input id="revMsg" placeholder="What did you like? What should we improve?">

      <button class="btn primary" id="sendReview">Submit review</button>
      <div class="toast" id="reviewStatus">—</div>

      <div class="divider"></div>

      <div class="title" style="margin:0 0 6px">Quick links</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="reviews.html">Read public reviews</a>
        <a class="btn" href="https://stonevia.gumroad.com/l/goddhg" target="_blank" rel="noopener">Buy PRO</a>
      </div>
    </div>

  </div>

  <footer>© <span id="yr"></span> Ukwebtools • ProfitPilot</footer>
</div>

<div class="overlay" id="paywall">
  <div class="modal">
    <h2>Unlock ProfitPilot PRO</h2>
    <p class="small">
      Your free trial ended. Unlock PRO with a one-time purchase (no subscription).
      Gumroad emails your license key instantly. Paste it below to unlock.
    </p>

    <div class="two">
      <div class="card" style="padding:14px;box-shadow:none">
        <div class="title">Free Trial</div>
        <ul class="small" style="line-height:1.8;padding-left:16px;margin:8px 0 0">
          <li>5-day access</li>
          <li>Basic profit & margin</li>
          <li>Good for testing</li>
        </ul>
      </div>

      <div class="card" style="padding:14px;border-color:rgba(14,165,164,.35);box-shadow:none">
        <div class="title">PRO (One-time unlock)</div>
        <ul class="small" style="line-height:1.8;padding-left:16px;margin:8px 0 0">
          <li><b>Unlimited access</b></li>
          <li><b>Editable fee presets</b></li>
          <li><b>Risk & margin signals</b></li>
          <li><b>Return sensitivity checks</b></li>
          <li><b>Built for repeated decisions</b></li>
        </ul>
        <div class="pill ok" style="margin-top:10px">One-time purchase • No subscription</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <a class="btn primary" id="buyBtn" href="https://stonevia.gumroad.com/l/goddhg" target="_blank" rel="noopener">Buy PRO (one-time)</a>
      <a class="btn" href="reviews.html">See reviews</a>
    </div>

    <label style="margin-top:12px">Paste Gumroad license key</label>
    <input id="redeemInput" placeholder="e.g., ABCD-1234-EFGH-5678">
    <button class="btn primary" id="redeemBtn">Redeem & unlock</button>
    <div class="toast" id="redeemStatus">—</div>

    <div class="small" style="margin-top:12px">
      Need help? Email <a href="mailto:support@ukwebtools.com">support@ukwebtools.com</a>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://xsigsftvfknefpdfsyae.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzaWdzZnR2ZmtuZWZwZGZzeWFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzY4NjksImV4cCI6MjA4NTg1Mjg2OX0.Jkkh9Jd46saYBVipN8bxbWhjmhG6mgaFgtTpirKUAWg";

  const BUY_URL = "https://stonevia.gumroad.com/l/goddhg";
  const GUMROAD_REDEEM_FN = "https://xsigsftvfknefpdfsyae.supabase.co/functions/v1/gumroad-redeem";
  const TRIAL_DAYS = 5;

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  const accessPill = document.getElementById("accessPill");
  const userLine = document.getElementById("userLine");
  const paywall = document.getElementById("paywall");
  const buyBtn = document.getElementById("buyBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  buyBtn.href = BUY_URL;
  document.getElementById("yr").textContent = new Date().getFullYear();

  function n(v){ const x = parseFloat(String(v).replace(/,/g,"")); return Number.isFinite(x) ? x : 0; }
  function money(x){ const v = Number.isFinite(x) ? x : 0; return "£" + v.toFixed(2); }
  function pct(x){ const v = Number.isFinite(x) ? x : 0; return v.toFixed(1) + "%"; }
  function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

  const PRESETS = [
    { id:"manual", name:"Manual (enter fees yourself)", feePct:0, feeFixed:0, adsPct:0, returnPct:0 },
    { id:"ebay_uk_typical", name:"eBay UK (typical example)", feePct:12.8, feeFixed:0.30, adsPct:0, returnPct:3 },
    { id:"etsy_typical", name:"Etsy (typical example)", feePct:9.5, feeFixed:0.20, adsPct:0, returnPct:3 },
    { id:"shopify_card_only", name:"Shopify (card fee example)", feePct:2.0, feeFixed:0.20, adsPct:0, returnPct:2 },
  ];

  const presetSel = document.getElementById("preset");
  const feePctEl = document.getElementById("feePct");
  const feeFixEl = document.getElementById("feeFixed");
  const adsPctEl = document.getElementById("adsPct");
  const retPctEl = document.getElementById("returnPct");

  PRESETS.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.name;
    presetSel.appendChild(opt);
  });

  presetSel.value = "manual";
  presetSel.addEventListener("change", ()=>{
    const p = PRESETS.find(x=>x.id===presetSel.value) || PRESETS[0];
    if (p.id !== "manual") {
      feePctEl.value = String(p.feePct ?? 0);
      feeFixEl.value = String(p.feeFixed ?? 0);
      adsPctEl.value = String(p.adsPct ?? 0);
      retPctEl.value = String(p.returnPct ?? 0);
    }
    compute();
  });

  const sellPriceEl = document.getElementById("sellPrice");
  const productCostEl = document.getElementById("productCost");
  const shipCostEl = document.getElementById("shipCost");
  const miscCostEl = document.getElementById("miscCost");

  const profitOut = document.getElementById("profitOut");
  const marginOut = document.getElementById("marginOut");
  const feesOut = document.getElementById("feesOut");
  const returnOut = document.getElementById("returnOut");
  const profitHint = document.getElementById("profitHint");
  const marginHint = document.getElementById("marginHint");

  function compute(){
    const sell = n(sellPriceEl.value);
    const cost = n(productCostEl.value);
    const ship = n(shipCostEl.value);
    const misc = n(miscCostEl.value);

    const feePct = clamp(n(feePctEl.value), 0, 99);
    const feeFixed = clamp(n(feeFixEl.value), 0, 999999);
    const adsPct = clamp(n(adsPctEl.value), 0, 99);
    const retPct = clamp(n(retPctEl.value), 0, 99);

    const platformFee = sell * (feePct/100);
    const adsFee = sell * (adsPct/100);
    const totalFees = platformFee + feeFixed + adsFee;

    const expectedReturnImpact = sell * (retPct/100);

    const profit = sell - (cost + ship + misc + totalFees);
    const margin = sell > 0 ? (profit / sell) * 100 : 0;

    profitOut.textContent = money(profit);
    marginOut.textContent = pct(margin);
    feesOut.textContent = money(totalFees);
    returnOut.textContent = money(expectedReturnImpact);

    if (sell <= 0) {
      profitHint.textContent = "Enter a selling price.";
      marginHint.textContent = "—";
      profitHint.style.color = "var(--muted)";
      marginHint.style.color = "var(--muted)";
      return;
    }

    if (profit < 0) {
      profitHint.textContent = "Loss on this pricing. Adjust price or costs.";
      profitHint.style.color = "var(--bad)";
    } else if (profit < sell * 0.05) {
      profitHint.textContent = "Thin profit. Small changes can wipe margin.";
      profitHint.style.color = "var(--warn)";
    } else {
      profitHint.textContent = "Healthy buffer based on inputs.";
      profitHint.style.color = "var(--ok)";
    }

    if (margin < 0) {
      marginHint.textContent = "Negative margin.";
      marginHint.style.color = "var(--bad)";
    } else if (margin < 10) {
      marginHint.textContent = "Low margin — consider stress testing fees/returns.";
      marginHint.style.color = "var(--warn)";
    } else {
      marginHint.textContent = "Reasonable margin for many categories.";
      marginHint.style.color = "var(--ok)";
    }
  }

  document.getElementById("calcBtn").addEventListener("click", compute);
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    [sellPriceEl, productCostEl, shipCostEl, miscCostEl, feePctEl, feeFixEl, adsPctEl, retPctEl].forEach(el=>el.value="0");
    presetSel.value = "manual";
    compute();
  });
  [sellPriceEl, productCostEl, shipCostEl, miscCostEl, feePctEl, feeFixEl, adsPctEl, retPctEl].forEach(el=>{
    el.addEventListener("input", compute);
  });

  async function requireSession(){
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) { location.href = "login.html"; return null; }
    return session;
  }

  async function ensureProfile(userId){
    const { data: prof, error } = await supabase
      .from("profiles")
      .select("id, trial_start, paid, plan")
      .eq("id", userId)
      .maybeSingle();

    if (error) throw error;

    if (!prof) {
      const now = new Date().toISOString();
      const { error: insErr } = await supabase.from("profiles").insert([{
        id: userId,
        trial_start: now,
        paid: false,
        plan: "trial"
      }]);
      if (insErr) throw insErr;
      return { id:userId, trial_start: now, paid:false, plan:"trial" };
    }

    if (!prof.trial_start) {
      const now = new Date().toISOString();
      const { error: upErr } = await supabase.from("profiles").update({ trial_start: now }).eq("id", userId);
      if (upErr) throw upErr;
      prof.trial_start = now;
    }
    return prof;
  }

  function daysLeft(trialStartISO){
    const start = new Date(trialStartISO).getTime();
    const now = Date.now();
    const elapsedDays = (now - start) / (1000*60*60*24);
    const left = TRIAL_DAYS - elapsedDays;
    return Math.max(0, Math.ceil(left));
  }

  function showPaywall(show){ paywall.style.display = show ? "flex" : "none"; }

  async function updateAccessUI(profile, email){
    userLine.textContent = `Signed in as ${email}`;

    if (profile.paid) {
      accessPill.textContent = "Unlocked (PRO)";
      accessPill.className = "pill ok";
      showPaywall(false);
      return;
    }

    const left = daysLeft(profile.trial_start);
    if (left > 0) {
      accessPill.textContent = `Trial active • ${left} day(s) left`;
      accessPill.className = "pill warn";
      showPaywall(false);
    } else {
      accessPill.textContent = "Trial ended • PRO required";
      accessPill.className = "pill bad";
      showPaywall(true);
    }
  }

  async function redeemGumroad(licenseKey){
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) throw new Error("Please log in again.");

    const res = await fetch(GUMROAD_REDEEM_FN, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + session.access_token
      },
      body: JSON.stringify({ license_key: licenseKey })
    });

    const out = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(out.error || "Redeem failed.");
    return out;
  }

  const redeemBtn = document.getElementById("redeemBtn");
  const redeemInput = document.getElementById("redeemInput");
  const redeemStatus = document.getElementById("redeemStatus");

  redeemBtn.addEventListener("click", async ()=>{
    redeemStatus.textContent = "Verifying…";
    try {
      const key = (redeemInput.value || "").trim();
      if (!key) throw new Error("Paste your Gumroad license key.");
      const out = await redeemGumroad(key);
      redeemStatus.textContent = out.message || "Unlocked.";
      setTimeout(()=>location.reload(), 600);
    } catch(e){
      redeemStatus.textContent = e.message;
    }
  });

  let selectedStars = 5;
  const starsRow = document.getElementById("starsRow");
  const reviewStatus = document.getElementById("reviewStatus");

  function setStars(n){
    selectedStars = n;
    [...starsRow.querySelectorAll("button")].forEach(b=>{
      b.classList.toggle("active", parseInt(b.dataset.star,10) === n);
    });
  }
  setStars(5);

  starsRow.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if (!btn) return;
    setStars(parseInt(btn.dataset.star,10));
  });

  document.getElementById("sendReview").addEventListener("click", async ()=>{
    reviewStatus.textContent = "Submitting…";
    try{
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("Please log in again.");

      const name = document.getElementById("revName").value.trim();
      const category = document.getElementById("revCat").value;
      const message = document.getElementById("revMsg").value.trim();
      if (!message) throw new Error("Write a short review message.");

      const { error } = await supabase.from("reviews").insert([{
        user_id: user.id,
        name: name || null,
        rating: selectedStars,
        category,
        message,
        approved: true
      }]);

      if (error) throw error;
      reviewStatus.textContent = "Thanks! Your review is now public.";
      document.getElementById("revMsg").value = "";
    } catch(e){
      reviewStatus.textContent = e.message || "Failed to submit review.";
    }
  });

  document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    await supabase.auth.signOut();
    location.href = "login.html";
  });

  (async function init(){
    const session = await requireSession();
    if (!session) return;

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { location.href = "login.html"; return; }

    const profile = await ensureProfile(user.id);
    await updateAccessUI(profile, user.email || "user");
    compute();
  })();
</script>
</body>
</html>
