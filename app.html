<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ProfitPilot — App</title>
  <meta name="description" content="ProfitPilot: profit calculator with reverse pricing, bulk table, insights, competitor mode, export, share and saved presets.">
  <link rel="icon" href="https://ukwebtools.com/favicon.svg" type="image/svg+xml">

  <style>
    :root{
      --bg:#f6f8fb; --bg2:#eef2ff; --txt:#0b1220; --muted:#5b6474;
      --card:rgba(255,255,255,.90); --line:rgba(16,24,40,.10);
      --accent:#0ea5a4; --accent2:#4f46e5; --shadow:0 10px 30px rgba(16,24,40,.08);
      --warn:#f59e0b; --bad:#ef4444; --ok:#0ea5a4;

      /* footer */
      --f-bg:#0b0f14;
      --f-line:rgba(255,255,255,.10);
      --f-txt:rgba(255,255,255,.92);
      --f-muted:rgba(255,255,255,.68);
    }

    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(14,165,164,.16), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(79,70,229,.12), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg));
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    :focus-visible{outline:3px solid rgba(79,70,229,.55);outline-offset:3px;border-radius:12px}

    .skip{
      position:absolute;left:-9999px;top:10px;
      background:#fff;border:1px solid rgba(16,24,40,.14);
      padding:10px 12px;border-radius:12px;
      box-shadow:0 12px 24px rgba(16,24,40,.10);
      z-index:1000;
    }
    .skip:focus{left:12px}

    /* ===== Header (ONLY 3 NAV ITEMS) ===== */
    .pp-wrap{max-width:1200px;margin:0 auto;padding:0 16px}
    .pp-header{position:sticky; top:10px; z-index:100; margin:14px auto 0}
    .pp-headerbar{
      background:rgba(255,255,255,.78);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
      padding:10px;
    }
    .pp-row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:nowrap}
    .pp-brand{display:flex;gap:10px;align-items:center;min-width:220px}
    .pp-logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg, rgba(14,165,164,.18), rgba(79,70,229,.14));
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      font-weight:1000;color:var(--txt);
      user-select:none;
    }
    .pp-title{font-weight:1000;line-height:1.05}
    .pp-sub{font-size:12px;color:var(--muted);font-weight:750;margin-top:3px}
    @media(max-width:760px){.pp-sub{display:none}.pp-brand{min-width:auto}}

    .pp-nav{
      display:flex;gap:10px;align-items:center;justify-content:flex-end;
      flex:1 1 auto;
      overflow-x:auto;-webkit-overflow-scrolling:touch;
      padding:2px 4px;
      scrollbar-width:thin;
    }

    /* Existing UI atoms */
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.76);font-size:12px;color:var(--muted);
      display:inline-flex;gap:8px;align-items:center;white-space:nowrap
    }
    .pill.ok{border-color:rgba(14,165,164,.30);background:rgba(14,165,164,.10);color:var(--txt)}
    .pill.warn{border-color:rgba(245,158,11,.30);background:rgba(245,158,11,.10);color:var(--txt)}
    .pill.bad{border-color:rgba(239,68,68,.30);background:rgba(239,68,68,.10);color:var(--txt)}

    .btn{
      padding:10px 14px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.80);color:var(--txt);
      display:inline-flex;gap:8px;align-items:center;cursor:pointer;
      box-shadow:0 4px 16px rgba(16,24,40,.06);user-select:none;
      white-space:nowrap;
      text-decoration:none;
    }
    .btn.primary{border-color:rgba(14,165,164,.30);background:rgba(14,165,164,.10)}
    .btn.ghost{background:transparent;box-shadow:none}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    /* App layout */
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:18px 16px 40px;
    }
    @media (min-width:900px){
      .wrap{ padding:20px 22px 44px; }
    }

    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-top:18px;
    }
    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:20px;
      padding:18px;
      box-shadow:var(--shadow);
    }

    /* Premium rhythm */
    .title{font-weight:900;margin:0 0 10px}
    .small{font-size:12px;color:var(--muted);line-height:1.75}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media(max-width:560px){.kpi{grid-template-columns:1fr}}
    .k{border:1px solid var(--line);background:rgba(255,255,255,.76);border-radius:18px;padding:14px}
    .k .h{font-size:12px;color:var(--muted)}
    .k .v{font-size:20px;font-weight:900;margin-top:6px}
    .hint{font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.76);cursor:pointer;font-size:12px;user-select:none}
    .tab.active{border-color:rgba(14,165,164,.35);background:rgba(14,165,164,.10);font-weight:900}
    .toast{margin-top:10px;font-size:12px;color:var(--muted)}
    .good{color:var(--ok);font-weight:900}
    .bad{color:var(--bad);font-weight:900}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:560px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.94);color:var(--txt);outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:rgba(14,165,164,.35)}

    .banner{
      display:none;margin-top:12px;border:1px solid rgba(14,165,164,.28);
      background:rgba(14,165,164,.10);border-radius:16px;padding:10px 12px;
      color:var(--txt);font-size:12px;line-height:1.5;
    }

    .bulkWrap{overflow:auto;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.76)}
    table{width:100%;border-collapse:collapse;font-size:12px;min-width:980px}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:middle}
    th{color:var(--muted);font-weight:900;position:sticky;top:0;background:rgba(255,255,255,.95)}
    td input{padding:10px;border-radius:12px}
    .mini{padding:8px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.95)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .note{
      border:1px dashed rgba(16,24,40,.16);
      background:rgba(255,255,255,.70);
      border-radius:16px;padding:12px;margin-top:12px;color:var(--muted);
      font-size:12px;line-height:1.6;
    }

    .panel{
      border:1px solid rgba(79,70,229,.18);
      background:linear-gradient(180deg, rgba(79,70,229,.10), rgba(255,255,255,.72));
      border-radius:16px;padding:12px;margin-top:10px;
    }
    .pHead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:560px){.pGrid{grid-template-columns:1fr}}
    .pItem{border:1px solid var(--line);background:rgba(255,255,255,.76);border-radius:14px;padding:10px}
    .pItem .t{font-size:12px;color:var(--muted)}
    .pItem .v{font-weight:900;margin-top:6px}
    .pList{margin:10px 0 0;padding-left:18px;color:var(--muted);line-height:1.6;font-size:12px}
    .tag{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.82);font-size:12px;color:var(--muted);
    }

    /* ===== Footer (all other links) ===== */
    .pp-footer{
      margin-top:26px;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(94,234,212,.10), transparent 55%),
        radial-gradient(900px 520px at 80% 0%, rgba(96,165,250,.10), transparent 55%),
        var(--f-bg);
      border-top:1px solid rgba(255,255,255,.08);
      padding:26px 0;
    }
    .pp-footbox{
      border:1px solid var(--f-line);
      background:rgba(255,255,255,.04);
      border-radius:18px;
      padding:16px;
      max-width:1200px;
      margin:0 auto;
    }
    .pp-footgrid{
      display:grid;
      grid-template-columns:1.15fr .85fr;
      gap:16px;
      align-items:start;
      padding:0 16px;
    }
    @media(max-width:880px){.pp-footgrid{grid-template-columns:1fr}}
    .pp-footbrand b{color:var(--f-txt);font-weight:1000}
    .pp-footmut{
      margin-top:8px;
      color:var(--f-muted);
      font-size:12.6px;
      line-height:1.75;
      max-width:760px;
    }
    .pp-footmut a{color:rgba(94,234,212,.95);font-weight:900}
    .pp-footlinks{
      display:flex;flex-wrap:wrap;gap:10px;
      justify-content:flex-end;
    }
    @media(max-width:880px){.pp-footlinks{justify-content:flex-start}}
    .pp-footlinks a{
      padding:9px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--f-txt);
      font-weight:900;
      display:inline-flex;align-items:center;gap:8px;
      transition:transform .08s ease;
    }
    .pp-footlinks a:hover{transform:translateY(-1px);text-decoration:none}
    .pp-footbottom{
      margin-top:14px;padding-top:14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;
      color:rgba(255,255,255,.72);
      font-size:12.5px;line-height:1.75;
      padding:14px 16px 0;
    }
    .pp-footbottom a{color:rgba(94,234,212,.95);font-weight:900}

    @media print{
      body{background:#fff}
      .pp-header, .pp-footer, #tourOverlay, #controlsRow, #reviewsCard, #proCard, #logoutBtn, .tabs, #bulkTools, #bulkPasteBox, #importBanner {display:none !important}
      .wrap{margin:0;max-width:none}
      .card{box-shadow:none}
    }
  </style>
</head>

<body>
  <a class="skip" href="#content">Skip to content</a>

  <!-- ===== Header: ONLY 3 NAV ITEMS ===== -->
  <header class="pp-header" role="navigation" aria-label="Primary">
    <div class="pp-wrap">
      <div class="pp-headerbar">
        <div class="pp-row">
          <div class="pp-brand" aria-label="ProfitPilot">
            <div class="pp-logo" aria-hidden="true">PP</div>
            <div>
              <div class="pp-title">ProfitPilot</div>
              <div class="pp-sub">Independent tool by UKwebtools</div>
            </div>
          </div>

          <nav class="pp-nav" aria-label="Main">
            <a class="btn ghost" href="https://ukwebtools.com/" rel="nofollow">← Ukwebtools</a>
            <a class="btn ghost" href="help.html">How to use</a>
            <a class="btn primary" href="login.html" id="accountLink">Account</a>
            <span class="pill" id="accessPill">Checking access…</span>
            <button class="btn" id="logoutBtn" type="button">Log out</button>
          </nav>
        </div>
      </div>

      <!-- Breadcrumbs (SEO JSON-LD only) -->
      <script type="application/ld+json">
      {
        "@context":"https://schema.org",
        "@type":"BreadcrumbList",
        "itemListElement":[
          {"@type":"ListItem","position":1,"name":"UKwebtools","item":"https://ukwebtools.com/"},
          {"@type":"ListItem","position":2,"name":"ProfitPilot","item":"https://profitpilot.ukwebtools.com/index.html"},
          {"@type":"ListItem","position":3,"name":"App","item":"https://profitpilot.ukwebtools.com/app.html"}
        ]
      }
      </script>
    </div>
  </header>

  <main class="wrap" id="content">
    <div class="banner" id="importBanner">Imported shared calculation ✅</div>

    <div class="grid">

      <!-- LEFT -->
      <div class="card">
        <div class="title">Calculator</div>
        <div class="small">Profit = normal. Reverse = target profit → required selling price. Bulk = multiple items.</div>

        <div class="tabs">
          <div class="tab active" id="tabProfit">Profit</div>
          <div class="tab" id="tabReverse">Reverse</div>
          <div class="tab" id="tabBulk">Bulk</div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Display currency</label>
            <select id="currency">
              <option value="GBP">GBP (£)</option>
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (€)</option>
              <option value="AUD">AUD ($)</option>
              <option value="CAD">CAD ($)</option>
              <option value="NZD">NZD ($)</option>
              <option value="AED">AED</option>
              <option value="SAR">SAR</option>
              <option value="PKR">PKR (₨)</option>
              <option value="INR">INR (₹)</option>
            </select>
          </div>
          <div>
            <label>Exchange rate (optional)</label>
            <input id="fxRate" inputmode="decimal" placeholder="e.g., 1 base = 1.25 selected">
          </div>
        </div>

        <!-- SINGLE -->
        <div id="singleBox">
          <div class="divider"></div>

          <label>Platform preset</label>
          <select id="preset">
            <option value="manual">Manual (enter fees yourself)</option>
          </select>

          <div class="row">
            <div><label>Selling price</label><input id="sellPrice" inputmode="decimal" value="0"></div>
            <div><label>Product cost</label><input id="productCost" inputmode="decimal" value="0"></div>
          </div>
          <div class="row">
            <div><label>Shipping cost</label><input id="shipCost" inputmode="decimal" value="0"></div>
            <div><label>Packaging / misc</label><input id="miscCost" inputmode="decimal" value="0"></div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div><label>Platform fee (%)</label><input id="feePct" inputmode="decimal" value="0"></div>
            <div><label>Fixed fee</label><input id="feeFixed" inputmode="decimal" value="0"></div>
          </div>
          <div class="row">
            <div><label>Ads (%)</label><input id="adsPct" inputmode="decimal" value="0"></div>
            <div><label>Return rate (%)</label><input id="returnPct" inputmode="decimal" value="0"></div>
          </div>

          <div id="reverseBox" style="display:none">
            <div class="divider"></div>
            <div class="title" style="margin:0 0 6px;font-size:14px">Reverse mode</div>
            <div class="small">Trial: 3 reverse calculations total. PRO: unlimited.</div>
            <label>Target profit</label>
            <input id="targetProfit" inputmode="decimal" value="0">
            <div class="small" id="reverseUsesLine" style="margin-top:8px">Reverse uses: —</div>
          </div>

          <div class="divider"></div>

          <div class="row" id="controlsRow">
            <button class="btn primary" id="calcBtn" type="button">Calculate</button>
            <button class="btn" id="resetBtn" type="button">Reset</button>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button class="btn" id="exportCsvBtn" type="button">Export CSV</button>
            <button class="btn" id="pdfBtn" type="button">Export PDF (PRO)</button>
            <button class="btn" id="shareBtn" type="button">Share link (PRO)</button>
            <span class="pill" id="shareStatus">—</span>
          </div>

          <div class="kpi">
            <div class="k">
              <div class="h" id="o1h">Estimated profit</div>
              <div class="v" id="o1v">£0.00</div>
              <div class="hint" id="o1hint">—</div>
            </div>
            <div class="k">
              <div class="h" id="o2h">Margin</div>
              <div class="v" id="o2v">0.0%</div>
              <div class="hint" id="o2hint">—</div>
            </div>
          </div>

          <div class="kpi">
            <div class="k"><div class="h">Total fees + ads</div><div class="v" id="feesOut">£0.00</div><div class="hint">Platform fee + fixed + ads</div></div>
            <div class="k"><div class="h">Return sensitivity (expected)</div><div class="v" id="returnOut">£0.00</div><div class="hint">Expected impact from return %</div></div>
          </div>

          <div class="kpi" id="fxRow" style="display:none">
            <div class="k" style="grid-column:1 / -1">
              <div class="h">Converted selling price (your FX)</div>
              <div class="v" id="fxOut">—</div>
              <div class="hint" id="fxNote">—</div>
            </div>
          </div>

          <!-- INSIGHTS (PRO) -->
          <div class="panel" id="insightsBox">
            <div class="pHead">
              <div>
                <div style="font-weight:900">Insights (PRO)</div>
                <div class="small">Decision support from your inputs (estimates only).</div>
              </div>
              <span class="tag" id="insStatus">Locked</span>
            </div>

            <div class="pGrid">
              <div class="pItem"><div class="t">Break-even price</div><div class="v" id="bePrice">—</div></div>
              <div class="pItem">
                <div class="t">Price for target margin</div><div class="v" id="targetMarginPrice">—</div>
                <div class="small">Target: <span id="targetMarginVal">15%</span></div>
              </div>
              <div class="pItem"><div class="t">Max ads % you can afford</div><div class="v" id="maxAdsPct">—</div><div class="small">Keeps profit ≥ 0</div></div>
              <div class="pItem"><div class="t">Risk rating</div><div class="v" id="riskLabel">—</div><div class="small" id="riskExplain">—</div></div>
            </div>

            <ul class="pList" id="insBullets"><li>Unlock PRO to see insights.</li></ul>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Target margin (%)</label>
                <input id="targetMarginInput" inputmode="decimal" value="15">
              </div>
              <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
                <button class="btn" id="refreshInsightsBtn" type="button">Refresh insights</button>
                <span class="pill" id="insToast">—</span>
              </div>
            </div>
          </div>

          <!-- COMPETITOR MODE -->
          <div class="panel" id="compBox">
            <div class="pHead">
              <div>
                <div style="font-weight:900">Competitor mode (manual)</div>
                <div class="small">Enter competitor prices you found yourself. No scraping.</div>
              </div>
              <span class="tag" id="compStatus">Trial limited</span>
            </div>

            <div class="small" id="compUsesLine" style="margin-top:6px">Competitor uses: —</div>

            <div class="row" style="margin-top:8px">
              <div><label>Competitor price #1</label><input id="c1" inputmode="decimal" value="0"></div>
              <div><label>Competitor price #2</label><input id="c2" inputmode="decimal" value="0"></div>
            </div>
            <div class="row">
              <div><label>Competitor price #3</label><input id="c3" inputmode="decimal" value="0"></div>
              <div>
                <label>Positioning</label>
                <select id="positioning">
                  <option value="undercut">Undercut slightly</option>
                  <option value="match">Match market</option>
                  <option value="premium">Premium (if your offer is better)</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Buffer above break-even (%)</label>
                <input id="floorBuffer" inputmode="decimal" value="5">
                <div class="small">“Don’t go below” = break-even + buffer</div>
              </div>
              <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
                <button class="btn primary" id="runCompBtn" type="button">Run competitor mode</button>
                <span class="pill" id="compToast">—</span>
              </div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
              <button class="btn" id="useSuggestedBtn" type="button" disabled>Use suggested price</button>
              <button class="btn" id="saveScenarioBtn" type="button">Save scenario (PRO)</button>
              <span class="pill" id="scenarioToast">—</span>
            </div>

            <div class="pGrid" style="margin-top:10px">
              <div class="pItem"><div class="t">Market reference (median)</div><div class="v" id="compMedian">—</div></div>
              <div class="pItem"><div class="t">Suggested price</div><div class="v" id="compSuggest">—</div><div class="small" id="compWhy">—</div></div>
              <div class="pItem"><div class="t">Don’t go below</div><div class="v" id="compFloor">—</div><div class="small">Break-even + buffer</div></div>
              <div class="pItem"><div class="t">Reality check</div><div class="v" id="compCheck">—</div><div class="small" id="compCheck2">—</div></div>
            </div>

            <ul class="pList" id="compBullets">
              <li>Tip: use “Don’t go below” as your personal floor price.</li>
            </ul>
          </div>
        </div>

        <!-- BULK -->
        <div id="bulkBox" style="display:none">
          <div class="small" id="bulkLimitLine">Loading bulk limits…</div>

          <div class="divider"></div>

          <div id="bulkPasteBox">
            <div class="title" style="margin:0 0 6px;font-size:14px">Paste rows</div>
            <div class="small">Paste: <b>Sell, Cost, Ship, Misc</b> (comma or tab).</div>
            <textarea id="bulkPaste" placeholder="Example:
12.99, 6.20, 0.00, 0.20
19.99, zß=9.50, 0.00, 0.30"></textarea>
            <div class="actions" style="margin-top:10px">
              <button class="btn" id="bulkImportBtn" type="button">Import into table</button>
              <button class="btn" id="bulkFillExampleBtn" type="button">Fill example</button>
              <span class="pill" id="bulkImportStatus">—</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="actions" id="bulkTools">
            <button class="btn primary" id="bulkRunBtn" type="button">Run bulk</button>
            <button class="btn" id="bulkAddRowBtn" type="button">+ Add row</button>
            <button class="btn" id="bulkClearBtn" type="button">Clear rows</button>
            <button class="btn" id="bulkApplyFeesBtn" type="button">Apply current fees to all</button>
            <button class="btn" id="bulkExportBtn" type="button">Export bulk CSV</button>
            <span class="pill" id="bulkStatus">—</span>
          </div>

          <div style="margin-top:10px" class="bulkWrap">
            <table id="bulkTable">
              <thead>
                <tr>
                  <th style="width:56px">#</th>
                  <th>Sell</th>
                  <th>Cost</th>
                  <th>Ship</th>
                  <th>Misc</th>
                  <th>Fee %</th>
                  <th>Fixed</th>
                  <th>Ads %</th>
                  <th>Return %</th>
                  <th>Profit</th>
                  <th>Margin</th>
                  <th style="width:90px">Action</th>
                </tr>
              </thead>
              <tbody id="bulkTbody"></tbody>
            </table>
          </div>

          <div class="note">
            <b>Trial rules:</b> max <b>3 rows</b> and <b>1 bulk run per day</b>. PRO is unlimited.
          </div>
        </div>

        <div class="divider"></div>
        <div class="small">
          <b>Disclaimer:</b> estimates only (not financial/legal/tax advice). Not affiliated with any platform.
          FX depends on your entered rate (no live rates). See
          <a href="terms.html">Terms</a> and
          <a href="privacy.html">Privacy</a>.
        </div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="card" id="proCard">
          <div class="title">PRO features</div>
          <div class="small">Unlimited reverse + competitor + bulk, PDF export, share links, insights, saved scenarios. One-time unlock.</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <a class="btn primary" href="https://stonevia.gumroad.com/l/goddhg" target="_blank" rel="noopener">Buy PRO</a>
            <a class="btn" href="reviews.html">See reviews</a>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="title">Saved scenarios (PRO)</div>
          <div class="small">Saved locally on this device for speed. (PRO-only to save.)</div>

          <label>Saved scenarios</label>
          <select id="scenarioSel"><option value="">—</option></select>

          <div class="row">
            <button class="btn" id="loadScenarioBtn" type="button">Load</button>
            <button class="btn" id="deleteScenarioBtn" type="button">Delete</button>
          </div>

          <div class="divider"></div>

          <label>Scenario name</label>
          <input id="scenarioName" placeholder="e.g., Competitor median £13.49">

          <div class="row">
            <button class="btn primary" id="saveScenarioBtn2" type="button">Save current (PRO)</button>
            <span class="pill" id="scenarioStatus">—</span>
          </div>
        </div>

        <div class="card" id="reviewsCard" style="margin-top:14px">
          <div class="title">Leave a review</div>
          <div class="small">Reviews publish immediately. Spam/abuse may be removed.</div>

          <label>Name (optional)</label>
          <input id="revName" placeholder="Name">

          <label>Category</label>
          <select id="revCat">
            <option>General</option>
            <option>UI/UX</option>
            <option>Accuracy</option>
            <option>Speed</option>
            <option>Features</option>
          </select>

          <label>Rating</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap" id="starsRow">
            <button class="btn" type="button" data-star="1">★ 1</button>
            <button class="btn" type="button" data-star="2">★ 2</button>
            <button class="btn" type="button" data-star="3">★ 3</button>
            <button class="btn" type="button" data-star="4">★ 4</button>
            <button class="btn" type="button" data-star="5">★ 5</button>
          </div>

          <label>Review</label>
          <input id="revMsg" placeholder="What did you like? What should we improve?">

          <button class="btn primary" id="sendReview" type="button">Submit review</button>
          <div class="toast" id="reviewStatus">—</div>
        </div>

        <div style="margin-top:14px" class="small">© <span id="yr"></span> UKwebtools • ProfitPilot</div>
      </div>
    </div>
  </main>

  <!-- ===== Footer: ALL OTHER LINKS (no repeats) ===== -->
  <footer class="pp-footer" role="contentinfo">
    <div class="pp-footbox">
      <div class="pp-footgrid">
        <div class="pp-footbrand">
          <div><b>ProfitPilot</b></div>
          <div class="pp-footmut">
            <b>Independent tool:</b> not affiliated with any marketplace/platform/payment provider.<br>
            <b>Estimates only:</b> outputs depend on your inputs and assumptions; no profit guarantees.<br>
            Need help? <a href="mailto:support@ukwebtools.com">support@ukwebtools.com</a>
          </div>
        </div>

        <div class="pp-footlinks" aria-label="Footer links">
          <a href="index.html">Home</a>
          <a href="pricing.html">Pricing</a>
          <a href="reviews.html">Reviews</a>
          <a href="refunds.html">Refund Policy</a>
          <a href="faq.html">FAQ</a>
          <a href="terms.html">Terms</a>
          <a href="privacy.html">Privacy</a>
        </div>
      </div>

      <div class="pp-footbottom">
        <div>© <span id="yr2"></span> UKwebtools • ProfitPilot</div>
        <div><a href="https://ukwebtools.com/" rel="nofollow">UKwebtools</a></div>
      </div>
    </div>
  </footer>

  <!-- FIRST-TIME TOUR (ONBOARDING) -->
  <div id="tourOverlay" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,.45);backdrop-filter:blur(6px);z-index:9999;">
    <div id="tourCard" style="max-width:520px;margin:10vh auto 0;background:rgba(255,255,255,.96);border:1px solid rgba(16,24,40,.12);border-radius:20px;box-shadow:0 22px 70px rgba(16,24,40,.18);padding:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="font-weight:1000;letter-spacing:-.01em">Quick tour</div>
        <span id="tourStepPill" style="font-size:12px;color:rgba(16,24,40,.60);font-weight:900">Step 1/6</span>
      </div>

      <div id="tourTitle" style="margin-top:10px;font-size:18px;font-weight:1000;letter-spacing:-.01em">Welcome to ProfitPilot</div>
      <div id="tourBody" style="margin-top:8px;color:rgba(16,24,40,.70);line-height:1.65;font-size:13.5px">
        This takes 20 seconds. We’ll show you where everything is.
      </div>

      <div id="tourHint" style="margin-top:12px;padding:10px 12px;border-radius:14px;border:1px dashed rgba(16,24,40,.18);background:rgba(255,255,255,.75);color:rgba(16,24,40,.62);font-size:12.5px;line-height:1.6">
        Tip: You can skip anytime.
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;justify-content:flex-end">
        <button class="btn" id="tourSkipBtn" type="button">Skip</button>
        <button class="btn" id="tourBackBtn" type="button">Back</button>
        <button class="btn primary" id="tourNextBtn" type="button">Next</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://xsigsftvfknefpdfsyae.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzaWdzZnR2ZmtuZWZwZGZzeWFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzY4NjksImV4cCI6MjA4NTg1Mjg2OX0.Jkkh9Jd46saYBVipN8bxbWhjmhG6mgaFgtTpirKUAWg";

    const TRIAL_DAYS = 5;
    const TRIAL_REVERSE_LIMIT = 3;
    const TRIAL_COMP_LIMIT = 3;
    const TRIAL_BULK_MAX_ROWS = 3;
    const TRIAL_BULK_RUNS_PER_DAY = 1;

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

    const accessPill = document.getElementById("accessPill");
    const reverseUsesLine = document.getElementById("reverseUsesLine");
    const bulkLimitLine = document.getElementById("bulkLimitLine");
    const shareStatus = document.getElementById("shareStatus");
    const bulkStatus = document.getElementById("bulkStatus");
    const bulkImportStatus = document.getElementById("bulkImportStatus");
    const importBanner = document.getElementById("importBanner");
    const proCard = document.getElementById("proCard");


    const pdfBtn = document.getElementById("pdfBtn");
    const shareBtn = document.getElementById("shareBtn");

    const currencyEl = document.getElementById("currency");
    const fxRateEl = document.getElementById("fxRate");
    const presetSel = document.getElementById("preset");

    const sellPriceEl = document.getElementById("sellPrice");
    const productCostEl = document.getElementById("productCost");
    const shipCostEl = document.getElementById("shipCost");
    const miscCostEl = document.getElementById("miscCost");
    const feePctEl = document.getElementById("feePct");
    const feeFixedEl = document.getElementById("feeFixed");
    const adsPctEl = document.getElementById("adsPct");
    const returnPctEl = document.getElementById("returnPct");
    const targetProfitEl = document.getElementById("targetProfit");

    const o1h = document.getElementById("o1h");
    const o2h = document.getElementById("o2h");
    const o1v = document.getElementById("o1v");
    const o2v = document.getElementById("o2v");
    const o1hint = document.getElementById("o1hint");
    const o2hint = document.getElementById("o2hint");
    const feesOut = document.getElementById("feesOut");
    const returnOut = document.getElementById("returnOut");

    const fxRow = document.getElementById("fxRow");
    const fxOut = document.getElementById("fxOut");
    const fxNote = document.getElementById("fxNote");

    // Insights
    const insStatus = document.getElementById("insStatus");
    const bePriceEl = document.getElementById("bePrice");
    const targetMarginPriceEl = document.getElementById("targetMarginPrice");
    const maxAdsPctEl = document.getElementById("maxAdsPct");
    const riskLabelEl = document.getElementById("riskLabel");
    const riskExplainEl = document.getElementById("riskExplain");
    const insBullets = document.getElementById("insBullets");
    const targetMarginInput = document.getElementById("targetMarginInput");
    const targetMarginVal = document.getElementById("targetMarginVal");
    const refreshInsightsBtn = document.getElementById("refreshInsightsBtn");
    const insToast = document.getElementById("insToast");

    // Competitor
    const compStatus = document.getElementById("compStatus");
    const compUsesLine = document.getElementById("compUsesLine");
    const runCompBtn = document.getElementById("runCompBtn");
    const compToast = document.getElementById("compToast");
    const scenarioToast = document.getElementById("scenarioToast");
    const useSuggestedBtn = document.getElementById("useSuggestedBtn");
    const saveScenarioBtn = document.getElementById("saveScenarioBtn");

    const c1 = document.getElementById("c1");
    const c2 = document.getElementById("c2");
    const c3 = document.getElementById("c3");
    const positioning = document.getElementById("positioning");
    const floorBuffer = document.getElementById("floorBuffer");
    const compMedian = document.getElementById("compMedian");
    const compSuggest = document.getElementById("compSuggest");
    const compWhy = document.getElementById("compWhy");
    const compFloor = document.getElementById("compFloor");
    const compCheck = document.getElementById("compCheck");
    const compCheck2 = document.getElementById("compCheck2");
    const compBullets = document.getElementById("compBullets");

    // Scenario storage (PRO)
    const scenarioSel = document.getElementById("scenarioSel");
    const scenarioName = document.getElementById("scenarioName");
    const saveScenarioBtn2 = document.getElementById("saveScenarioBtn2");
    const loadScenarioBtn = document.getElementById("loadScenarioBtn");
    const deleteScenarioBtn = document.getElementById("deleteScenarioBtn");
    const scenarioStatus = document.getElementById("scenarioStatus");

    // Bulk
    const bulkRunBtn = document.getElementById("bulkRunBtn");
    const bulkAddRowBtn = document.getElementById("bulkAddRowBtn");
    const bulkClearBtn = document.getElementById("bulkClearBtn");
    const bulkApplyFeesBtn = document.getElementById("bulkApplyFeesBtn");
    const bulkExportBtn = document.getElementById("bulkExportBtn");
    const bulkPasteEl = document.getElementById("bulkPaste");
    const bulkImportBtn = document.getElementById("bulkImportBtn");
    const bulkFillExampleBtn = document.getElementById("bulkFillExampleBtn");
    const bulkTbody = document.getElementById("bulkTbody");

    // Tabs
    const tabProfit = document.getElementById("tabProfit");
    const tabReverse = document.getElementById("tabReverse");
    const tabBulk = document.getElementById("tabBulk");
    const singleBox = document.getElementById("singleBox");
    const reverseBox = document.getElementById("reverseBox");
    const bulkBox = document.getElementById("bulkBox");

    document.getElementById("yr").textContent = new Date().getFullYear();
    document.getElementById("yr2").textContent = new Date().getFullYear();

    // Dev-only duplicate ID detector (warns only)
    (function detectDuplicateIds(){
      const seen = new Map();
      document.querySelectorAll("[id]").forEach(el=>{
        const id = el.id;
        if (seen.has(id)) console.warn("Duplicate id:", id, el, seen.get(id));
        else seen.set(id, el);
      });
    })();

    const CURRENCY_SYMBOL = { GBP:"£", USD:"$", EUR:"€", AUD:"$", CAD:"$", NZD:"$", AED:"AED ", SAR:"SAR ", PKR:"₨", INR:"₹" };
    function sym(){ return CURRENCY_SYMBOL[currencyEl.value || "GBP"] || ""; }
    function n(v){ const x = parseFloat(String(v).replace(/,/g,"")); return Number.isFinite(x) ? x : 0; }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function money(x){ return sym() + (Number.isFinite(x) ? x : 0).toFixed(2); }
    function pct(x){ return (Number.isFinite(x) ? x : 0).toFixed(1) + "%"; }

    function todayKey(){
      const d = new Date();
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth()+1).padStart(2,"0");
      const day = String(d.getUTCDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function daysLeft(trialStartISO){
      const start = new Date(trialStartISO).getTime();
      const elapsedDays = (Date.now() - start) / (1000*60*60*24);
      return Math.max(0, Math.ceil(TRIAL_DAYS - elapsedDays));
    }
    function updateFXLine(sell){
      const r = n(fxRateEl.value);
      if (r > 0 && sell > 0){
        fxRow.style.display = "block";
        fxOut.textContent = (sell * r).toFixed(2);
        fxNote.textContent = `Converted using your rate: ${sell.toFixed(2)} × ${r}`;
      } else fxRow.style.display = "none";
    }

    function csvEscape(s){ const t = String(s ?? ""); return /[",\n]/.test(t) ? `"${t.replaceAll('"','""')}"` : t; }
    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // ---- Presets (examples) ----
    const PRESETS = [
      { id:"manual", name:"Manual (enter fees yourself)", feePct:0, feeFixed:0, adsPct:0, returnPct:0 },
      { id:"ebay_uk_typical", name:"eBay UK (typical example)", feePct:12.8, feeFixed:0.30, adsPct:0, returnPct:3 },
      { id:"etsy_typical", name:"Etsy (typical example)", feePct:9.5, feeFixed:0.20, adsPct:0, returnPct:3 },
      { id:"shopify_card_only", name:"Shopify (card fee example)", feePct:2.0, feeFixed:0.20, adsPct:0, returnPct:2 },
    ];
    PRESETS.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id; opt.textContent = p.name;
      presetSel.appendChild(opt);
    });
    presetSel.value = "manual";
    presetSel.addEventListener("change", ()=>{
      const p = PRESETS.find(x=>x.id===presetSel.value) || PRESETS[0];
      if (p.id !== "manual"){
        feePctEl.value = String(p.feePct ?? 0);
        feeFixedEl.value = String(p.feeFixed ?? 0);
        adsPctEl.value = String(p.adsPct ?? 0);
        returnPctEl.value = String(p.returnPct ?? 0);
      }
      compute();
      refreshInsights();
    });

    function totalFees(sell, feePct, feeFixed, adsPct){
      return sell * (feePct/100) + feeFixed + sell * (adsPct/100);
    }
    function computeRowProfit(sell,cost,ship,misc,feePct,feeFixed,adsPct,returnPct){
      const fees = totalFees(sell, feePct, feeFixed, adsPct);
      const expectedReturnImpact = sell * (returnPct/100);
      const profit = sell - (cost + ship + misc + fees);
      const margin = sell > 0 ? (profit/sell)*100 : 0;
      return { profit, margin, fees, expectedReturnImpact };
    }

    function computeProfit(){
      const sell = n(sellPriceEl.value);
      const cost = n(productCostEl.value);
      const ship = n(shipCostEl.value);
      const misc = n(miscCostEl.value);
      const feePct = clamp(n(feePctEl.value),0,99);
      const feeFixed = clamp(n(feeFixedEl.value),0,999999);
      const adsPct = clamp(n(adsPctEl.value),0,99);
      const returnPct = clamp(n(returnPctEl.value),0,99);

      const r = computeRowProfit(sell,cost,ship,misc,feePct,feeFixed,adsPct,returnPct);

      o1v.textContent = money(r.profit);
      o2v.textContent = pct(r.margin);
      feesOut.textContent = money(r.fees);
      returnOut.textContent = money(r.expectedReturnImpact);

      if (sell<=0){ o1hint.textContent="Enter a selling price."; o2hint.textContent="—"; }
      else if (r.profit<0){ o1hint.textContent="Loss on this pricing."; o2hint.textContent="Adjust price or costs."; }
      else { o1hint.textContent="OK (based on your inputs)."; o2hint.textContent="—"; }

      updateFXLine(sell);
      return { sell, ...r };
    }

    function reverseSellPriceForTargetProfit(target){
      const cost = n(productCostEl.value);
      const ship = n(shipCostEl.value);
      const misc = n(miscCostEl.value);
      const feePct = clamp(n(feePctEl.value),0,99);
      const adsPct = clamp(n(adsPctEl.value),0,99);
      const feeFixed = clamp(n(feeFixedEl.value),0,999999);

      const denom = 1 - ((feePct + adsPct)/100);
      if (denom <= 0.01) return null;
      return (target + cost + ship + misc + feeFixed) / denom;
    }

    function computeReverse(){
      const target = n(targetProfitEl.value);
      if (target<=0){
        o1v.textContent="—"; o2v.textContent="—";
        o1hint.textContent="Enter a target profit.";
        o2hint.textContent="—";
        return;
      }
      const sell = reverseSellPriceForTargetProfit(target);
      if (!sell){
        o1hint.textContent="Reverse calc failed. Check fee % values.";
        o2hint.textContent="—";
        return;
      }
      sellPriceEl.value = sell.toFixed(2);
      computeProfit();

      o1v.textContent = money(sell);
      o1hint.textContent = `Required selling price to target ~${money(target)} profit (estimate).`;
      o2hint.textContent = "Implied margin at that selling price.";
      updateFXLine(sell);
    }

    // Modes
    let MODE = "profit";
    function setMode(m){
      MODE = m;
      tabProfit.classList.toggle("active", m==="profit");
      tabReverse.classList.toggle("active", m==="reverse");
      tabBulk.classList.toggle("active", m==="bulk");

      singleBox.style.display = (m==="bulk") ? "none" : "block";
      bulkBox.style.display = (m==="bulk") ? "block" : "none";
      reverseBox.style.display = (m==="reverse") ? "block" : "none";

      if (m==="profit"){ o1h.textContent="Estimated profit"; o2h.textContent="Margin"; }
      if (m==="reverse"){ o1h.textContent="Required selling price"; o2h.textContent="Implied margin"; }
      compute();
      refreshInsights();
    }
    tabProfit.addEventListener("click", ()=>setMode("profit"));
    tabReverse.addEventListener("click", ()=>setMode("reverse"));
    tabBulk.addEventListener("click", ()=>setMode("bulk"));

    function compute(){
      if (MODE==="profit") return computeProfit();
      if (MODE==="reverse") return computeReverse();
      return computeProfit();
    }

    // ---- Access + profile ----
    let CURRENT_PROFILE = null;
    let CURRENT_USER = null;

    async function ensureProfile(userId){
      const { data: prof, error } = await supabase
        .from("profiles")
        .select("id, trial_start, paid, reverse_uses, bulk_day, bulk_runs_today, comp_uses")
        .eq("id", userId)
        .maybeSingle();
      if (error) throw error;

      const now = new Date().toISOString();
      const base = {
        id:userId,
        trial_start: prof?.trial_start || now,
        paid: !!prof?.paid,
        reverse_uses: prof?.reverse_uses ?? 0,
        bulk_day: prof?.bulk_day ?? null,
        bulk_runs_today: prof?.bulk_runs_today ?? 0,
        comp_uses: prof?.comp_uses ?? 0
      };

      if (!prof){
        const { error: insErr } = await supabase.from("profiles").insert([base]);
        if (insErr) throw insErr;
        return base;
      }

      const patch = {};
      if (!prof.trial_start) patch.trial_start = now;
      if (prof.reverse_uses == null) patch.reverse_uses = 0;
      if (prof.bulk_runs_today == null) patch.bulk_runs_today = 0;
      if (prof.bulk_day == null) patch.bulk_day = null;
      if (prof.comp_uses == null) patch.comp_uses = 0;

      if (Object.keys(patch).length){
        const { error: upErr } = await supabase.from("profiles").update(patch).eq("id", userId);
        if (!upErr) Object.assign(base, patch);
      }
      return base;
    }

    function enableProUI(isPro){
      pdfBtn.disabled = !isPro;
      shareBtn.disabled = !isPro;
      compStatus.textContent = isPro ? "Unlocked" : "Trial limited";
      insStatus.textContent = isPro ? "Unlocked" : "Locked";
      scenarioStatus.textContent = isPro ? "PRO enabled" : "Unlock PRO to save scenarios.";
      if (proCard) proCard.style.display = isPro ? "none" : "block";
    }

    function updateAccessUI(profile){
      CURRENT_PROFILE = profile;

      if (profile.paid){
        accessPill.textContent = "Unlocked (PRO)";
        accessPill.className = "pill ok";
        reverseUsesLine.textContent = "Reverse uses: Unlimited (PRO)";
        compUsesLine.textContent = "Competitor uses: Unlimited (PRO)";
        enableProUI(true);
        refreshBulkLimitLine();
        refreshInsights();
        refreshScenarioDropdown();
        return;
      }

      enableProUI(false);
      reverseUsesLine.textContent = `Reverse uses: ${(profile.reverse_uses ?? 0)}/${TRIAL_REVERSE_LIMIT} (Trial)`;
      compUsesLine.textContent = `Competitor uses: ${(profile.comp_uses ?? 0)}/${TRIAL_COMP_LIMIT} (Trial)`;

      const left = daysLeft(profile.trial_start);
      if (left > 0){
        accessPill.textContent = `Trial active • ${left} day(s) left`;
        accessPill.className = "pill warn";
      } else {
        accessPill.textContent = "Trial ended • PRO required";
        accessPill.className = "pill bad";
      }
      refreshBulkLimitLine();
      refreshInsights();
      refreshScenarioDropdown();
    }

    async function consumeReverseUseIfTrial(){
      if (!CURRENT_USER || !CURRENT_PROFILE) throw new Error("Session missing. Refresh and log in again.");
      if (CURRENT_PROFILE.paid) return;

      const used = Number(CURRENT_PROFILE.reverse_uses || 0);
      if (used >= TRIAL_REVERSE_LIMIT){
        throw new Error(`Trial reverse limit reached (${TRIAL_REVERSE_LIMIT}). Unlock PRO for unlimited.`);
      }
      const next = used + 1;
      const { error } = await supabase.from("profiles").update({ reverse_uses: next }).eq("id", CURRENT_USER.id);
      if (error) throw new Error(error.message || "Could not update reverse uses.");
      CURRENT_PROFILE.reverse_uses = next;
      reverseUsesLine.textContent = `Reverse uses: ${next}/${TRIAL_REVERSE_LIMIT} (Trial)`;
    }

    function refreshBulkLimitLine(){
      if (!CURRENT_PROFILE){ bulkLimitLine.textContent = "Loading bulk limits…"; return; }
      if (CURRENT_PROFILE.paid){ bulkLimitLine.textContent = "PRO: unlimited rows • unlimited runs."; return; }

      const left = daysLeft(CURRENT_PROFILE.trial_start);
      if (left <= 0){ bulkLimitLine.textContent = "Trial ended. Unlock PRO to use Bulk mode."; return; }

      const day = todayKey();
      const usedToday = (CURRENT_PROFILE.bulk_day === day) ? Number(CURRENT_PROFILE.bulk_runs_today || 0) : 0;
      const runsLeft = Math.max(0, TRIAL_BULK_RUNS_PER_DAY - usedToday);
      bulkLimitLine.textContent = `Trial: max ${TRIAL_BULK_MAX_ROWS} rows • ${runsLeft}/${TRIAL_BULK_RUNS_PER_DAY} bulk run(s) left today.`;
    }

    async function consumeBulkRunIfTrial(){
      if (!CURRENT_USER || !CURRENT_PROFILE) throw new Error("Session missing. Refresh and log in again.");
      if (CURRENT_PROFILE.paid) return;

      const left = daysLeft(CURRENT_PROFILE.trial_start);
      if (left <= 0) throw new Error("Trial ended. Unlock PRO to run bulk scans.");

      const day = todayKey();
      let usedToday = 0;
      if (CURRENT_PROFILE.bulk_day === day) usedToday = Number(CURRENT_PROFILE.bulk_runs_today || 0);

      if (usedToday >= TRIAL_BULK_RUNS_PER_DAY){
        throw new Error("Trial bulk limit reached for today. Try again tomorrow or unlock PRO.");
      }

      const next = usedToday + 1;
      const { error } = await supabase.from("profiles").update({ bulk_day: day, bulk_runs_today: next }).eq("id", CURRENT_USER.id);
      if (error) throw new Error("Bulk daily limit storage missing in database. Add bulk_day + bulk_runs_today columns.");
      CURRENT_PROFILE.bulk_day = day;
      CURRENT_PROFILE.bulk_runs_today = next;
      refreshBulkLimitLine();
    }

    async function consumeCompUseIfTrial(){
      if (!CURRENT_USER || !CURRENT_PROFILE) throw new Error("Session missing. Refresh and log in again.");
      if (CURRENT_PROFILE.paid) return;

      const used = Number(CURRENT_PROFILE.comp_uses || 0);
      if (used >= TRIAL_COMP_LIMIT){
        throw new Error(`Trial competitor limit reached (${TRIAL_COMP_LIMIT}). Unlock PRO for unlimited.`);
      }
      const next = used + 1;
      const { error } = await supabase.from("profiles").update({ comp_uses: next }).eq("id", CURRENT_USER.id);
      if (error) throw new Error(error.message || "Could not update competitor uses.");
      CURRENT_PROFILE.comp_uses = next;
      compUsesLine.textContent = `Competitor uses: ${next}/${TRIAL_COMP_LIMIT} (Trial)`;
    }

    // Export / Share
    function payload(){
      return {
        mode: MODE,
        currency: currencyEl.value,
        fxRate: fxRateEl.value || "",
        preset: presetSel.value,
        sellPrice: sellPriceEl.value,
        productCost: productCostEl.value,
        shipCost: shipCostEl.value,
        miscCost: miscCostEl.value,
        feePct: feePctEl.value,
        feeFixed: feeFixedEl.value,
        adsPct: adsPctEl.value,
        returnPct: returnPctEl.value,
        targetProfit: targetProfitEl.value,
        targetMargin: targetMarginInput.value,
        c1: c1.value, c2: c2.value, c3: c3.value,
        positioning: positioning.value,
        floorBuffer: floorBuffer.value
      };
    }

    document.getElementById("exportCsvBtn").addEventListener("click", ()=>{
      const p = payload();
      const rows = Object.entries(p).map(([k,v])=>[k,String(v ?? "")]);
      rows.unshift(["Field","Value"]);
      const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n");
      downloadText("profitpilot-export.csv", csv);
      shareStatus.textContent = "CSV exported.";
    });

    pdfBtn.addEventListener("click", ()=>{
      if (!CURRENT_PROFILE?.paid){ shareStatus.textContent="PDF is PRO."; return; }
      shareStatus.textContent="Preparing PDF…";
      setTimeout(()=>window.print(), 150);
    });

    function base64urlEncode(str){
      const bytes = new TextEncoder().encode(str);
      let bin=""; bytes.forEach(b=>bin+=String.fromCharCode(b));
      return btoa(bin).replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
    }
    shareBtn.addEventListener("click", ()=>{
      if (!CURRENT_PROFILE?.paid){ shareStatus.textContent="Share is PRO."; return; }
      const token = base64urlEncode(JSON.stringify(payload()));
      const url = `${location.origin}/share.html#s=${token}`;
      navigator.clipboard?.writeText(url).catch(()=>{});
      shareStatus.textContent="Share link copied.";
    });

    // Reset
    document.getElementById("resetBtn").addEventListener("click", ()=>{
      [sellPriceEl, productCostEl, shipCostEl, miscCostEl, feePctEl, feeFixedEl, adsPctEl, returnPctEl, targetProfitEl].forEach(el=>el.value="0");
      fxRateEl.value = "";
      presetSel.value = "manual";
      c1.value = c2.value = c3.value = "0";
      positioning.value = "undercut";
      floorBuffer.value = "5";
      shareStatus.textContent = "—";
      bulkPasteEl.value = "";
      clearBulkRows();
      importBanner.style.display = "none";
      targetMarginInput.value = "15";
      setMode("profit");
      refreshInsights();
      compToast.textContent = "—";
      scenarioToast.textContent = "—";
    });

    // ---- INSIGHTS ----
    function solvePriceForMargin(targetMarginPct){
      const C = n(productCostEl.value) + n(shipCostEl.value) + n(miscCostEl.value);
      const pctFees = (clamp(n(feePctEl.value),0,99) + clamp(n(adsPctEl.value),0,99))/100;
      const fixed = clamp(n(feeFixedEl.value),0,999999);
      const m = clamp(targetMarginPct/100, -0.99, 0.95);
      const denom = (1 - pctFees) - m;
      if (denom <= 0.01) return null;
      return (C + fixed) / denom;
    }
    function solveBreakEvenPrice(){
      const C = n(productCostEl.value) + n(shipCostEl.value) + n(miscCostEl.value);
      const pctFees = (clamp(n(feePctEl.value),0,99) + clamp(n(adsPctEl.value),0,99))/100;
      const fixed = clamp(n(feeFixedEl.value),0,999999);
      const denom = 1 - pctFees;
      if (denom <= 0.01) return null;
      return (C + fixed) / denom;
    }
    function maxAffordableAdsPct(){
      const sell = n(sellPriceEl.value);
      if (sell <= 0) return null;
      const C = n(productCostEl.value) + n(shipCostEl.value) + n(miscCostEl.value);
      const feePct = clamp(n(feePctEl.value),0,99);
      const feeFixed = clamp(n(feeFixedEl.value),0,999999);
      const room = sell - (C + sell*(feePct/100) + feeFixed);
      const max = (room / sell) * 100;
      return clamp(max, 0, 99);
    }
    function riskAssessment(profit, margin, returnImpact, fees){
      const bullets = [];
      let label = "Balanced";
      let explain = "Looks workable based on your inputs.";
      if (profit < 0){
        label = "High risk"; explain = "Pricing below cost + fees.";
        bullets.push("You are losing money on this price. Raise price or reduce costs/fees.");
      } else if (margin < 5){
        label = "Thin margin"; explain = "Small shocks can wipe profit.";
        bullets.push("Margin is very thin. Any fee change, discount, or return can flip to loss.");
      } else if (margin < 10){
        label = "Tight"; explain = "Okay, but sensitive.";
        bullets.push("Margin is tight. Consider a minimum margin target (10–20%).");
      } else {
        bullets.push("Margin seems reasonable for many categories (still depends on your business).");
      }
      if (fees > Math.max(0, profit) * 2) bullets.push("Fees + ads consume a large share of profit. Watch promo spend.");
      if (returnImpact > Math.max(0, profit) * 0.7) bullets.push("Return sensitivity is high relative to profit. Consider buffer pricing or better QC.");
      return { label, explain, bullets };
    }

    function refreshInsights(){
      const isPro = !!CURRENT_PROFILE?.paid;
      const sell = n(sellPriceEl.value);
      const C = n(productCostEl.value) + n(shipCostEl.value) + n(miscCostEl.value);
      const feePct = clamp(n(feePctEl.value),0,99);
      const feeFixed = clamp(n(feeFixedEl.value),0,999999);
      const adsPct = clamp(n(adsPctEl.value),0,99);
      const retPct = clamp(n(returnPctEl.value),0,99);

      const fees = totalFees(sell, feePct, feeFixed, adsPct);
      const retImpact = sell * (retPct/100);
      const profit = sell - (C + fees);
      const margin = sell > 0 ? (profit/sell)*100 : 0;

      const targetM = clamp(n(targetMarginInput.value), 0, 80);
      targetMarginVal.textContent = targetM.toFixed(0) + "%";

      if (!isPro){
        bePriceEl.textContent = "—";
        targetMarginPriceEl.textContent = "—";
        maxAdsPctEl.textContent = "—";
        riskLabelEl.textContent = "Locked";
        riskExplainEl.textContent = "Unlock PRO to see insights.";
        insBullets.innerHTML = `
          <li>Break-even price</li>
          <li>Price to hit a target margin</li>
          <li>Max ads % you can afford</li>
          <li>Risk signals</li>
        `;
        insStatus.textContent = "Locked";
        insToast.textContent = "—";
        return;
      }

      insStatus.textContent = "Unlocked";

      const be = solveBreakEvenPrice();
      bePriceEl.textContent = (be && Number.isFinite(be)) ? money(be) : "—";

      const tm = solvePriceForMargin(targetM);
      targetMarginPriceEl.textContent = (tm && Number.isFinite(tm)) ? money(tm) : "—";

      const maxAds = maxAffordableAdsPct();
      maxAdsPctEl.textContent = (maxAds==null) ? "—" : maxAds.toFixed(1) + "%";

      const ra = riskAssessment(profit, margin, retImpact, fees);
      riskLabelEl.textContent = ra.label;
      riskExplainEl.textContent = ra.explain;

      const bullets = [];
      if (sell <= 0) bullets.push("Enter a selling price to get meaningful insights.");
      else {
        bullets.push(`Break-even is ~${(be && Number.isFinite(be)) ? money(be) : "—"} (profit ≈ 0).`);
        bullets.push(`To target ${targetM.toFixed(0)}% margin, price is ~${(tm && Number.isFinite(tm)) ? money(tm) : "—"}.`);
        if (maxAds != null) bullets.push(`Max ads spend before loss: ~${maxAds.toFixed(1)}% (at current price/cost).`);
        bullets.push(...ra.bullets);
      }
      insBullets.innerHTML = bullets.map(x=>`<li>${x}</li>`).join("");
      insToast.textContent = "Updated.";
    }

    refreshInsightsBtn.addEventListener("click", ()=>{ refreshInsights(); insToast.textContent="Updated."; });
    targetMarginInput.addEventListener("input", ()=>refreshInsights());

    // ---- COMPETITOR MODE + APPLY/SAVE ----
    let LAST_COMP_SUGGEST = null; // number
    function median3(a,b,c){
      const arr=[a,b,c].filter(x=>x>0).sort((x,y)=>x-y);
      if (!arr.length) return null;
      const mid = Math.floor(arr.length/2);
      return arr[mid];
    }

    function runCompetitor(){
      const p1 = n(c1.value), p2 = n(c2.value), p3 = n(c3.value);
      const med = median3(p1,p2,p3);
      if (!med) throw new Error("Enter at least 1 competitor price > 0.");

      const be = solveBreakEvenPrice();
      const buffer = clamp(n(floorBuffer.value), 0, 80);
      const floor = (be && Number.isFinite(be)) ? (be * (1 + buffer/100)) : null;

      const pos = positioning.value;
      let suggested = med;
      let why = "Based on median of competitor inputs.";

      if (pos === "undercut"){
        suggested = med * 0.99;
        why = "Undercut slightly (~1%) to win clicks without racing to the bottom.";
      } else if (pos === "match"){
        suggested = med;
        why = "Match the market median for a balanced approach.";
      } else {
        suggested = med * 1.03;
        why = "Premium (~3%) only if your offer is clearly better (speed, bundle, trust).";
      }

      LAST_COMP_SUGGEST = suggested;
      useSuggestedBtn.disabled = false;

      compMedian.textContent = money(med);
      compSuggest.textContent = money(suggested);
      compWhy.textContent = why;
      compFloor.textContent = floor ? money(floor) : "—";

      if (floor && suggested < floor){
        compCheck.textContent = "Warning";
        compCheck.className = "bad";
        compCheck2.textContent = "Competitor market is below your safe floor. Reduce costs/fees or avoid this listing.";
      } else {
        compCheck.textContent = "Looks viable";
        compCheck.className = "good";
        compCheck2.textContent = "Suggested price stays above the safe floor (based on your inputs).";
      }

      const bullets = [];
      if (floor) bullets.push(`Floor price = break-even + ${buffer.toFixed(0)}% buffer → ${money(floor)}.`);
      bullets.push("If competitors are below your floor: don’t chase them. Fix costs or pick another product.");
      bullets.push("No scraping: you manually enter prices you found yourself.");
      compBullets.innerHTML = bullets.map(x=>`<li>${x}</li>`).join("");
    }

    runCompBtn.addEventListener("click", async ()=>{
      compToast.textContent = "Running…";
      try{
        if (!CURRENT_PROFILE) throw new Error("Loading… try again in 2 seconds.");
        if (!CURRENT_PROFILE.paid){
          const left = daysLeft(CURRENT_PROFILE.trial_start);
          if (left <= 0) throw new Error("Trial ended. Unlock PRO to use competitor mode.");
          await consumeCompUseIfTrial();
        }
        computeProfit();
        refreshInsights();
        runCompetitor();
        compStatus.textContent = CURRENT_PROFILE.paid ? "Unlocked" : "Trial limited";
        compToast.textContent = "Done.";
        scenarioToast.textContent = "Tip: click “Use suggested price” to apply.";
      } catch(e){
        compToast.textContent = e.message || "Failed.";
      }
    });

    useSuggestedBtn.addEventListener("click", ()=>{
      if (!LAST_COMP_SUGGEST || !Number.isFinite(LAST_COMP_SUGGEST)){
        scenarioToast.textContent = "Run competitor mode first.";
        return;
      }
      sellPriceEl.value = LAST_COMP_SUGGEST.toFixed(2);
      setMode("profit");
      computeProfit();
      refreshInsights();
      scenarioToast.textContent = "Applied suggested price to Selling price ✅";
    });

    // ---- Scenario storage (PRO) — stored locally for speed ----
    function scenarioKey(){ return `pp_scenarios_${CURRENT_USER?.id || "anon"}`; }
    function loadScenarios(){
      try{
        const raw = localStorage.getItem(scenarioKey());
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }
    function saveScenarios(arr){
      localStorage.setItem(scenarioKey(), JSON.stringify(arr));
    }
    function refreshScenarioDropdown(){
      scenarioSel.innerHTML = `<option value="">—</option>`;
      if (!CURRENT_USER) return;
      const arr = loadScenarios();
      arr.forEach((s, idx)=>{
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = s.name || `Scenario #${idx+1}`;
        scenarioSel.appendChild(opt);
      });
      scenarioStatus.textContent = CURRENT_PROFILE?.paid ? `${arr.length} saved` : "PRO required to save";
    }

    function currentScenarioPayload(){
      return {
        name: scenarioName.value.trim() || "",
        created_at: new Date().toISOString(),
        suggested_price: (LAST_COMP_SUGGEST && Number.isFinite(LAST_COMP_SUGGEST)) ? Number(LAST_COMP_SUGGEST.toFixed(2)) : null,
        data: payload()
      };
    }

    function doSaveScenario(){
      if (!CURRENT_PROFILE?.paid){
        scenarioToast.textContent = "Saving scenarios is PRO.";
        scenarioStatus.textContent = "Unlock PRO to save.";
        return;
      }
      const name = scenarioName.value.trim();
      if (!name){
        scenarioToast.textContent = "Write a scenario name first.";
        return;
      }
      const arr = loadScenarios();
      if (arr.length >= 50) arr.shift();
      arr.push(currentScenarioPayload());
      saveScenarios(arr);
      refreshScenarioDropdown();
      scenarioToast.textContent = "Scenario saved ✅";
      scenarioStatus.textContent = "Saved.";
    }

    saveScenarioBtn.addEventListener("click", doSaveScenario);
    saveScenarioBtn2.addEventListener("click", doSaveScenario);

    loadScenarioBtn.addEventListener("click", ()=>{
      const idx = Number(scenarioSel.value);
      const arr = loadScenarios();
      const s = arr[idx];
      if (!s){ scenarioStatus.textContent = "Choose a scenario."; return; }
      const d = s.data || {};
      if (d.currency) currencyEl.value = d.currency;
      fxRateEl.value = d.fxRate || "";
      presetSel.value = d.preset || "manual";
      sellPriceEl.value = String(d.sellPrice ?? "0");
      productCostEl.value = String(d.productCost ?? "0");
      shipCostEl.value = String(d.shipCost ?? "0");
      miscCostEl.value = String(d.miscCost ?? "0");
      feePctEl.value = String(d.feePct ?? "0");
      feeFixedEl.value = String(d.feeFixed ?? "0");
      adsPctEl.value = String(d.adsPct ?? "0");
      returnPctEl.value = String(d.returnPct ?? "0");
      targetProfitEl.value = String(d.targetProfit ?? "0");
      targetMarginInput.value = String(d.targetMargin ?? "15");
      c1.value = String(d.c1 ?? "0"); c2.value = String(d.c2 ?? "0"); c3.value = String(d.c3 ?? "0");
      positioning.value = String(d.positioning ?? "undercut");
      floorBuffer.value = String(d.floorBuffer ?? "5");
      LAST_COMP_SUGGEST = (s.suggested_price != null) ? Number(s.suggested_price) : null;
      useSuggestedBtn.disabled = !(LAST_COMP_SUGGEST && Number.isFinite(LAST_COMP_SUGGEST));
      setMode(d.mode || "profit");
      computeProfit();
      refreshInsights();
      scenarioStatus.textContent = "Loaded ✅";
      scenarioToast.textContent = "Scenario loaded.";
    });

    deleteScenarioBtn.addEventListener("click", ()=>{
      const idx = Number(scenarioSel.value);
      const arr = loadScenarios();
      if (!arr[idx]){ scenarioStatus.textContent="Choose a scenario."; return; }
      arr.splice(idx,1);
      saveScenarios(arr);
      refreshScenarioDropdown();
      scenarioStatus.textContent="Deleted.";
      scenarioToast.textContent="Scenario deleted.";
    });

    // ---- BULK ----
    let bulkLastRows = [];
    function mkCellInput(value="0"){
      const inp = document.createElement("input");
      inp.className = "mini";
      inp.inputMode = "decimal";
      inp.value = String(value ?? "0");
      return inp;
    }
    function renumberBulkRows(){ [...bulkTbody.children].forEach((tr,i)=> tr.children[0].textContent = String(i+1)); }
    function rowCount(){ return bulkTbody.children.length; }
    function canAddRow(){
      if (!CURRENT_PROFILE) return false;
      if (CURRENT_PROFILE.paid) return true;
      return rowCount() < TRIAL_BULK_MAX_ROWS;
    }
    function addBulkRow(initial={}){
      const tr = document.createElement("tr");
      const idxTd = document.createElement("td");
      idxTd.textContent = String(rowCount() + 1);
      tr.appendChild(idxTd);

      const sell = mkCellInput(initial.sell ?? "0");
      const cost = mkCellInput(initial.cost ?? "0");
      const ship = mkCellInput(initial.ship ?? "0");
      const misc = mkCellInput(initial.misc ?? "0");
      const feePct = mkCellInput(initial.feePct ?? feePctEl.value);
      const feeFixed = mkCellInput(initial.feeFixed ?? feeFixedEl.value);
      const adsPct = mkCellInput(initial.adsPct ?? adsPctEl.value);
      const retPct = mkCellInput(initial.returnPct ?? returnPctEl.value);

      [sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct].forEach(inp=>{
        const td = document.createElement("td");
        td.appendChild(inp);
        tr.appendChild(td);
        inp.addEventListener("input", ()=> previewRow(tr));
      });

      const profitTd = document.createElement("td"); profitTd.textContent = "—"; tr.appendChild(profitTd);
      const marginTd = document.createElement("td"); marginTd.textContent = "—"; tr.appendChild(marginTd);

      const actTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.className = "btn";
      delBtn.type = "button";
      delBtn.textContent = "Remove";
      delBtn.onclick = ()=>{
        tr.remove();
        renumberBulkRows();
        bulkStatus.textContent = "Row removed.";
        refreshBulkLimitLine();
      };
      actTd.appendChild(delBtn);
      tr.appendChild(actTd);

      tr._pp = { sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct, profitTd, marginTd };
      bulkTbody.appendChild(tr);
      renumberBulkRows();
      previewRow(tr);
    }
    function clearBulkRows(){
      bulkTbody.innerHTML = "";
      bulkLastRows = [];
      bulkStatus.textContent = "—";
      refreshBulkLimitLine();
    }
    function applyFeesToAll(){
      [...bulkTbody.children].forEach(tr=>{
        const r = tr._pp;
        r.feePct.value = feePctEl.value;
        r.feeFixed.value = feeFixedEl.value;
        r.adsPct.value = adsPctEl.value;
        r.retPct.value = returnPctEl.value;
        previewRow(tr);
      });
      bulkStatus.textContent = "Applied current fees to all rows.";
    }
    function computeRow(sell,cost,ship,misc,feePct,feeFixed,adsPct,returnPct){
      const fees = sell*(feePct/100) + feeFixed + sell*(adsPct/100);
      const profit = sell - (cost+ship+misc+fees);
      const margin = sell>0 ? (profit/sell)*100 : 0;
      return { profit, margin, fees };
    }
    function previewRow(tr){
      if (!tr?._pp) return;
      const r = tr._pp;
      const sell = n(r.sell.value);
      const cost = n(r.cost.value);
      const ship = n(r.ship.value);
      const misc = n(r.misc.value);
      const feePct = clamp(n(r.feePct.value),0,99);
      const feeFixed = clamp(n(r.feeFixed.value),0,999999);
      const adsPct = clamp(n(r.adsPct.value),0,99);
      const retPct = clamp(n(r.retPct.value),0,99);

      const res = computeRow(sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct);
      r.profitTd.textContent = money(res.profit);
      r.profitTd.className = res.profit >= 0 ? "good" : "bad";
      r.marginTd.textContent = pct(res.margin);
      r.marginTd.className = res.margin >= 10 ? "good" : (res.margin < 0 ? "bad" : "");
    }

    bulkAddRowBtn.addEventListener("click", ()=>{
      if (!CURRENT_PROFILE){ bulkStatus.textContent="Loading…"; return; }
      if (!canAddRow()){
        bulkStatus.textContent = `Trial limit: max ${TRIAL_BULK_MAX_ROWS} rows. Unlock PRO for unlimited.`;
        return;
      }
      addBulkRow();
      bulkStatus.textContent = "Row added.";
      refreshBulkLimitLine();
    });

    bulkClearBtn.addEventListener("click", ()=>{
      clearBulkRows();
      const initial = CURRENT_PROFILE?.paid ? 5 : TRIAL_BULK_MAX_ROWS;
      for (let i=0;i<initial;i++) addBulkRow();
      bulkStatus.textContent = "Reset rows.";
    });

    bulkApplyFeesBtn.addEventListener("click", ()=>applyFeesToAll());

    bulkRunBtn.addEventListener("click", async ()=>{
      try{
        if (!CURRENT_PROFILE){ bulkStatus.textContent="Loading…"; return; }

        if (!CURRENT_PROFILE.paid){
          const left = daysLeft(CURRENT_PROFILE.trial_start);
          if (left <= 0) throw new Error("Trial ended. Unlock PRO to use Bulk mode.");
          if (rowCount() > TRIAL_BULK_MAX_ROWS) throw new Error(`Trial allows max ${TRIAL_BULK_MAX_ROWS} rows.`);
          await consumeBulkRunIfTrial();
        }

        const trs = [...bulkTbody.children];
        if (!trs.length) throw new Error("Add at least 1 row.");

        const out = [];
        trs.forEach(tr=>{
          const r = tr._pp;
          const sell = n(r.sell.value);
          const cost = n(r.cost.value);
          const ship = n(r.ship.value);
          const misc = n(r.misc.value);
          const feePct = clamp(n(r.feePct.value),0,99);
          const feeFixed = clamp(n(r.feeFixed.value),0,999999);
          const adsPct = clamp(n(r.adsPct.value),0,99);
          const retPct = clamp(n(r.retPct.value),0,99);

          const res = computeRow(sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct);
          r.profitTd.textContent = money(res.profit);
          r.profitTd.className = res.profit >= 0 ? "good" : "bad";
          r.marginTd.textContent = pct(res.margin);
          r.marginTd.className = res.margin >= 10 ? "good" : (res.margin < 0 ? "bad" : "");

          out.push({ sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct, fees:res.fees, profit:res.profit, margin:res.margin });
        });

        bulkLastRows = out;
        bulkStatus.textContent = `Processed ${out.length} row(s).`;
        refreshBulkLimitLine();
      } catch(e){
        bulkStatus.textContent = e.message || "Bulk failed.";
        refreshBulkLimitLine();
      }
    });

    bulkExportBtn.addEventListener("click", ()=>{
      if (!bulkLastRows.length){ bulkStatus.textContent = "Run bulk first."; return; }
      const rows = [["sell","cost","ship","misc","feePct","feeFixed","adsPct","returnPct","fees","profit","margin"]];
      bulkLastRows.forEach(r=> rows.push([r.sell,r.cost,r.ship,r.misc,r.feePct,r.feeFixed,r.adsPct,r.returnPct,r.fees,r.profit,r.margin]));
      const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n");
      downloadText("profitpilot-bulk.csv", csv);
      bulkStatus.textContent = "Bulk CSV exported.";
    });

    function parseLines(text){
      const lines = text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      const rows = [];
      for (const line of lines){
        const parts = line.includes("\t") ? line.split("\t") : line.split(",");
        const p = parts.map(x=>x.trim()).filter(x=>x.length>0);
        if (p.length < 2) continue;
        rows.push({
          sell: p[0] ?? "0",
          cost: p[1] ?? "0",
          ship: p[2] ?? "0",
          misc: p[3] ?? "0",
          feePct: p[4] ?? feePctEl.value,
          feeFixed: p[5] ?? feeFixedEl.value,
          adsPct: p[6] ?? adsPctEl.value,
          returnPct: p[7] ?? returnPctEl.value
        });
      }
      return rows;
    }

    bulkFillExampleBtn.addEventListener("click", ()=>{
      bulkPasteEl.value = "12.99, 6.20, 0.00, 0.20\n19.99, 9.50, 0.00, 0.30\n29.99, 14.00, 0.00, 0.50";
      bulkImportStatus.textContent = "Example filled.";
    });

    bulkImportBtn.addEventListener("click", ()=>{
      bulkImportStatus.textContent = "Importing…";
      const rows = parseLines(bulkPasteEl.value || "");
      if (!rows.length){ bulkImportStatus.textContent = "Nothing to import."; return; }
      const allowed = (CURRENT_PROFILE?.paid) ? rows.length : Math.min(rows.length, TRIAL_BULK_MAX_ROWS);
      clearBulkRows();
      for (let i=0;i<allowed;i++) addBulkRow(rows[i]);
      bulkImportStatus.textContent = (!CURRENT_PROFILE?.paid && rows.length > allowed)
        ? `Imported ${allowed}. Trial limit is ${TRIAL_BULK_MAX_ROWS} rows.`
        : `Imported ${allowed} row(s).`;
      bulkStatus.textContent = "Review values, then Run bulk.";
      refreshBulkLimitLine();
    });

    // Reviews
    let selectedStars = 5;
    const starsRow = document.getElementById("starsRow");
    const reviewStatus = document.getElementById("reviewStatus");
    function setStars(nv){
      selectedStars = nv;
      [...starsRow.querySelectorAll("button")].forEach(b=>{
        b.style.borderColor = (parseInt(b.dataset.star,10)===nv) ? "rgba(14,165,164,.45)" : "rgba(16,24,40,.10)";
        b.style.background = (parseInt(b.dataset.star,10)===nv) ? "rgba(14,165,164,.10)" : "rgba(255,255,255,.80)";
      });
    }
    setStars(5);
    starsRow.addEventListener("click",(e)=>{
      const btn=e.target.closest("button"); if(!btn) return;
      setStars(parseInt(btn.dataset.star,10));
    });

    document.getElementById("sendReview").addEventListener("click", async ()=>{
      reviewStatus.textContent="Submitting…";
      try{
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("Please log in again.");
        const name = document.getElementById("revName").value.trim();
        const category = document.getElementById("revCat").value;
        const message = document.getElementById("revMsg").value.trim();
        if (!message) throw new Error("Write a short review message.");
        const { error } = await supabase.from("reviews").insert([{
          user_id:user.id, name:name||null, rating:selectedStars, category, message, approved:true
        }]);
        if (error) throw error;
        reviewStatus.textContent="Thanks! Your review is public.";
        document.getElementById("revMsg").value="";
      } catch(e){
        reviewStatus.textContent=e.message||"Failed.";
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async ()=>{
      await supabase.auth.signOut();
      location.href = "login.html";
    });

    // Share import hash (optional)
    function base64urlDecodeToString(b64url){
      let s = (b64url||"").replace(/-/g, "+").replace(/_/g, "/");
      while (s.length % 4) s += "=";
      const bin = atob(s);
      const bytes = new Uint8Array([...bin].map(ch => ch.charCodeAt(0)));
      return new TextDecoder().decode(bytes);
    }

    function tryImportFromHash(){
      const h = location.hash || "";
      const m = h.match(/[#&](?:s|import)=([^&]+)/);
      if (!m) return;
      try{
        const token = decodeURIComponent(m[1]);
        const jsonStr = base64urlDecodeToString(token);
        const data = JSON.parse(jsonStr);
        if (data.currency) currencyEl.value = data.currency;
        fxRateEl.value = data.fxRate || "";
        presetSel.value = data.preset || "manual";
        sellPriceEl.value = String(data.sellPrice ?? "0");
        productCostEl.value = String(data.productCost ?? "0");
        shipCostEl.value = String(data.shipCost ?? "0");
        miscCostEl.value = String(data.miscCost ?? "0");
        feePctEl.value = String(data.feePct ?? "0");
        feeFixedEl.value = String(data.feeFixed ?? "0");
        adsPctEl.value = String(data.adsPct ?? "0");
        returnPctEl.value = String(data.returnPct ?? "0");
        targetProfitEl.value = String(data.targetProfit ?? "0");
        targetMarginInput.value = String(data.targetMargin ?? "15");
        c1.value = String(data.c1 ?? "0"); c2.value = String(data.c2 ?? "0"); c3.value = String(data.c3 ?? "0");
        positioning.value = String(data.positioning ?? "undercut");
        floorBuffer.value = String(data.floorBuffer ?? "5");
        importBanner.style.display = "block";
        importBanner.textContent = "Imported shared calculation ✅";
        setTimeout(()=>{ importBanner.style.display = "none"; }, 5000);
      } catch(e){
        importBanner.style.display = "block";
        importBanner.textContent = "Import failed (invalid link).";
        setTimeout(()=>{ importBanner.style.display = "none"; }, 7000);
      }
      history.replaceState(null, "", location.pathname);
    }

    [sellPriceEl, productCostEl, shipCostEl, miscCostEl, feePctEl, feeFixedEl, adsPctEl, returnPctEl, fxRateEl, currencyEl]
      .forEach(el=> el.addEventListener("input", ()=>{ computeProfit(); refreshInsights(); }));

    async function computeReverseWithLimit(){
      await consumeReverseUseIfTrial();
      computeReverse();
      refreshInsights();
    }

    document.getElementById("calcBtn").addEventListener("click", async ()=>{
      try{
        o1hint.style.color = "";
        if (MODE==="reverse") await computeReverseWithLimit();
        else { computeProfit(); refreshInsights(); }
      } catch(e){
        o1hint.textContent = e.message || "Error.";
        o1hint.style.color = "var(--bad)";
      }
    });

    // ---------- First-time guided tour ----------
    const TOUR_KEY = "pp_tour_done_v1";
    const tourOverlay = document.getElementById("tourOverlay");
    const tourStepPill = document.getElementById("tourStepPill");
    const tourTitle = document.getElementById("tourTitle");
    const tourBody = document.getElementById("tourBody");
    const tourHint = document.getElementById("tourHint");
    const tourBackBtn = document.getElementById("tourBackBtn");
    const tourNextBtn = document.getElementById("tourNextBtn");
    const tourSkipBtn = document.getElementById("tourSkipBtn");

    const TOUR_STEPS = [
      { title:"Welcome to ProfitPilot", body:"This is your workspace. You can do profit, reverse pricing, and bulk checks.", hint:"You’re seeing this once only.", targetId:"tabProfit" },
      { title:"Modes (Profit / Reverse / Bulk)", body:"Use tabs to switch modes. Profit = normal. Reverse = target profit → selling price. Bulk = table for many items.", hint:"Try Bulk when you’re checking multiple products quickly.", targetId:"tabReverse" },
      { title:"Profit Calculator inputs", body:"Enter selling price, product cost, shipping, fees and returns. Outputs update based on your inputs.", hint:"Presets are examples — adjust for your real fees.", targetId:"sellPrice" },
      { title:"Reverse mode (trial limited)", body:"Reverse calculates the selling price you need to reach a target profit. Trial is limited, PRO is unlimited.", hint:"If your reverse price is above market → product may not be viable.", targetId:"targetProfit" },
      { title:"Bulk table", body:"Bulk mode lets you paste rows or enter in the table. Then run bulk to get profit/margin per row.", hint:"Export Bulk CSV for records and comparisons.", targetId:"bulkTable" },
      { title:"Insights + Export + Reviews", body:"Insights help decision-making (PRO). Export and Share are for PRO. Reviews help trust — submit once logged in.", hint:"You can always find Help from the navigation.", targetId:"insightsBox" }
    ];
    let tourIndex = 0;

    function scrollToTarget(id){
      const el = document.getElementById(id);
      if (!el) return;
      el.scrollIntoView({ behavior:"smooth", block:"center" });
      el.style.boxShadow = "0 0 0 4px rgba(14,165,164,.15)";
      el.style.transition = "box-shadow .25s ease";
      setTimeout(()=>{ el.style.boxShadow=""; }, 1200);
    }

    function renderTour(){
      const step = TOUR_STEPS[tourIndex];
      tourStepPill.textContent = `Step ${tourIndex+1}/${TOUR_STEPS.length}`;
      tourTitle.textContent = step.title;
      tourBody.textContent = step.body;
      tourHint.textContent = step.hint;

      tourBackBtn.style.display = tourIndex === 0 ? "none" : "inline-flex";
      tourNextBtn.textContent = tourIndex === TOUR_STEPS.length - 1 ? "Finish" : "Next";

      if (step.targetId === "bulkTable") setMode("bulk");
      if (step.targetId === "targetProfit") setMode("reverse");
      if (step.targetId === "sellPrice" || step.targetId === "tabProfit") setMode("profit");

      setTimeout(()=>scrollToTarget(step.targetId), 250);
    }

    function startTour(){
      if (!tourOverlay) return;
      tourOverlay.style.display = "block";
      tourIndex = 0;
      renderTour();
    }

    function finishTour(){
      localStorage.setItem(TOUR_KEY, "1");
      if (tourOverlay) tourOverlay.style.display = "none";
    }

    tourSkipBtn?.addEventListener("click", finishTour);
    tourBackBtn?.addEventListener("click", ()=>{
      tourIndex = Math.max(0, tourIndex - 1);
      renderTour();
    });
    tourNextBtn?.addEventListener("click", ()=>{
      if (tourIndex >= TOUR_STEPS.length - 1) return finishTour();
      tourIndex += 1;
      renderTour();
    });

    function maybeStartTour(){
      if (localStorage.getItem(TOUR_KEY)) return;
      startTour();
    }

    // Boot
    (async ()=>{
      try{
        accessPill.textContent="Checking session…";
        const { data: { session } } = await supabase.auth.getSession();
        if (!session){ location.href="login.html"; return; }

        const { data: { user } } = await supabase.auth.getUser();
        if (!user){ location.href="login.html"; return; }
        CURRENT_USER = user;

        const profile = await ensureProfile(user.id);
        updateAccessUI(profile);

        // bulk initial rows
        clearBulkRows();
        const initialRows = profile.paid ? 5 : TRIAL_BULK_MAX_ROWS;
        for (let i=0;i<initialRows;i++) addBulkRow();

        setMode("profit");
        computeProfit();
        refreshInsights();
        refreshScenarioDropdown();
        useSuggestedBtn.disabled = true;

        tryImportFromHash();
        maybeStartTour();

        document.getElementById("calcBtn").disabled = false;
      } catch(e){
        accessPill.textContent="Access check failed";
        accessPill.className="pill bad";
      }
    })();
  </script>
</body>
</html>
