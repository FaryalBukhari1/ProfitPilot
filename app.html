<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>

  <!-- Google Analytics (GA4) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-F12747YWBN"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-F12747YWBN', { anonymize_ip: true });
  </script>

  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ProfitPilot — App</title>
  <meta name="description" content="ProfitPilot: profit calculator with reverse pricing, bulk table, insights, competitor mode, export, share and saved presets.">
  <link rel="icon" href="https://ukwebtools.com/favicon.svg" type="image/svg+xml">

  <style>
    :root{
      --bg:#f6f8fb; --bg2:#eef2ff; --txt:#0b1220; --muted:#5b6474;
      --card:rgba(255,255,255,.90); --line:rgba(16,24,40,.10);
      --accent:#0ea5a4; --accent2:#4f46e5; --shadow:0 10px 30px rgba(16,24,40,.08);
      --warn:#f59e0b; --bad:#ef4444; --ok:#0ea5a4;

      --f-bg:#0b0f14;
      --f-line:rgba(255,255,255,.10);
      --f-txt:rgba(255,255,255,.92);
      --f-muted:rgba(255,255,255,.68);
    }

    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(14,165,164,.16), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(79,70,229,.12), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg));
    }
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    :focus-visible{outline:3px solid rgba(79,70,229,.55);outline-offset:3px;border-radius:12px}

    .skip{
      position:absolute;left:-9999px;top:10px;
      background:#fff;border:1px solid rgba(16,24,40,.14);
      padding:10px 12px;border-radius:12px;
      box-shadow:0 12px 24px rgba(16,24,40,.10);
      z-index:1000;
    }
    .skip:focus{left:12px}

    .pp-wrap{max-width:1200px;margin:0 auto;padding:0 16px}
    .pp-header{position:sticky; top:10px; z-index:100; margin:14px auto 0}
    .pp-headerbar{
      background:rgba(255,255,255,.78);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      backdrop-filter:blur(10px);
      padding:10px;
    }
    .pp-row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:nowrap}
    .pp-brand{display:flex;gap:10px;align-items:center;min-width:220px}
    .pp-logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg, rgba(14,165,164,.18), rgba(79,70,229,.14));
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      font-weight:1000;color:var(--txt);
      user-select:none;
    }
    .pp-title{font-weight:1000;line-height:1.05}
    .pp-sub{font-size:12px;color:var(--muted);font-weight:750;margin-top:3px}
    @media(max-width:760px){.pp-sub{display:none}.pp-brand{min-width:auto}}

    .pp-nav{
      display:flex;gap:10px;align-items:center;justify-content:flex-end;
      flex:1 1 auto;
      overflow-x:auto;-webkit-overflow-scrolling:touch;
      padding:2px 4px;
      scrollbar-width:thin;
    }

    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.76);font-size:12px;color:var(--muted);
      display:inline-flex;gap:8px;align-items:center;white-space:nowrap
    }
    .pill.ok{border-color:rgba(14,165,164,.30);background:rgba(14,165,164,.10);color:var(--txt)}
    .pill.warn{border-color:rgba(245,158,11,.30);background:rgba(245,158,11,.10);color:var(--txt)}
    .pill.bad{border-color:rgba(239,68,68,.30);background:rgba(239,68,68,.10);color:var(--txt)}

    .btn{
      padding:10px 14px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.80);color:var(--txt);
      display:inline-flex;gap:8px;align-items:center;cursor:pointer;
      box-shadow:0 4px 16px rgba(16,24,40,.06);user-select:none;
      white-space:nowrap;
      text-decoration:none;
    }
    .btn.primary{border-color:rgba(14,165,164,.30);background:rgba(14,165,164,.10)}
    .btn.ghost{background:transparent;box-shadow:none}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .wrap{max-width:1100px;margin:0 auto;padding:18px 16px 40px}
    @media (min-width:900px){.wrap{ padding:20px 22px 44px; }}

   .grid{
  display:flex;
  flex-direction:column;
  gap:18px;
  margin-top:18px;
}

.wrap{
  max-width:980px;
  margin:0 auto;
  padding:20px 18px 50px;
}

.card{
  border-radius:22px;
  padding:22px;
}
    
#calcCard{
  background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
  border:1px solid rgba(14,165,164,.22);
}

.title{
  font-size:18px;
}

.k .v{
  font-size:22px;
}


    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:20px;
      padding:18px;
      box-shadow:var(--shadow);
    }

    .title{font-weight:900;margin:0 0 10px}
    .small{font-size:12px;color:var(--muted);line-height:1.75}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media(max-width:560px){.kpi{grid-template-columns:1fr}}
    .k{border:1px solid var(--line);background:rgba(255,255,255,.76);border-radius:18px;padding:14px}
    .k .h{font-size:12px;color:var(--muted)}
    .k .v{font-size:20px;font-weight:900;margin-top:6px}
    .hint{font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.76);cursor:pointer;font-size:12px;user-select:none}
    .tab.active{border-color:rgba(14,165,164,.35);background:rgba(14,165,164,.10);font-weight:900}
    .toast{margin-top:10px;font-size:12px;color:var(--muted)}
    .good{color:var(--ok);font-weight:900}
    .bad{color:var(--bad);font-weight:900}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:560px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.94);color:var(--txt);outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:rgba(14,165,164,.35)}

    .banner{
      display:none;margin-top:12px;border:1px solid rgba(14,165,164,.28);
      background:rgba(14,165,164,.10);border-radius:16px;padding:10px 12px;
      color:var(--txt);font-size:12px;line-height:1.5;
    }

    .bulkWrap{overflow:auto;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.76)}
    table{width:100%;border-collapse:collapse;font-size:12px;min-width:980px}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:middle}
    th{color:var(--muted);font-weight:900;position:sticky;top:0;background:rgba(255,255,255,.95)}
    td input{padding:10px;border-radius:12px}
    .mini{padding:8px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.95)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .note{
      border:1px dashed rgba(16,24,40,.16);
      background:rgba(255,255,255,.70);
      border-radius:16px;padding:12px;margin-top:12px;color:var(--muted);
      font-size:12px;line-height:1.6;
    }

    .panel{
      border:1px solid rgba(79,70,229,.18);
      background:linear-gradient(180deg, rgba(79,70,229,.10), rgba(255,255,255,.72));
      border-radius:16px;padding:12px;margin-top:0;
    }
    .pHead{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .pGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:560px){.pGrid{grid-template-columns:1fr}}
    .pItem{border:1px solid var(--line);background:rgba(255,255,255,.76);border-radius:14px;padding:10px}
    .pItem .t{font-size:12px;color:var(--muted)}
    .pItem .v{font-weight:900;margin-top:6px}
    .pList{margin:10px 0 0;padding-left:18px;color:var(--muted);line-height:1.6;font-size:12px}
    .tag{
      padding:6px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.82);font-size:12px;color:var(--muted);
    }

    .pp-footer{
      margin-top:26px;
      background:
        radial-gradient(900px 520px at 20% 0%, rgba(94,234,212,.10), transparent 55%),
        radial-gradient(900px 520px at 80% 0%, rgba(96,165,250,.10), transparent 55%),
        var(--f-bg);
      border-top:1px solid rgba(255,255,255,.08);
      padding:26px 0;
    }
    .pp-footbox{
      border:1px solid var(--f-line);
      background:rgba(255,255,255,.04);
      border-radius:18px;
      padding:16px;
      max-width:1200px;
      margin:0 auto;
    }
    .pp-footgrid{
      display:grid;
      grid-template-columns:1.15fr .85fr;
      gap:16px;
      align-items:start;
      padding:0 16px;
    }
    @media(max-width:880px){.pp-footgrid{grid-template-columns:1fr}}
    .pp-footbrand b{color:var(--f-txt);font-weight:1000}
    .pp-footmut{
      margin-top:8px;
      color:var(--f-muted);
      font-size:12.6px;
      line-height:1.75;
      max-width:760px;
    }
    .pp-footmut a{color:rgba(94,234,212,.95);font-weight:900}
    .pp-footlinks{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end}
    @media(max-width:880px){.pp-footlinks{justify-content:flex-start}}
    .pp-footlinks a{
      padding:9px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--f-txt);
      font-weight:900;
      display:inline-flex;align-items:center;gap:8px;
      transition:transform .08s ease;
    }
    .pp-footlinks a:hover{transform:translateY(-1px);text-decoration:none}
    .pp-footbottom{
      margin-top:14px;padding-top:14px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;
      color:rgba(255,255,255,.72);
      font-size:12.5px;line-height:1.75;
      padding:14px 16px 0;
    }
    .pp-footbottom a{color:rgba(94,234,212,.95);font-weight:900}

    @media print{
      body{background:#fff}
      .pp-header, .pp-footer, #controlsRow, #reviewsCard, #proCard, #logoutBtn, .tabs, #bulkTools, #bulkPasteBox, #importBanner {display:none !important}
      .wrap{margin:0;max-width:none}
      .card{box-shadow:none}
    }
  </style>
</head>

<body>
  <a class="skip" href="#content">Skip to content</a>

  <header class="pp-header" role="navigation" aria-label="Primary">
    <div class="pp-wrap">
      <div class="pp-headerbar">
        <div class="pp-row">
          <div class="pp-brand" aria-label="ProfitPilot">
            <div class="pp-logo" aria-hidden="true">PP</div>
            <div>
              <div class="pp-title">ProfitPilot</div>
              <div class="pp-sub">Independent tool by UKwebtools</div>
            </div>
          </div>

          <nav class="pp-nav" aria-label="Main">
            <a class="btn ghost" href="https://ukwebtools.com/" rel="nofollow">← Ukwebtools</a>
            <a class="btn ghost" href="help.html">How to use</a>
            <a class="btn primary" href="login.html" id="accountLink">Account</a>
            <span class="pill" id="accessPill">Checking access…</span>
            <button class="btn" id="logoutBtn" type="button">Log out</button>
          </nav>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" id="content">
    <div class="banner" id="importBanner">Imported shared calculation ✅</div>

    <div class="grid">
      <!-- LEFT -->
     <div class="card" id="calcCard">
        <div class="title">Calculator</div>
        <div class="small">Profit = normal. Reverse = target profit → required selling price. Bulk = multiple items.</div>

        <div class="tabs">
          <div class="tab active" id="tabProfit">Profit</div>
          <div class="tab" id="tabReverse">Reverse</div>
          <div class="tab" id="tabBulk">Bulk</div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div>
            <label>Display currency</label>
            <select id="currency">
              <option value="GBP">GBP (£)</option>
              <option value="USD">USD ($)</option>
              <option value="EUR">EUR (€)</option>
              <option value="AUD">AUD ($)</option>
              <option value="CAD">CAD ($)</option>
              <option value="NZD">NZD ($)</option>
              <option value="AED">AED</option>
              <option value="SAR">SAR</option>
              <option value="PKR">PKR (₨)</option>
              <option value="INR">INR (₹)</option>
            </select>
          </div>
          <div>
            <label>Exchange rate (optional)</label>
            <input id="fxRate" inputmode="decimal" placeholder="e.g., 1 base = 1.25 selected" value="">
          </div>
        </div>

        <div id="singleBox">
          <div class="divider"></div>

          <label>Platform preset</label>
          <select id="preset"></select>
          <label id="catLabel" style="display:none;margin-top:10px">Category (for accurate fees)</label>
<select id="category" style="display:none"></select>
<div class="small" id="presetNote" style="margin-top:8px">—</div>


          <div class="row">
            <div><label>Selling price</label><input id="sellPrice" inputmode="decimal" value="0"></div>
            <div><label>Product cost</label><input id="productCost" inputmode="decimal" value="0"></div>
          </div>

          <div class="row">
            <div><label>Shipping cost</label><input id="shipCost" inputmode="decimal" value="0"></div>
            <div><label>Packaging / misc</label><input id="miscCost" inputmode="decimal" value="0"></div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div><label>Platform fee (%)</label><input id="feePct" inputmode="decimal" value="0"></div>
            <div><label>Fixed fee</label><input id="feeFixed" inputmode="decimal" value="0"></div>
          </div>

          <div class="row">
            <div><label>Ads (%)</label><input id="adsPct" inputmode="decimal" value="0"></div>
            <div><label>Return rate (%)</label><input id="returnPct" inputmode="decimal" value="0"></div>
          </div>

          <div id="reverseBox" style="display:none">
            <div class="divider"></div>
            <div class="title" style="margin:0 0 6px;font-size:14px">Reverse mode</div>
            <div class="small">Trial: 3 reverse calculations total. PRO: unlimited.</div>
            <label>Target profit</label>
            <input id="targetProfit" inputmode="decimal" value="0">
            <div class="small" id="reverseUsesLine" style="margin-top:8px">Reverse uses: —</div>
          </div>

          <div class="divider"></div>

          <div class="row" id="controlsRow">
            <button class="btn primary" id="calcBtn" type="button">Calculate</button>
            <button class="btn" id="resetBtn" type="button">Reset</button>
          </div>

          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button class="btn" id="exportCsvBtn" type="button">Export CSV</button>
            <button class="btn" id="pdfBtn" type="button">Export PDF (PRO)</button>
            <button class="btn" id="shareBtn" type="button">Share link (PRO)</button>
            <span class="pill" id="shareStatus">—</span>
          </div>

          <div class="kpi">
            <div class="k">
              <div class="h" id="o1h">Estimated profit</div>
              <div class="v" id="o1v">£0.00</div>
              <div class="hint" id="o1hint">—</div>
            </div>
            <div class="k">
              <div class="h" id="o2h">Margin</div>
              <div class="v" id="o2v">0.0%</div>
              <div class="hint" id="o2hint">—</div>
            </div>
          </div>

          <div class="kpi">
            <div class="k">
              <div class="h">Total fees + ads</div>
              <div class="v" id="feesOut">£0.00</div>
              <div class="hint">Platform fee + fixed + ads</div>
            </div>
            <div class="k">
              <div class="h">Return sensitivity (expected)</div>
              <div class="v" id="returnOut">£0.00</div>
              <div class="hint">Expected impact from return %</div>
            </div>
          </div>

          <div class="kpi" id="fxRow" style="display:none">
            <div class="k" style="grid-column:1 / -1">
              <div class="h">Converted selling price (your FX)</div>
              <div class="v" id="fxOut">—</div>
              <div class="hint" id="fxNote">—</div>
            </div>
          </div>
        </div>

        <!-- BULK -->
        <div id="bulkBox" style="display:none">
          <div class="divider"></div>

          <div class="title" style="margin:0 0 6px;font-size:14px">Bulk mode</div>
          <div class="small" id="bulkLimitLine">Loading bulk limits…</div>

          <div class="divider"></div>

          <div id="bulkPasteBox">
            <div class="title" style="margin:0 0 6px;font-size:14px">Paste rows</div>
            <div class="small">Paste: <b>Sell, Cost, Ship, Misc</b> (comma or tab). Optional columns: Fee%, Fixed, Ads%, Return%.</div>
            <textarea id="bulkPaste" placeholder="Example:
12.99, 6.20, 0.00, 0.20
19.99, 9.50, 0.00, 0.30"></textarea>
            <div class="actions" style="margin-top:10px">
              <button class="btn" id="bulkImportBtn" type="button">Import into table</button>
              <button class="btn" id="bulkFillExampleBtn" type="button">Fill example</button>
              <span class="pill" id="bulkImportStatus">—</span>
            </div>
          </div>

          <div class="divider"></div>

          <div class="actions" id="bulkTools">
            <button class="btn primary" id="bulkRunBtn" type="button">Run bulk</button>
            <button class="btn" id="bulkAddRowBtn" type="button">+ Add row</button>
            <button class="btn" id="bulkClearBtn" type="button">Clear rows</button>
            <button class="btn" id="bulkApplyFeesBtn" type="button">Apply current fees to all</button>
            <button class="btn" id="bulkExportBtn" type="button">Export bulk CSV</button>
            <span class="pill" id="bulkStatus">—</span>
          </div>

          <div style="margin-top:10px" class="bulkWrap">
            <table id="bulkTable">
              <thead>
                <tr>
                  <th style="width:56px">#</th>
                  <th>Sell</th>
                  <th>Cost</th>
                  <th>Ship</th>
                  <th>Misc</th>
                  <th>Fee %</th>
                  <th>Fixed</th>
                  <th>Ads %</th>
                  <th>Return %</th>
                  <th>Profit</th>
                  <th>Margin</th>
                  <th style="width:90px">Action</th>
                </tr>
              </thead>
              <tbody id="bulkTbody"></tbody>
            </table>
          </div>

          <div class="note">
            <b>Trial rules:</b> max <b>3 rows</b> and <b>1 bulk run per day</b>. PRO is unlimited.
          </div>
        </div>

        <div class="divider"></div>

        <div class="small">
          <b>Disclaimer:</b> estimates only (not financial/legal/tax advice). Not affiliated with any platform.
          FX depends on your entered rate (no live rates). See
          <a href="terms.html">Terms</a> and
          <a href="privacy.html">Privacy</a>.
        </div>
      </div>

      <!-- RIGHT -->
      
        <div class="card" id="proCard">
          <div class="title">PRO features</div>
          <div class="small">Unlimited reverse + competitor + bulk, PDF export, share links, insights, saved scenarios. One-time unlock.</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <a class="btn primary" id="buyProBtn" href="https://stonevia.gumroad.com/l/goddhg" target="_blank" rel="noopener">Buy PRO</a>
            <a class="btn" href="reviews.html">See reviews</a>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="panel" id="insightsBox">
            <div class="pHead">
              <div>
                <div style="font-weight:900">Insights (PRO)</div>
                <div class="small">Decision support from your inputs (estimates only).</div>
              </div>
              <span class="tag" id="insStatus">Locked</span>
            </div>

            <div class="pGrid">
              <div class="pItem"><div class="t">Break-even price</div><div class="v" id="bePrice">—</div></div>
              <div class="pItem">
                <div class="t">Price for target margin</div><div class="v" id="targetMarginPrice">—</div>
                <div class="small">Target: <span id="targetMarginVal">15%</span></div>
              </div>
              <div class="pItem"><div class="t">Max ads % you can afford</div><div class="v" id="maxAdsPct">—</div><div class="small">Keeps profit ≥ 0</div></div>
              <div class="pItem"><div class="t">Risk rating</div><div class="v" id="riskLabel">—</div><div class="small" id="riskExplain">—</div></div>
            </div>

            <ul class="pList" id="insBullets"><li>Unlock PRO to see insights.</li></ul>

            <div class="row" style="margin-top:10px">
              <div>
                <label>Target margin (%)</label>
                <input id="targetMarginInput" inputmode="decimal" value="15">
              </div>
              <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
                <button class="btn" id="refreshInsightsBtn" type="button">Refresh insights</button>
                <span class="pill" id="insToast">—</span>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="panel" id="compBox">
            <div class="pHead">
              <div>
                <div style="font-weight:900">Competitor mode (manual)</div>
                <div class="small">Enter competitor prices you found yourself. No scraping.</div>
              </div>
              <span class="tag" id="compStatus">Trial limited</span>
            </div>

            <div class="small" id="compUsesLine" style="margin-top:6px">Competitor uses: —</div>

            <div class="row" style="margin-top:8px">
              <div><label>Competitor price #1</label><input id="c1" inputmode="decimal" value="0"></div>
              <div><label>Competitor price #2</label><input id="c2" inputmode="decimal" value="0"></div>
            </div>
            <div class="row">
              <div><label>Competitor price #3</label><input id="c3" inputmode="decimal" value="0"></div>
              <div>
                <label>Positioning</label>
                <select id="positioning">
                  <option value="undercut">Undercut slightly</option>
                  <option value="match">Match market</option>
                  <option value="premium">Premium (if your offer is better)</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Buffer above break-even (%)</label>
                <input id="floorBuffer" inputmode="decimal" value="5">
                <div class="small">“Don’t go below” = break-even + buffer</div>
              </div>
              <div style="display:flex;align-items:end;gap:10px;flex-wrap:wrap">
                <button class="btn primary" id="runCompBtn" type="button">Run competitor mode</button>
                <span class="pill" id="compToast">—</span>
              </div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
              <button class="btn" id="useSuggestedBtn" type="button" disabled>Use suggested price</button>
              <button class="btn" id="saveScenarioBtn" type="button">Save scenario (PRO)</button>
              <span class="pill" id="scenarioToast">—</span>
            </div>

            <div class="pGrid" style="margin-top:10px">
              <div class="pItem"><div class="t">Market reference (median)</div><div class="v" id="compMedian">—</div></div>
              <div class="pItem"><div class="t">Suggested price</div><div class="v" id="compSuggest">—</div><div class="small" id="compWhy">—</div></div>
              <div class="pItem"><div class="t">Don’t go below</div><div class="v" id="compFloor">—</div><div class="small">Break-even + buffer</div></div>
              <div class="pItem"><div class="t">Reality check</div><div class="v" id="compCheck">—</div><div class="small" id="compCheck2">—</div></div>
            </div>

            <ul class="pList" id="compBullets">
              <li>Tip: use “Don’t go below” as your personal floor price.</li>
            </ul>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div class="title">Saved scenarios (PRO)</div>
          <div class="small">Saved locally on this device for speed. (PRO-only to save.)</div>

          <label>Saved scenarios</label>
          <select id="scenarioSel"><option value="">—</option></select>

          <div class="row">
            <button class="btn" id="loadScenarioBtn" type="button">Load</button>
            <button class="btn" id="deleteScenarioBtn" type="button">Delete</button>
          </div>

          <div class="divider"></div>

          <label>Scenario name</label>
          <input id="scenarioName" placeholder="e.g., Competitor median £13.49">

          <div class="row">
            <button class="btn primary" id="saveScenarioBtn2" type="button">Save current (PRO)</button>
            <span class="pill" id="scenarioStatus">—</span>
          </div>
        </div>

        <div class="card" id="reviewsCard" style="margin-top:14px">
          <div class="title">Leave a review</div>
          <div class="small">One review per account. You can edit it anytime.</div>

          <label>Name (optional)</label>
          <input id="revName" placeholder="Name">

          <label>Category</label>
          <select id="revCat">
            <option>General</option>
            <option>UI/UX</option>
            <option>Accuracy</option>
            <option>Speed</option>
            <option>Features</option>
          </select>

          <label>Rating</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap" id="starsRow">
            <button class="btn" type="button" data-star="1">★ 1</button>
            <button class="btn" type="button" data-star="2">★ 2</button>
            <button class="btn" type="button" data-star="3">★ 3</button>
            <button class="btn" type="button" data-star="4">★ 4</button>
            <button class="btn" type="button" data-star="5">★ 5</button>
          </div>

          <label>Review</label>
          <input id="revMsg" placeholder="What did you like? What should we improve?">

          <button class="btn primary" id="sendReview" type="button">Submit / Update review</button>
          <div class="toast" id="reviewStatus">—</div>
        </div>

        <div style="margin-top:14px" class="small">© <span id="yr"></span> UKwebtools • ProfitPilot</div>
    
    </div>
  </main>

  <footer class="pp-footer" role="contentinfo">
    <div class="pp-footbox">
      <div class="pp-footgrid">
        <div class="pp-footbrand">
          <div><b>ProfitPilot</b></div>
          <div class="pp-footmut">
            <b>Independent tool:</b> not affiliated with any marketplace/platform/payment provider.<br>
            <b>Estimates only:</b> outputs depend on your inputs and assumptions; no profit guarantees.<br>
            Need help? <a href="mailto:support@ukwebtools.com">support@ukwebtools.com</a>
          </div>
        </div>

        <div class="pp-footlinks" aria-label="Footer links">
          <a href="index.html">Home</a>
          <a href="pricing.html">Pricing</a>
          <a href="reviews.html">Reviews</a>
          <a href="refunds.html">Refund Policy</a>
          <a href="faq.html">FAQ</a>
          <a href="terms.html">Terms</a>
          <a href="privacy.html">Privacy</a>
        </div>
      </div>

      <div class="pp-footbottom">
        <div>© <span id="yr2"></span> UKwebtools • ProfitPilot</div>
        <div><a href="https://ukwebtools.com/" rel="nofollow">UKwebtools</a></div>
      </div>
    </div>
  </footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    const SUPABASE_URL = "https://xsigsftvfknefpdfsyae.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzaWdzZnR2ZmtuZWZwZGZzeWFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzY4NjksImV4cCI6MjA4NTg1Mjg2OX0.Jkkh9Jd46saYBVipN8bxbWhjmhG6mgaFgtTpirKUAWg";

    const TRIAL_DAYS = 5;
    const TRIAL_REVERSE_LIMIT = 3;
    const TRIAL_COMP_LIMIT = 3;
    const TRIAL_BULK_MAX_ROWS = 3;
    const TRIAL_BULK_RUNS_PER_DAY = 1;

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        flowType: "pkce",
        storageKey: "profitpilot_auth"
      }
    });

    // --- GA4 tracking helper ---
    function track(eventName, params = {}) {
      try { if (typeof gtag === "function") gtag("event", eventName, params); } catch (e) {}
    }

    // ---------------------------
    // Helpers (define BEFORE use)
    // ---------------------------
    const CURRENCY_SYMBOL = { GBP:"£", USD:"$", EUR:"€", AUD:"$", CAD:"$", NZD:"$", AED:"AED ", SAR:"SAR ", PKR:"₨", INR:"₹" };

    function n(v){ const x = parseFloat(String(v ?? "").replace(/,/g,"")); return Number.isFinite(x) ? x : 0; }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function todayKeyUTC(){
      const d = new Date();
      const y = d.getUTCFullYear();
      const m = String(d.getUTCMonth()+1).padStart(2,"0");
      const day = String(d.getUTCDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }
    function daysLeft(trialStartISO){
      const start = new Date(trialStartISO).getTime();
      const elapsedDays = (Date.now() - start) / (1000*60*60*24);
      return Math.max(0, Math.ceil(TRIAL_DAYS - elapsedDays));
    }

    function autoZero(el){
      if (!el) return;
      el.addEventListener("focus", ()=>{
        const v = String(el.value ?? "").trim();
        if (v === "0" || v === "0.0" || v === "0.00") el.value = "";
      });
      el.addEventListener("blur", ()=>{
        const v = String(el.value ?? "").trim();
        if (v === "") el.value = "0";
      });
    }

    function csvEscape(s){ const t = String(s ?? ""); return /[",\n]/.test(t) ? `"${t.replaceAll('"','""')}"` : t; }
    function downloadText(filename, text){
      const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function base64urlEncode(str){
      const bytes = new TextEncoder().encode(str);
      let bin=""; bytes.forEach(b=>bin+=String.fromCharCode(b));
      return btoa(bin).replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
    }
    function base64urlDecodeToString(b64url){
      let s = (b64url||"").replace(/-/g, "+").replace(/_/g, "/");
      while (s.length % 4) s += "=";
      const bin = atob(s);
      const bytes = new Uint8Array([...bin].map(ch => ch.charCodeAt(0)));
      return new TextDecoder().decode(bytes);
    }

    // ---------------------------
    // DOM
    // ---------------------------
    const accessPill = document.getElementById("accessPill");
    const reverseUsesLine = document.getElementById("reverseUsesLine");
    const bulkLimitLine = document.getElementById("bulkLimitLine");
    const shareStatus = document.getElementById("shareStatus");
    const bulkStatus = document.getElementById("bulkStatus");
    const bulkImportStatus = document.getElementById("bulkImportStatus");
    const importBanner = document.getElementById("importBanner");
    const proCard = document.getElementById("proCard");

    const pdfBtn = document.getElementById("pdfBtn");
    const shareBtn = document.getElementById("shareBtn");

    const currencyEl = document.getElementById("currency");
    const fxRateEl = document.getElementById("fxRate");
    const presetSel = document.getElementById("preset");

    const sellPriceEl = document.getElementById("sellPrice");
    const productCostEl = document.getElementById("productCost");
    const shipCostEl = document.getElementById("shipCost");
    const miscCostEl = document.getElementById("miscCost");
    const feePctEl = document.getElementById("feePct");
    const feeFixedEl = document.getElementById("feeFixed");
    const adsPctEl = document.getElementById("adsPct");
    const returnPctEl = document.getElementById("returnPct");
    const targetProfitEl = document.getElementById("targetProfit");

    const o1h = document.getElementById("o1h");
    const o2h = document.getElementById("o2h");
    const o1v = document.getElementById("o1v");
    const o2v = document.getElementById("o2v");
    const o1hint = document.getElementById("o1hint");
    const o2hint = document.getElementById("o2hint");
    const feesOut = document.getElementById("feesOut");
    const returnOut = document.getElementById("returnOut");

    const fxRow = document.getElementById("fxRow");
    const fxOut = document.getElementById("fxOut");
    const fxNote = document.getElementById("fxNote");

    // Insights
    const insStatus = document.getElementById("insStatus");
    const bePriceEl = document.getElementById("bePrice");
    const targetMarginPriceEl = document.getElementById("targetMarginPrice");
    const maxAdsPctEl = document.getElementById("maxAdsPct");
    const riskLabelEl = document.getElementById("riskLabel");
    const riskExplainEl = document.getElementById("riskExplain");
    const insBullets = document.getElementById("insBullets");
    const targetMarginInput = document.getElementById("targetMarginInput");
    const targetMarginVal = document.getElementById("targetMarginVal");
    const refreshInsightsBtn = document.getElementById("refreshInsightsBtn");
    const insToast = document.getElementById("insToast");

    // Competitor
    const compStatus = document.getElementById("compStatus");
    const compUsesLine = document.getElementById("compUsesLine");
    const runCompBtn = document.getElementById("runCompBtn");
    const compToast = document.getElementById("compToast");
    const scenarioToast = document.getElementById("scenarioToast");
    const useSuggestedBtn = document.getElementById("useSuggestedBtn");
    const saveScenarioBtn = document.getElementById("saveScenarioBtn");

    const c1 = document.getElementById("c1");
    const c2 = document.getElementById("c2");
    const c3 = document.getElementById("c3");
    const positioning = document.getElementById("positioning");
    const floorBuffer = document.getElementById("floorBuffer");
    const compMedian = document.getElementById("compMedian");
    const compSuggest = document.getElementById("compSuggest");
    const compWhy = document.getElementById("compWhy");
    const compFloor = document.getElementById("compFloor");
    const compCheck = document.getElementById("compCheck");
    const compCheck2 = document.getElementById("compCheck2");
    const compBullets = document.getElementById("compBullets");

    // Scenarios
    const scenarioSel = document.getElementById("scenarioSel");
    const scenarioName = document.getElementById("scenarioName");
    const saveScenarioBtn2 = document.getElementById("saveScenarioBtn2");
    const loadScenarioBtn = document.getElementById("loadScenarioBtn");
    const deleteScenarioBtn = document.getElementById("deleteScenarioBtn");
    const scenarioStatus = document.getElementById("scenarioStatus");

    // Bulk
    const bulkRunBtn = document.getElementById("bulkRunBtn");
    const bulkAddRowBtn = document.getElementById("bulkAddRowBtn");
    const bulkClearBtn = document.getElementById("bulkClearBtn");
    const bulkApplyFeesBtn = document.getElementById("bulkApplyFeesBtn");
    const bulkExportBtn = document.getElementById("bulkExportBtn");
    const bulkPasteEl = document.getElementById("bulkPaste");
    const bulkImportBtn = document.getElementById("bulkImportBtn");
    const bulkFillExampleBtn = document.getElementById("bulkFillExampleBtn");
    const bulkTbody = document.getElementById("bulkTbody");

    // Tabs
    const tabProfit = document.getElementById("tabProfit");
    const tabReverse = document.getElementById("tabReverse");
    const tabBulk = document.getElementById("tabBulk");
    const singleBox = document.getElementById("singleBox");
    const reverseBox = document.getElementById("reverseBox");
    const bulkBox = document.getElementById("bulkBox");

    // Footer years
    document.getElementById("yr").textContent = new Date().getFullYear();
    document.getElementById("yr2").textContent = new Date().getFullYear();

    // Attach autoZero (safe)
    [
      sellPriceEl, productCostEl, shipCostEl, miscCostEl,
      feePctEl, feeFixedEl, adsPctEl, returnPctEl,
      targetProfitEl, fxRateEl,
      c1, c2, c3, floorBuffer, targetMarginInput
    ].filter(Boolean).forEach(autoZero);

    // ---------------------------
    // Currency formatting
    // ---------------------------
    function sym(){ return CURRENCY_SYMBOL[currencyEl?.value || "GBP"] || ""; }
    function money(x){ return sym() + (Number.isFinite(x) ? x : 0).toFixed(2); }
    function pct(x){ return (Number.isFinite(x) ? x : 0).toFixed(1) + "%"; }

    function updateFXLine(sell){
      const r = n(fxRateEl?.value);
      if (!fxRow || !fxOut || !fxNote) return;
      if (r > 0 && sell > 0){
        fxRow.style.display = "block";
        fxOut.textContent = (sell * r).toFixed(2);
        fxNote.textContent = `Converted using your rate: ${sell.toFixed(2)} × ${r}`;
      } else fxRow.style.display = "none";
    }

    // ---------------------------
    // Presets (defensive)
    // ---------------------------
   // ---------------------------
// Presets (Country + Category + Dynamic fixed fee rules)
// ---------------------------

// Etsy: transaction fee is 6.5% (global) 
// Etsy Payments: varies by country; UK example is 4% + £0.20 
//
// eBay UK business sellers: % depends on category; plus per-order fee that depends on order total
// £0.30 for orders <= £10, £0.40 for orders > £10 
//
// Amazon UK: Individual plan £0.75 per unit; referral fee varies by category, most between 8% and 15% 
//
// TikTok Shop: commission exists and is category-based; rates can change & depend on program.
// We include it as “enter your commission %” by default. 
const PRESETS = [
  {
    id: "manual",
    label: "Manual (enter fees yourself)",
    note: "Use this when you already know your exact fees.",
    base: { feePct: 0, feeFixed: 0, adsPct: 0, returnPct: 0 },
    categories: null,
    dynamicFixed: null
  },

  // -------- Etsy --------
  {
    id: "etsy_uk",
    label: "Etsy (UK) — 6.5% + (Payments 4% + £0.20)",
    note: "Includes transaction fee (6.5%) + Etsy Payments UK (4% + £0.20). Listing fee (£0.15) is per listing, not per order.",
    base: { feePct: 10.5, feeFixed: 0.20, adsPct: 0, returnPct: 3 },
    categories: null,
    dynamicFixed: null
  },
  {
    id: "etsy_us",
    label: "Etsy (US) — 6.5% + (Payments 3% + $0.25)",
    note: "Includes transaction fee (6.5%) + Etsy Payments US (3% + $0.25).",
    base: { feePct: 9.5, feeFixed: 0.25, adsPct: 0, returnPct: 3 },
    categories: null,
    dynamicFixed: null
  },

  // -------- eBay UK (category-based + dynamic per-order fee) --------
  {
    id: "ebay_uk",
    label: "eBay (UK Business) — category-based % + per-order fee",
    note: "Choose category to autofill % (edit if needed). Per-order fee auto-adjusts: £0.30 (≤£10), £0.40 (>£10).",
    base: { feePct: 0, feeFixed: 0, adsPct: 0, returnPct: 4 },
    dynamicFixed: "ebay_uk_order_fee",
    categories: [
      { id:"ebay_uk_custom", name:"Custom (enter your category % from eBay rate card)", feePct: 0 },

      // ⚠ These are *starter defaults* only. Replace with your exact rate-card values if you want 100% accuracy by category.
      // If you prefer strict accuracy only, keep feePct = 0 for all and force manual entry.
      { id:"ebay_uk_typical_12_8", name:"Typical example (~12.8%)", feePct: 12.8 },
      { id:"ebay_uk_typical_12_0", name:"Typical example (~12.0%)", feePct: 12.0 },
    ]
  },

  // -------- Amazon UK (category-based; optional per-item fee for Individual plan) --------
  {
    id: "amazon_uk_individual",
    label: "Amazon (UK Individual) — category % + £0.75 per unit",
    note: "Select a category % (varies by category). £0.75 per-item fee is included (Individual plan).",
    base: { feePct: 0, feeFixed: 0.75, adsPct: 0, returnPct: 6 },
    dynamicFixed: null,
    categories: [
      { id:"amazon_uk_custom", name:"Custom (enter referral % for your category)", feePct: 0 },

      // Same policy as above: starter defaults only. You can replace with exact category rates later.
      { id:"amazon_uk_15", name:"Common range example (15%)", feePct: 15.0 },
      { id:"amazon_uk_12", name:"Common range example (12%)", feePct: 12.0 },
      { id:"amazon_uk_8",  name:"Common range example (8%)",  feePct: 8.0 },
    ]
  },

  // -------- TikTok Shop (UK) --------
  {
    id: "tiktokshop_uk",
    label: "TikTok Shop (UK) — enter your commission %",
    note: "TikTok Shop commission is category/program dependent. Use Custom and enter your current commission %.",
    base: { feePct: 0, feeFixed: 0, adsPct: 0, returnPct: 5 },
    categories: [
      { id:"tiktok_uk_custom", name:"Custom (enter your commission %)", feePct: 0 },
    ],
    dynamicFixed: null
  },

  // -------- Card processors (country examples) --------
  {
    id: "stripe_uk_example",
    label: "Card payments (UK example) — 2.0% + £0.20",
    note: "This models a payment processor fee (not a marketplace commission).",
    base: { feePct: 2.0, feeFixed: 0.20, adsPct: 0, returnPct: 2 },
    categories: null,
    dynamicFixed: null
  },
];

// DOM additions
const catLabel = document.getElementById("catLabel");
const categorySel = document.getElementById("category");
const presetNote = document.getElementById("presetNote");

function getPresetById(id){
  return PRESETS.find(p => p.id === id) || PRESETS[0];
}

function setFeesFromPreset(preset, categoryObj=null){
  const base = preset.base || { feePct:0, feeFixed:0, adsPct:0, returnPct:0 };

  const feePct = (categoryObj && typeof categoryObj.feePct === "number") ? categoryObj.feePct : (base.feePct ?? 0);

  feePctEl.value   = String(feePct);
  feeFixedEl.value = String(base.feeFixed ?? 0);
  adsPctEl.value   = String(base.adsPct ?? 0);
  returnPctEl.value= String(base.returnPct ?? 0);

  // dynamic fixed fee rules (eBay UK per-order fee)
  if (preset.dynamicFixed === "ebay_uk_order_fee"){
    feeFixedEl.disabled = true;
    feeFixedEl.title = "Auto-set by eBay UK per-order fee rule";
    updateDynamicFixedFee(); // set immediately
  } else {
    feeFixedEl.disabled = false;
    feeFixedEl.title = "";
  }

  if (presetNote) presetNote.textContent = preset.note || "—";
}

function showCategories(preset){
  const cats = preset.categories;
  if (!catLabel || !categorySel) return;

  if (!cats || !cats.length){
    catLabel.style.display = "none";
    categorySel.style.display = "none";
    categorySel.innerHTML = "";
    return;
  }

  catLabel.style.display = "block";
  categorySel.style.display = "block";
  categorySel.innerHTML = "";

  cats.forEach(c=>{
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    categorySel.appendChild(opt);
  });

  categorySel.value = cats[0].id;
}

// eBay UK per-order fee rule: £0.30 (≤£10), £0.40 (>£10) 
function updateDynamicFixedFee(){
  const preset = getPresetById(presetSel.value);
  if (preset.dynamicFixed !== "ebay_uk_order_fee") return;

  const sell = n(sellPriceEl?.value);
  const fixed = (sell > 10) ? 0.40 : 0.30;
  feeFixedEl.value = fixed.toFixed(2);
}

// Build preset dropdown (detailed labels already include country/platform)
if (presetSel){
  presetSel.innerHTML = "";
  PRESETS.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.label;
    presetSel.appendChild(opt);
  });

  presetSel.value = "manual";

  presetSel.addEventListener("change", ()=>{
    const preset = getPresetById(presetSel.value);
    showCategories(preset);

    // Use selected category (if exists) to set fee %
    let catObj = null;
    if (preset.categories && preset.categories.length && categorySel){
      catObj = preset.categories.find(x=>x.id===categorySel.value) || preset.categories[0];
    }

    setFeesFromPreset(preset, catObj);
    compute(); refreshInsights();
  });
}

// Category change => update fee %
categorySel?.addEventListener("change", ()=>{
  const preset = getPresetById(presetSel.value);
  if (!preset.categories) return;

  const catObj = preset.categories.find(x=>x.id===categorySel.value) || null;
  setFeesFromPreset(preset, catObj);
  compute(); refreshInsights();
});

// Keep dynamic fixed fee updated if sell price changes
sellPriceEl?.addEventListener("input", ()=>{
  updateDynamicFixedFee();
});

// Init on load
(function initPresetUI(){
  const preset = getPresetById(presetSel.value || "manual");
  showCategories(preset);

  let catObj = null;
  if (preset.categories && preset.categories.length && categorySel){
    catObj = preset.categories[0];
  }

  setFeesFromPreset(preset, catObj);
})();

  
    // ---------------------------
    // Core math
    // ---------------------------
    function totalFees(sell, feePct, feeFixed, adsPct){
      return sell * (feePct/100) + feeFixed + sell * (adsPct/100);
    }

    function computeRowProfit(sell,cost,ship,misc,feePct,feeFixed,adsPct,returnPct){
      const fees = totalFees(sell, feePct, feeFixed, adsPct);
      const expectedReturnImpact = sell * (returnPct/100);
      const profit = sell - (cost + ship + misc + fees);
      const margin = sell > 0 ? (profit/sell)*100 : 0;
      return { profit, margin, fees, expectedReturnImpact };
    }

    function computeProfit(){
      const sell = n(sellPriceEl?.value);
      const cost = n(productCostEl?.value);
      const ship = n(shipCostEl?.value);
      const misc = n(miscCostEl?.value);
      const feePct = clamp(n(feePctEl?.value),0,99);
      const feeFixed = clamp(n(feeFixedEl?.value),0,999999);
      const adsPct = clamp(n(adsPctEl?.value),0,99);
      const returnPct = clamp(n(returnPctEl?.value),0,99);

      const r = computeRowProfit(sell,cost,ship,misc,feePct,feeFixed,adsPct,returnPct);

      if (o1v) o1v.textContent = money(r.profit);
      if (o2v) o2v.textContent = pct(r.margin);
      if (feesOut) feesOut.textContent = money(r.fees);
      if (returnOut) returnOut.textContent = money(r.expectedReturnImpact);

      if (sell<=0){
        if (o1hint) o1hint.textContent="Enter a selling price.";
        if (o2hint) o2hint.textContent="—";
      } else if (r.profit<0){
        if (o1hint) o1hint.textContent="Loss on this pricing.";
        if (o2hint) o2hint.textContent="Adjust price or costs.";
      } else {
        if (o1hint) o1hint.textContent="OK (based on your inputs).";
        if (o2hint) o2hint.textContent="—";
      }

      updateFXLine(sell);
      return { sell, ...r };
    }

    function reverseSellPriceForTargetProfit(target){
      const cost = n(productCostEl?.value);
      const ship = n(shipCostEl?.value);
      const misc = n(miscCostEl?.value);
      const feePct = clamp(n(feePctEl?.value),0,99);
      const adsPct = clamp(n(adsPctEl?.value),0,99);
      const feeFixed = clamp(n(feeFixedEl?.value),0,999999);

      const denom = 1 - ((feePct + adsPct)/100);
      if (denom <= 0.01) return null;
      return (target + cost + ship + misc + feeFixed) / denom;
    }

    function computeReverse(){
      const target = n(targetProfitEl?.value);
      if (target<=0){
        if (o1v) o1v.textContent="—";
        if (o2v) o2v.textContent="—";
        if (o1hint) o1hint.textContent="Enter a target profit.";
        if (o2hint) o2hint.textContent="—";
        return;
      }
      const sell = reverseSellPriceForTargetProfit(target);
      if (!sell){
        if (o1hint) o1hint.textContent="Reverse calc failed. Check fee % values.";
        if (o2hint) o2hint.textContent="—";
        return;
      }
      if (sellPriceEl) sellPriceEl.value = sell.toFixed(2);
      computeProfit();

      if (o1v) o1v.textContent = money(sell);
      if (o1hint) o1hint.textContent = `Required selling price to target ~${money(target)} profit (estimate).`;
      if (o2hint) o2hint.textContent = "Implied margin at that selling price.";
      updateFXLine(sell);
    }

    // ---------------------------
    // Modes / Tabs
    // ---------------------------
    let MODE = "profit";
    function setMode(m){
      MODE = m;
      tabProfit?.classList.toggle("active", m==="profit");
      tabReverse?.classList.toggle("active", m==="reverse");
      tabBulk?.classList.toggle("active", m==="bulk");

      if (singleBox) singleBox.style.display = (m==="bulk") ? "none" : "block";
      if (bulkBox) bulkBox.style.display = (m==="bulk") ? "block" : "none";
      if (reverseBox) reverseBox.style.display = (m==="reverse") ? "block" : "none";

      if (m==="profit"){ if(o1h) o1h.textContent="Estimated profit"; if(o2h) o2h.textContent="Margin"; }
      if (m==="reverse"){ if(o1h) o1h.textContent="Required selling price"; if(o2h) o2h.textContent="Implied margin"; }

      compute(); refreshInsights();
    }
    tabProfit?.addEventListener("click", ()=>setMode("profit"));
    tabReverse?.addEventListener("click", ()=>setMode("reverse"));
    tabBulk?.addEventListener("click", ()=>setMode("bulk"));

    function compute(){
      if (MODE==="profit") return computeProfit();
      if (MODE==="reverse") return computeReverse();
      return computeProfit();
    }

    // ---------------------------
    // Supabase RPC + access
    // ---------------------------
    let CURRENT_PROFILE = null;
    let CURRENT_USER = null;

    async function rpcEnsureProfile(){
      const { data, error } = await supabase.rpc("ensure_profile");
      if (error) throw new Error(error.message || "ensure_profile failed");
      return data;
    }
    async function rpcConsumeReverse(){
      const { data, error } = await supabase.rpc("consume_reverse_use", { p_limit: TRIAL_REVERSE_LIMIT });
      if (error) throw new Error(error.message || "consume_reverse_use failed");
      return data;
    }
    async function rpcConsumeComp(){
      const { data, error } = await supabase.rpc("consume_comp_use", { p_limit: TRIAL_COMP_LIMIT });
      if (error) throw new Error(error.message || "consume_comp_use failed");
      return data;
    }
    async function rpcConsumeBulk(){
      const { data, error } = await supabase.rpc("consume_bulk_run", { p_limit_per_day: TRIAL_BULK_RUNS_PER_DAY });
      if (error) throw new Error(error.message || "consume_bulk_run failed");
      return data;
    }

    function enableProUI(isPro){
      if (pdfBtn) pdfBtn.disabled = !isPro;
      if (shareBtn) shareBtn.disabled = !isPro;
      if (compStatus) compStatus.textContent = isPro ? "Unlocked" : "Trial limited";
      if (insStatus) insStatus.textContent = isPro ? "Unlocked" : "Locked";
      if (scenarioStatus) scenarioStatus.textContent = isPro ? "PRO enabled" : "Unlock PRO to save scenarios.";
      if (proCard) proCard.style.display = isPro ? "none" : "block";
    }

    function updateAccessUI(profile){
      CURRENT_PROFILE = profile;

      if (profile?.paid){
        if (!window.__ppProTracked) {
          window.__ppProTracked = true;
          track("pro_user_active");
        }
        if (accessPill){ accessPill.textContent = "Unlocked (PRO)"; accessPill.className = "pill ok"; }
        if (reverseUsesLine) reverseUsesLine.textContent = "Reverse uses: Unlimited (PRO)";
        if (compUsesLine) compUsesLine.textContent = "Competitor uses: Unlimited (PRO)";
        enableProUI(true);
        refreshBulkLimitLine();
        refreshInsights();
        refreshScenarioDropdown();
        return;
      }

      enableProUI(false);
      if (reverseUsesLine) reverseUsesLine.textContent = `Reverse uses: ${(profile?.reverse_uses ?? 0)}/${TRIAL_REVERSE_LIMIT} (Trial)`;
      if (compUsesLine) compUsesLine.textContent = `Competitor uses: ${(profile?.comp_uses ?? 0)}/${TRIAL_COMP_LIMIT} (Trial)`;

      const left = daysLeft(profile?.trial_start);
      if (accessPill){
        if (left > 0){
          accessPill.textContent = `Trial active • ${left} day(s) left`;
          accessPill.className = "pill warn";
        } else {
          accessPill.textContent = "Trial ended • PRO required";
          accessPill.className = "pill bad";
        }
      }

      refreshBulkLimitLine();
      refreshInsights();
      refreshScenarioDropdown();
    }

    function refreshBulkLimitLine(){
      if (!bulkLimitLine) return;
      if (!CURRENT_PROFILE){ bulkLimitLine.textContent = "Loading bulk limits…"; return; }
      if (CURRENT_PROFILE.paid){ bulkLimitLine.textContent = "PRO: unlimited rows • unlimited runs."; return; }

      const left = daysLeft(CURRENT_PROFILE.trial_start);
      if (left <= 0){ bulkLimitLine.textContent = "Trial ended. Unlock PRO to use Bulk mode."; return; }

      const day = todayKeyUTC();
      const usedToday = (CURRENT_PROFILE.bulk_day === day) ? Number(CURRENT_PROFILE.bulk_runs_today || 0) : 0;
      const runsLeft = Math.max(0, TRIAL_BULK_RUNS_PER_DAY - usedToday);
      bulkLimitLine.textContent = `Trial: max ${TRIAL_BULK_MAX_ROWS} rows • ${runsLeft}/${TRIAL_BULK_RUNS_PER_DAY} bulk run(s) left today.`;
    }

    // ---------------------------
    // Export / Share
    // ---------------------------
    function payload(){
      return {
        mode: MODE,
        currency: currencyEl?.value,
        fxRate: fxRateEl?.value || "",
        preset: presetSel?.value,
        sellPrice: sellPriceEl?.value,
        productCost: productCostEl?.value,
        shipCost: shipCostEl?.value,
        miscCost: miscCostEl?.value,
        feePct: feePctEl?.value,
        feeFixed: feeFixedEl?.value,
        adsPct: adsPctEl?.value,
        returnPct: returnPctEl?.value,
        targetProfit: targetProfitEl?.value,
        targetMargin: targetMarginInput?.value,
        c1: c1?.value, c2: c2?.value, c3: c3?.value,
        positioning: positioning?.value,
        floorBuffer: floorBuffer?.value
      };
    }

    document.getElementById("exportCsvBtn")?.addEventListener("click", ()=>{
      track("export_csv_clicked", { mode: MODE, pro: !!CURRENT_PROFILE?.paid });
      const p = payload();
      const rows = Object.entries(p).map(([k,v])=>[k,String(v ?? "")]);
      rows.unshift(["Field","Value"]);
      const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n");
      downloadText("profitpilot-export.csv", csv);
      if (shareStatus) shareStatus.textContent = "CSV exported.";
    });

    pdfBtn?.addEventListener("click", ()=>{
      track("export_pdf_clicked", { pro: !!CURRENT_PROFILE?.paid });
      if (!CURRENT_PROFILE?.paid){ if (shareStatus) shareStatus.textContent="PDF is PRO."; return; }
      if (shareStatus) shareStatus.textContent="Preparing PDF…";
      setTimeout(()=>window.print(), 150);
    });

    shareBtn?.addEventListener("click", ()=>{
      track("share_clicked", { pro: !!CURRENT_PROFILE?.paid });
      if (!CURRENT_PROFILE?.paid){ if (shareStatus) shareStatus.textContent="Share is PRO."; return; }
      const token = base64urlEncode(JSON.stringify(payload()));
      const url = `${location.origin}/share.html#s=${token}`;
      navigator.clipboard?.writeText(url).catch(()=>{});
      if (shareStatus) shareStatus.textContent="Share link copied.";
    });

    // Reset
    document.getElementById("resetBtn")?.addEventListener("click", ()=>{
      [sellPriceEl, productCostEl, shipCostEl, miscCostEl, feePctEl, feeFixedEl, adsPctEl, returnPctEl, targetProfitEl].filter(Boolean).forEach(el=>el.value="0");
      if (fxRateEl) fxRateEl.value = "";
      if (presetSel) presetSel.value = "manual";
      if (c1) c1.value = "0"; if (c2) c2.value = "0"; if (c3) c3.value = "0";
      if (positioning) positioning.value = "undercut";
      if (floorBuffer) floorBuffer.value = "5";
      if (shareStatus) shareStatus.textContent = "—";
      if (bulkPasteEl) bulkPasteEl.value = "";
      clearBulkRows();
      if (importBanner) importBanner.style.display = "none";
      if (targetMarginInput) targetMarginInput.value = "15";
      setMode("profit");
      refreshInsights();
      if (compToast) compToast.textContent = "—";
      if (scenarioToast) scenarioToast.textContent = "—";
    });

    // ---------------------------
    // INSIGHTS (PRO)
    // ---------------------------
    function solvePriceForMargin(targetMarginPct){
      const C = n(productCostEl?.value) + n(shipCostEl?.value) + n(miscCostEl?.value);
      const pctFees = (clamp(n(feePctEl?.value),0,99) + clamp(n(adsPctEl?.value),0,99))/100;
      const fixed = clamp(n(feeFixedEl?.value),0,999999);
      const m = clamp(targetMarginPct/100, -0.99, 0.95);
      const denom = (1 - pctFees) - m;
      if (denom <= 0.01) return null;
      return (C + fixed) / denom;
    }
    function solveBreakEvenPrice(){
      const C = n(productCostEl?.value) + n(shipCostEl?.value) + n(miscCostEl?.value);
      const pctFees = (clamp(n(feePctEl?.value),0,99) + clamp(n(adsPctEl?.value),0,99))/100;
      const fixed = clamp(n(feeFixedEl?.value),0,999999);
      const denom = 1 - pctFees;
      if (denom <= 0.01) return null;
      return (C + fixed) / denom;
    }
    function maxAffordableAdsPct(){
      const sell = n(sellPriceEl?.value);
      if (sell <= 0) return null;
      const C = n(productCostEl?.value) + n(shipCostEl?.value) + n(miscCostEl?.value);
      const feePct = clamp(n(feePctEl?.value),0,99);
      const feeFixed = clamp(n(feeFixedEl?.value),0,999999);
      const room = sell - (C + sell*(feePct/100) + feeFixed);
      const max = (room / sell) * 100;
      return clamp(max, 0, 99);
    }
    function riskAssessment(profit, margin, returnImpact, fees){
      const bullets = [];
      let label = "Balanced";
      let explain = "Looks workable based on your inputs.";
      if (profit < 0){
        label = "High risk"; explain = "Pricing below cost + fees.";
        bullets.push("You are losing money on this price. Raise price or reduce costs/fees.");
      } else if (margin < 5){
        label = "Thin margin"; explain = "Small shocks can wipe profit.";
        bullets.push("Margin is very thin. Any fee change, discount, or return can flip to loss.");
      } else if (margin < 10){
        label = "Tight"; explain = "Okay, but sensitive.";
        bullets.push("Margin is tight. Consider a minimum margin target (10–20%).");
      } else {
        bullets.push("Margin seems reasonable for many categories (still depends on your business).");
      }
      if (fees > Math.max(0, profit) * 2) bullets.push("Fees + ads consume a large share of profit. Watch promo spend.");
      if (returnImpact > Math.max(0, profit) * 0.7) bullets.push("Return sensitivity is high relative to profit. Consider buffer pricing or better QC.");
      return { label, explain, bullets };
    }

    function refreshInsights(){
      if (!insStatus || !bePriceEl || !targetMarginPriceEl || !maxAdsPctEl || !riskLabelEl || !riskExplainEl || !insBullets || !targetMarginInput || !targetMarginVal || !insToast) return;

      const isPro = !!CURRENT_PROFILE?.paid;

      const sell = n(sellPriceEl?.value);
      const C = n(productCostEl?.value) + n(shipCostEl?.value) + n(miscCostEl?.value);
      const feePct = clamp(n(feePctEl?.value),0,99);
      const feeFixed = clamp(n(feeFixedEl?.value),0,999999);
      const adsPct = clamp(n(adsPctEl?.value),0,99);
      const retPct = clamp(n(returnPctEl?.value),0,99);

      const fees = totalFees(sell, feePct, feeFixed, adsPct);
      const retImpact = sell * (retPct/100);
      const profit = sell - (C + fees);
      const margin = sell > 0 ? (profit/sell)*100 : 0;

      const targetM = clamp(n(targetMarginInput.value), 0, 80);
      targetMarginVal.textContent = targetM.toFixed(0) + "%";

      if (!isPro){
        bePriceEl.textContent = "—";
        targetMarginPriceEl.textContent = "—";
        maxAdsPctEl.textContent = "—";
        riskLabelEl.textContent = "Locked";
        riskExplainEl.textContent = "Unlock PRO to see insights.";
        insBullets.innerHTML = `
          <li>Break-even price</li>
          <li>Price to hit a target margin</li>
          <li>Max ads % you can afford</li>
          <li>Risk signals</li>
        `;
        insStatus.textContent = "Locked";
        insToast.textContent = "—";
        return;
      }

      insStatus.textContent = "Unlocked";

      const be = solveBreakEvenPrice();
      bePriceEl.textContent = (be && Number.isFinite(be)) ? money(be) : "—";

      const tm = solvePriceForMargin(targetM);
      targetMarginPriceEl.textContent = (tm && Number.isFinite(tm)) ? money(tm) : "—";

      const maxAds = maxAffordableAdsPct();
      maxAdsPctEl.textContent = (maxAds==null) ? "—" : maxAds.toFixed(1) + "%";

      const ra = riskAssessment(profit, margin, retImpact, fees);
      riskLabelEl.textContent = ra.label;
      riskExplainEl.textContent = ra.explain;

      const bullets = [];
      if (sell <= 0) bullets.push("Enter a selling price to get meaningful insights.");
      else {
        bullets.push(`Break-even is ~${(be && Number.isFinite(be)) ? money(be) : "—"} (profit ≈ 0).`);
        bullets.push(`To target ${targetM.toFixed(0)}% margin, price is ~${(tm && Number.isFinite(tm)) ? money(tm) : "—"}.`);
        if (maxAds != null) bullets.push(`Max ads spend before loss: ~${maxAds.toFixed(1)}% (at current price/cost).`);
        bullets.push(...ra.bullets);
      }
      insBullets.innerHTML = bullets.map(x=>`<li>${x}</li>`).join("");
      insToast.textContent = "Updated.";
    }

    refreshInsightsBtn?.addEventListener("click", ()=>{ refreshInsights(); if (insToast) insToast.textContent="Updated."; });
    targetMarginInput?.addEventListener("input", ()=>refreshInsights());

    // ---------------------------
    // Competitor mode
    // ---------------------------
    let LAST_COMP_SUGGEST = null;

    function median3(a,b,c){
      const arr=[a,b,c].filter(x=>x>0).sort((x,y)=>x-y);
      if (!arr.length) return null;
      const mid = Math.floor(arr.length/2);
      return arr[mid];
    }

    function runCompetitor(){
      const p1 = n(c1?.value), p2 = n(c2?.value), p3 = n(c3?.value);
      const med = median3(p1,p2,p3);
      if (!med) throw new Error("Enter at least 1 competitor price > 0.");

      const be = solveBreakEvenPrice();
      const buffer = clamp(n(floorBuffer?.value), 0, 80);
      const floor = (be && Number.isFinite(be)) ? (be * (1 + buffer/100)) : null;

      const pos = positioning?.value || "undercut";
      let suggested = med;
      let why = "Based on median of competitor inputs.";

      if (pos === "undercut"){
        suggested = med * 0.99;
        why = "Undercut slightly (~1%) to win clicks without racing to the bottom.";
      } else if (pos === "match"){
        suggested = med;
        why = "Match the market median for a balanced approach.";
      } else {
        suggested = med * 1.03;
        why = "Premium (~3%) only if your offer is clearly better (speed, bundle, trust).";
      }

      LAST_COMP_SUGGEST = suggested;
      if (useSuggestedBtn) useSuggestedBtn.disabled = false;

      if (compMedian) compMedian.textContent = money(med);
      if (compSuggest) compSuggest.textContent = money(suggested);
      if (compWhy) compWhy.textContent = why;
      if (compFloor) compFloor.textContent = floor ? money(floor) : "—";

      if (compCheck && compCheck2){
        if (floor && suggested < floor){
          compCheck.textContent = "Warning";
          compCheck.className = "bad";
          compCheck2.textContent = "Competitor market is below your safe floor. Reduce costs/fees or avoid this listing.";
        } else {
          compCheck.textContent = "Looks viable";
          compCheck.className = "good";
          compCheck2.textContent = "Suggested price stays above the safe floor (based on your inputs).";
        }
      }

      if (compBullets){
        const bullets = [];
        if (floor) bullets.push(`Floor price = break-even + ${buffer.toFixed(0)}% buffer → ${money(floor)}.`);
        bullets.push("If competitors are below your floor: don’t chase them. Fix costs or pick another product.");
        bullets.push("No scraping: you manually enter prices you found yourself.");
        compBullets.innerHTML = bullets.map(x=>`<li>${x}</li>`).join("");
      }
    }

    runCompBtn?.addEventListener("click", async ()=>{
      track("competitor_run_clicked", { pro: !!CURRENT_PROFILE?.paid });
      if (compToast) compToast.textContent = "Running…";
      try{
        if (!CURRENT_PROFILE) throw new Error("Loading… try again in 2 seconds.");

        if (!CURRENT_PROFILE.paid){
          const left = daysLeft(CURRENT_PROFILE.trial_start);
          if (left <= 0) throw new Error("Trial ended. Unlock PRO to use competitor mode.");
          const prof = await rpcConsumeComp();
          updateAccessUI(prof);
        }

        computeProfit();
        refreshInsights();
        runCompetitor();

        if (compStatus) compStatus.textContent = CURRENT_PROFILE.paid ? "Unlocked" : "Trial limited";
        if (compToast) compToast.textContent = "Done.";
        if (scenarioToast) scenarioToast.textContent = "Tip: click “Use suggested price” to apply.";
      } catch(e){
        if (compToast) compToast.textContent = e?.message || "Failed.";
      }
    });

    useSuggestedBtn?.addEventListener("click", ()=>{
      if (!LAST_COMP_SUGGEST || !Number.isFinite(LAST_COMP_SUGGEST)){
        if (scenarioToast) scenarioToast.textContent = "Run competitor mode first.";
        return;
      }
      if (sellPriceEl) sellPriceEl.value = LAST_COMP_SUGGEST.toFixed(2);
      setMode("profit");
      computeProfit();
      refreshInsights();
      if (scenarioToast) scenarioToast.textContent = "Applied suggested price ✅";
    });

    // ---------------------------
    // Scenario storage (PRO) localStorage
    // ---------------------------
    function scenarioKey(){ return `pp_scenarios_${CURRENT_USER?.id || "anon"}`; }
    function loadScenarios(){
      try{
        const raw = localStorage.getItem(scenarioKey());
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch { return []; }
    }
    function saveScenarios(arr){
      localStorage.setItem(scenarioKey(), JSON.stringify(arr));
    }
    function refreshScenarioDropdown(){
      if (!scenarioSel) return;
      scenarioSel.innerHTML = `<option value="">—</option>`;
      if (!CURRENT_USER) return;
      const arr = loadScenarios();
      arr.forEach((s, idx)=>{
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = s.name || `Scenario #${idx+1}`;
        scenarioSel.appendChild(opt);
      });
      if (scenarioStatus) scenarioStatus.textContent = CURRENT_PROFILE?.paid ? `${arr.length} saved` : "PRO required to save";
    }

    function currentScenarioPayload(){
      return {
        name: scenarioName?.value.trim() || "",
        created_at: new Date().toISOString(),
        suggested_price: (LAST_COMP_SUGGEST && Number.isFinite(LAST_COMP_SUGGEST)) ? Number(LAST_COMP_SUGGEST.toFixed(2)) : null,
        data: payload()
      };
    }

    function doSaveScenario(){
      if (!CURRENT_PROFILE?.paid){
        if (scenarioToast) scenarioToast.textContent = "Saving scenarios is PRO.";
        if (scenarioStatus) scenarioStatus.textContent = "Unlock PRO to save.";
        return;
      }
      const name = (scenarioName?.value || "").trim();
      if (!name){
        if (scenarioToast) scenarioToast.textContent = "Write a scenario name first.";
        return;
      }
      const arr = loadScenarios();
      if (arr.length >= 50) arr.shift();
      arr.push(currentScenarioPayload());
      saveScenarios(arr);
      refreshScenarioDropdown();
      if (scenarioToast) scenarioToast.textContent = "Scenario saved ✅";
      if (scenarioStatus) scenarioStatus.textContent = "Saved.";
    }

    saveScenarioBtn?.addEventListener("click", doSaveScenario);
    saveScenarioBtn2?.addEventListener("click", doSaveScenario);

    loadScenarioBtn?.addEventListener("click", ()=>{
      const idx = Number(scenarioSel?.value);
      const arr = loadScenarios();
      const s = arr[idx];
      if (!s){ if (scenarioStatus) scenarioStatus.textContent = "Choose a scenario."; return; }
      const d = s.data || {};
      if (d.currency && currencyEl) currencyEl.value = d.currency;
      if (fxRateEl) fxRateEl.value = d.fxRate || "";
      if (presetSel) presetSel.value = d.preset || "manual";
      if (sellPriceEl) sellPriceEl.value = String(d.sellPrice ?? "0");
      if (productCostEl) productCostEl.value = String(d.productCost ?? "0");
      if (shipCostEl) shipCostEl.value = String(d.shipCost ?? "0");
      if (miscCostEl) miscCostEl.value = String(d.miscCost ?? "0");
      if (feePctEl) feePctEl.value = String(d.feePct ?? "0");
      if (feeFixedEl) feeFixedEl.value = String(d.feeFixed ?? "0");
      if (adsPctEl) adsPctEl.value = String(d.adsPct ?? "0");
      if (returnPctEl) returnPctEl.value = String(d.returnPct ?? "0");
      if (targetProfitEl) targetProfitEl.value = String(d.targetProfit ?? "0");
      if (targetMarginInput) targetMarginInput.value = String(d.targetMargin ?? "15");
      if (c1) c1.value = String(d.c1 ?? "0");
      if (c2) c2.value = String(d.c2 ?? "0");
      if (c3) c3.value = String(d.c3 ?? "0");
      if (positioning) positioning.value = String(d.positioning ?? "undercut");
      if (floorBuffer) floorBuffer.value = String(d.floorBuffer ?? "5");
      LAST_COMP_SUGGEST = (s.suggested_price != null) ? Number(s.suggested_price) : null;
      if (useSuggestedBtn) useSuggestedBtn.disabled = !(LAST_COMP_SUGGEST && Number.isFinite(LAST_COMP_SUGGEST));
      setMode(d.mode || "profit");
      computeProfit();
      refreshInsights();
      if (scenarioStatus) scenarioStatus.textContent = "Loaded ✅";
      if (scenarioToast) scenarioToast.textContent = "Scenario loaded.";
    });

    deleteScenarioBtn?.addEventListener("click", ()=>{
      const idx = Number(scenarioSel?.value);
      const arr = loadScenarios();
      if (!arr[idx]){ if (scenarioStatus) scenarioStatus.textContent="Choose a scenario."; return; }
      arr.splice(idx,1);
      saveScenarios(arr);
      refreshScenarioDropdown();
      if (scenarioStatus) scenarioStatus.textContent="Deleted.";
      if (scenarioToast) scenarioToast.textContent="Scenario deleted.";
    });

    // ---------------------------
    // BULK
    // ---------------------------
    let bulkLastRows = [];

    function mkCellInput(value="0"){
      const inp = document.createElement("input");
      inp.className = "mini";
      inp.inputMode = "decimal";
      inp.value = String(value ?? "0");
      autoZero(inp);
      return inp;
    }

    function renumberBulkRows(){
      if (!bulkTbody) return;
      [...bulkTbody.children].forEach((tr,i)=> tr.children[0].textContent = String(i+1));
    }
    function rowCount(){ return bulkTbody ? bulkTbody.children.length : 0; }
    function canAddRow(){
      if (!CURRENT_PROFILE) return false;
      if (CURRENT_PROFILE.paid) return true;
      return rowCount() < TRIAL_BULK_MAX_ROWS;
    }

    function computeRow(sell,cost,ship,misc,feePct,feeFixed,adsPct,returnPct){
      const fees = sell*(feePct/100) + feeFixed + sell*(adsPct/100);
      const profit = sell - (cost+ship+misc+fees);
      const margin = sell>0 ? (profit/sell)*100 : 0;
      return { profit, margin, fees };
    }

    function previewRow(tr){
      if (!tr?._pp) return;
      const r = tr._pp;
      const sell = n(r.sell.value);
      const cost = n(r.cost.value);
      const ship = n(r.ship.value);
      const misc = n(r.misc.value);
      const feePct = clamp(n(r.feePct.value),0,99);
      const feeFixed = clamp(n(r.feeFixed.value),0,999999);
      const adsPct = clamp(n(r.adsPct.value),0,99);
      const retPct = clamp(n(r.retPct.value),0,99);

      const res = computeRow(sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct);
      r.profitTd.textContent = money(res.profit);
      r.profitTd.className = res.profit >= 0 ? "good" : "bad";
      r.marginTd.textContent = pct(res.margin);
      r.marginTd.className = res.margin >= 10 ? "good" : (res.margin < 0 ? "bad" : "");
    }

    function addBulkRow(initial={}){
      if (!bulkTbody) return;

      const tr = document.createElement("tr");
      const idxTd = document.createElement("td");
      idxTd.textContent = String(rowCount() + 1);
      tr.appendChild(idxTd);

      const sell = mkCellInput(initial.sell ?? "0");
      const cost = mkCellInput(initial.cost ?? "0");
      const ship = mkCellInput(initial.ship ?? "0");
      const misc = mkCellInput(initial.misc ?? "0");
      const feePct = mkCellInput(initial.feePct ?? feePctEl?.value);
      const feeFixed = mkCellInput(initial.feeFixed ?? feeFixedEl?.value);
      const adsPct = mkCellInput(initial.adsPct ?? adsPctEl?.value);
      const retPct = mkCellInput(initial.returnPct ?? returnPctEl?.value);

      [sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct].forEach(inp=>{
        const td = document.createElement("td");
        td.appendChild(inp);
        tr.appendChild(td);
        inp.addEventListener("input", ()=> previewRow(tr));
      });

      const profitTd = document.createElement("td"); profitTd.textContent = "—"; tr.appendChild(profitTd);
      const marginTd = document.createElement("td"); marginTd.textContent = "—"; tr.appendChild(marginTd);

      const actTd = document.createElement("td");
      const delBtn = document.createElement("button");
      delBtn.className = "btn";
      delBtn.type = "button";
      delBtn.textContent = "Remove";
      delBtn.onclick = ()=>{
        tr.remove();
        renumberBulkRows();
        if (bulkStatus) bulkStatus.textContent = "Row removed.";
        refreshBulkLimitLine();
      };
      actTd.appendChild(delBtn);
      tr.appendChild(actTd);

      tr._pp = { sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct, profitTd, marginTd };
      bulkTbody.appendChild(tr);
      renumberBulkRows();
      previewRow(tr);
    }

    function clearBulkRows(){
      if (!bulkTbody) return;
      bulkTbody.innerHTML = "";
      bulkLastRows = [];
      if (bulkStatus) bulkStatus.textContent = "—";
      refreshBulkLimitLine();
    }

    function applyFeesToAll(){
      if (!bulkTbody) return;
      [...bulkTbody.children].forEach(tr=>{
        const r = tr._pp;
        r.feePct.value = feePctEl?.value ?? "0";
        r.feeFixed.value = feeFixedEl?.value ?? "0";
        r.adsPct.value = adsPctEl?.value ?? "0";
        r.retPct.value = returnPctEl?.value ?? "0";
        previewRow(tr);
      });
      if (bulkStatus) bulkStatus.textContent = "Applied current fees to all rows.";
    }

    bulkAddRowBtn?.addEventListener("click", ()=>{
      if (!CURRENT_PROFILE){ if (bulkStatus) bulkStatus.textContent="Loading…"; return; }
      if (!canAddRow()){
        if (bulkStatus) bulkStatus.textContent = `Trial limit: max ${TRIAL_BULK_MAX_ROWS} rows. Unlock PRO for unlimited.`;
        return;
      }
      addBulkRow();
      if (bulkStatus) bulkStatus.textContent = "Row added.";
      refreshBulkLimitLine();
    });

    bulkClearBtn?.addEventListener("click", ()=>{
      clearBulkRows();
      const initial = CURRENT_PROFILE?.paid ? 5 : TRIAL_BULK_MAX_ROWS;
      for (let i=0;i<initial;i++) addBulkRow();
      if (bulkStatus) bulkStatus.textContent = "Reset rows.";
    });

    bulkApplyFeesBtn?.addEventListener("click", ()=>applyFeesToAll());

    bulkRunBtn?.addEventListener("click", async ()=>{
      track("bulk_run_clicked", { pro: !!CURRENT_PROFILE?.paid, rows: rowCount() });
      try{
        if (!CURRENT_PROFILE){ if (bulkStatus) bulkStatus.textContent="Loading…"; return; }

        if (!CURRENT_PROFILE.paid){
          const left = daysLeft(CURRENT_PROFILE.trial_start);
          if (left <= 0) throw new Error("Trial ended. Unlock PRO to use Bulk mode.");
          if (rowCount() > TRIAL_BULK_MAX_ROWS) throw new Error(`Trial allows max ${TRIAL_BULK_MAX_ROWS} rows.`);
          const prof = await rpcConsumeBulk();
          updateAccessUI(prof);
        }

        const trs = bulkTbody ? [...bulkTbody.children] : [];
        if (!trs.length) throw new Error("Add at least 1 row.");

        const out = [];
        trs.forEach(tr=>{
          const r = tr._pp;
          const sell = n(r.sell.value);
          const cost = n(r.cost.value);
          const ship = n(r.ship.value);
          const misc = n(r.misc.value);
          const feePct = clamp(n(r.feePct.value),0,99);
          const feeFixed = clamp(n(r.feeFixed.value),0,999999);
          const adsPct = clamp(n(r.adsPct.value),0,99);
          const retPct = clamp(n(r.retPct.value),0,99);

          const res = computeRow(sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct);
          r.profitTd.textContent = money(res.profit);
          r.profitTd.className = res.profit >= 0 ? "good" : "bad";
          r.marginTd.textContent = pct(res.margin);
          r.marginTd.className = res.margin >= 10 ? "good" : (res.margin < 0 ? "bad" : "");

          out.push({ sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct, fees:res.fees, profit:res.profit, margin:res.margin });
        });

        bulkLastRows = out;
        if (bulkStatus) bulkStatus.textContent = `Processed ${out.length} row(s).`;
        refreshBulkLimitLine();
      } catch(e){
        if (bulkStatus) bulkStatus.textContent = e?.message || "Bulk failed.";
        refreshBulkLimitLine();
      }
    });

    bulkExportBtn?.addEventListener("click", ()=>{
      if (!bulkLastRows.length){ if (bulkStatus) bulkStatus.textContent = "Run bulk first."; return; }
      const rows = [["sell","cost","ship","misc","feePct","feeFixed","adsPct","returnPct","fees","profit","margin"]];
      bulkLastRows.forEach(r=> rows.push([r.sell,r.cost,r.ship,r.misc,r.feePct,r.feeFixed,r.adsPct,r.returnPct,r.fees,r.profit,r.margin]));
      const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n");
      downloadText("profitpilot-bulk.csv", csv);
      if (bulkStatus) bulkStatus.textContent = "Bulk CSV exported.";
    });

    function parseLines(text){
      const lines = String(text || "").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      const rows = [];
      for (const line of lines){
        const parts = line.includes("\t") ? line.split("\t") : line.split(",");
        const p = parts.map(x=>x.trim()).filter(x=>x.length>0);
        if (p.length < 2) continue;
        rows.push({
          sell: p[0] ?? "0",
          cost: p[1] ?? "0",
          ship: p[2] ?? "0",
          misc: p[3] ?? "0",
          feePct: p[4] ?? (feePctEl?.value ?? "0"),
          feeFixed: p[5] ?? (feeFixedEl?.value ?? "0"),
          adsPct: p[6] ?? (adsPctEl?.value ?? "0"),
          returnPct: p[7] ?? (returnPctEl?.value ?? "0")
        });
      }
      return rows;
    }

    bulkFillExampleBtn?.addEventListener("click", ()=>{
      if (bulkPasteEl) bulkPasteEl.value = "12.99, 6.20, 0.00, 0.20\n19.99, 9.50, 0.00, 0.30\n29.99, 14.00, 0.00, 0.50";
      if (bulkImportStatus) bulkImportStatus.textContent = "Example filled.";
    });

    bulkImportBtn?.addEventListener("click", ()=>{
      if (bulkImportStatus) bulkImportStatus.textContent = "Importing…";
      const rows = parseLines(bulkPasteEl?.value || "");
      if (!rows.length){ if (bulkImportStatus) bulkImportStatus.textContent = "Nothing to import."; return; }
      const allowed = (CURRENT_PROFILE?.paid) ? rows.length : Math.min(rows.length, TRIAL_BULK_MAX_ROWS);
      clearBulkRows();
      for (let i=0;i<allowed;i++) addBulkRow(rows[i]);
      if (bulkImportStatus){
        bulkImportStatus.textContent = (!CURRENT_PROFILE?.paid && rows.length > allowed)
          ? `Imported ${allowed}. Trial limit is ${TRIAL_BULK_MAX_ROWS} rows.`
          : `Imported ${allowed} row(s).`;
      }
      if (bulkStatus) bulkStatus.textContent = "Review values, then Run bulk.";
      refreshBulkLimitLine();
    });

    // ---------------------------
    // Reviews (1 per user, editable)
    // ---------------------------
    let selectedStars = 5;
    const starsRow = document.getElementById("starsRow");
    const reviewStatus = document.getElementById("reviewStatus");

    function setStars(nv){
      selectedStars = nv;
      if (!starsRow) return;
      [...starsRow.querySelectorAll("button")].forEach(b=>{
        b.style.borderColor = (parseInt(b.dataset.star,10)===nv) ? "rgba(14,165,164,.45)" : "rgba(16,24,40,.10)";
        b.style.background = (parseInt(b.dataset.star,10)===nv) ? "rgba(14,165,164,.10)" : "rgba(255,255,255,.80)";
      });
    }
    setStars(5);

    starsRow?.addEventListener("click",(e)=>{
      const btn=e.target.closest("button"); if(!btn) return;
      setStars(parseInt(btn.dataset.star,10));
    });

    async function getUserReview(userId){
      const { data, error } = await supabase
        .from("reviews")
        .select("id, rating, category, message, name")
        .eq("user_id", userId)
        .limit(1);
      if (error) throw error;
      return (data && data[0]) ? data[0] : null;
    }

    document.getElementById("sendReview")?.addEventListener("click", async ()=>{
      track("review_submit_clicked", { pro: !!CURRENT_PROFILE?.paid, stars: selectedStars });
      if (reviewStatus) reviewStatus.textContent="Submitting…";
      try{
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) throw new Error("Please log in again.");

        const name = document.getElementById("revName")?.value.trim() || "";
        const category = document.getElementById("revCat")?.value || "General";
        const message = document.getElementById("revMsg")?.value.trim() || "";
        if (!message) throw new Error("Write a short review message.");

        const existing = await getUserReview(user.id);

        if (existing){
          const { error } = await supabase
            .from("reviews")
            .update({ name: name || null, rating: selectedStars, category, message, approved: true })
            .eq("id", existing.id);
          if (error) throw error;
          if (reviewStatus) reviewStatus.textContent="Updated ✅ Your review is public.";
        } else {
          const { error } = await supabase.from("reviews").insert([{
            user_id:user.id, name:name||null, rating:selectedStars, category, message, approved:true
          }]);
          if (error) throw error;
          if (reviewStatus) reviewStatus.textContent="Thanks ✅ Your review is public.";
        }
      } catch(e){
        if (reviewStatus) reviewStatus.textContent=e?.message||"Failed.";
      }
    });

    // Logout
    document.getElementById("logoutBtn")?.addEventListener("click", async ()=>{
      track("logout_clicked", { pro: !!CURRENT_PROFILE?.paid });
      await supabase.auth.signOut();
      location.href = "login.html";
    });

    // Buy button tracking
    document.getElementById("buyProBtn")?.addEventListener("click", () => track("buy_pro_clicked"));

    // ---------------------------
    // Share import
    // ---------------------------
    function tryImportFromHash(){
      const h = location.hash || "";
      const m = h.match(/[#&](?:s|import)=([^&]+)/);
      if (!m) return;
      try{
        const token = decodeURIComponent(m[1]);
        const jsonStr = base64urlDecodeToString(token);
        const data = JSON.parse(jsonStr);

        if (data.currency && currencyEl) currencyEl.value = data.currency;
        if (fxRateEl) fxRateEl.value = data.fxRate || "";
        if (presetSel) presetSel.value = data.preset || "manual";
        if (sellPriceEl) sellPriceEl.value = String(data.sellPrice ?? "0");
        if (productCostEl) productCostEl.value = String(data.productCost ?? "0");
        if (shipCostEl) shipCostEl.value = String(data.shipCost ?? "0");
        if (miscCostEl) miscCostEl.value = String(data.miscCost ?? "0");
        if (feePctEl) feePctEl.value = String(data.feePct ?? "0");
        if (feeFixedEl) feeFixedEl.value = String(data.feeFixed ?? "0");
        if (adsPctEl) adsPctEl.value = String(data.adsPct ?? "0");
        if (returnPctEl) returnPctEl.value = String(data.returnPct ?? "0");
        if (targetProfitEl) targetProfitEl.value = String(data.targetProfit ?? "0");
        if (targetMarginInput) targetMarginInput.value = String(data.targetMargin ?? "15");
        if (c1) c1.value = String(data.c1 ?? "0");
        if (c2) c2.value = String(data.c2 ?? "0");
        if (c3) c3.value = String(data.c3 ?? "0");
        if (positioning) positioning.value = String(data.positioning ?? "undercut");
        if (floorBuffer) floorBuffer.value = String(data.floorBuffer ?? "5");

        if (importBanner){
          importBanner.style.display = "block";
          importBanner.textContent = "Imported shared calculation ✅";
          setTimeout(()=>{ importBanner.style.display = "none"; }, 5000);
        }
      } catch(e){
        if (importBanner){
          importBanner.style.display = "block";
          importBanner.textContent = "Import failed (invalid link).";
          setTimeout(()=>{ importBanner.style.display = "none"; }, 7000);
        }
      }
      history.replaceState(null, "", location.pathname);
    }

    // Live compute updates
    [
      sellPriceEl, productCostEl, shipCostEl, miscCostEl,
      feePctEl, feeFixedEl, adsPctEl, returnPctEl,
      fxRateEl, currencyEl
    ].filter(Boolean).forEach(el=> el.addEventListener("input", ()=>{ computeProfit(); refreshInsights(); }));

    async function computeReverseWithLimit(){
      if (!CURRENT_PROFILE?.paid){
        const left = daysLeft(CURRENT_PROFILE.trial_start);
        if (left <= 0) throw new Error("Trial ended. Unlock PRO for Reverse mode.");
        const prof = await rpcConsumeReverse();
        updateAccessUI(prof);
      }
      computeReverse();
      refreshInsights();
    }

    document.getElementById("calcBtn")?.addEventListener("click", async ()=>{
      track("calc_clicked", { mode: MODE, pro: !!CURRENT_PROFILE?.paid });
      try{
        if (o1hint) o1hint.style.color = "";
        if (MODE==="reverse") await computeReverseWithLimit();
        else { computeProfit(); refreshInsights(); }
      } catch(e){
        if (o1hint){
          o1hint.textContent = e?.message || "Error.";
          o1hint.style.color = "var(--bad)";
        }
      }
    });

    // ---------------------------
    // Boot (session-safe, no redirect loop)
    // ---------------------------
    (async ()=>{
      try{
        if (accessPill) accessPill.textContent = "Checking session…";

        const wait = (ms)=>new Promise(r=>setTimeout(r, ms));
        let session = null;
        let user = null;

        // Give Supabase time to hydrate session from storage
        for (let i = 0; i < 8; i++){
          const sRes = await supabase.auth.getSession();
          session = sRes?.data?.session || null;

          const uRes = await supabase.auth.getUser();
          user = uRes?.data?.user || null;

          if (session && user) break;
          await wait(300);
        }

        if (!session || !user){
          console.warn("No valid session found. Redirecting.");
          location.href = "login.html";
          return;
        }

        CURRENT_USER = user;

        // Never expose email
        const accountLink = document.getElementById("accountLink");
        if (accountLink) accountLink.textContent = "Account";

        const prof = await rpcEnsureProfile();
        updateAccessUI(prof);

        // Init bulk rows
        clearBulkRows();
        const initialRows = prof.paid ? 5 : TRIAL_BULK_MAX_ROWS;
        for (let i=0; i<initialRows; i++) addBulkRow();

        setMode("profit");
        computeProfit();
        refreshInsights();
        refreshScenarioDropdown();
        if (useSuggestedBtn) useSuggestedBtn.disabled = true;

        tryImportFromHash();

      } catch(e){
        console.error("BOOT ERROR:", e);
        if (accessPill){
          accessPill.textContent = "Access check failed";
          accessPill.className = "pill bad";
        }
      }
    })();
  </script>
</body>
</html>
