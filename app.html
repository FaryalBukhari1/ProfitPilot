<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ProfitPilot — App</title>
  <meta name="description" content="ProfitPilot helps sellers estimate profit, margin, fee drag, return sensitivity, reverse-price for target profit, export & share scenarios.">
  <link rel="icon" href="https://ukwebtools.com/favicon.svg" type="image/svg+xml">

  <style>
    :root{
      --bg:#f6f8fb;
      --bg2:#eef2ff;
      --card:#ffffff;
      --txt:#0b1220;
      --muted:#5b6474;
      --line:rgba(16,24,40,.10);
      --accent:#0ea5a4;
      --accent2:#4f46e5;
      --shadow:0 10px 30px rgba(16,24,40,.08);
      --warn:#f59e0b;
      --bad:#ef4444;
      --ok:#0ea5a4;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--txt);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(14,165,164,.16), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(79,70,229,.12), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg));
    }
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    .nav{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg, rgba(14,165,164,.18), rgba(79,70,229,.14));
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
    }
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.70);
      font-size:12px;color:var(--muted);
      display:inline-flex;gap:8px;align-items:center
    }
    .pill.ok{border-color:rgba(14,165,164,.30);background:rgba(14,165,164,.10);color:var(--txt)}
    .pill.warn{border-color:rgba(245,158,11,.30);background:rgba(245,158,11,.10);color:var(--txt)}
    .pill.bad{border-color:rgba(239,68,68,.30);background:rgba(239,68,68,.10);color:var(--txt)}

    .btn{
      padding:10px 14px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      color:var(--txt);
      display:inline-flex;gap:8px;align-items:center;
      cursor:pointer;
      box-shadow:0 4px 16px rgba(16,24,40,.06);
      user-select:none;
    }
    .btn.primary{border-color:rgba(14,165,164,.30);background:rgba(14,165,164,.10)}
    .btn.ghost{background:transparent;box-shadow:none}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:rgba(255,255,255,.82);
      border:1px solid var(--line);
      border-radius:18px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .title{font-weight:900;margin:0 0 8px}
    .small{font-size:12px;color:var(--muted);line-height:1.6}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:560px){.row{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.88);
      color:var(--txt);
      outline:none;
    }
    input:focus,select:focus{border-color:rgba(14,165,164,.35)}

    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:560px){.kpi{grid-template-columns:1fr}}
    .k{
      border:1px solid var(--line);
      background:rgba(255,255,255,.65);
      border-radius:16px;
      padding:12px;
    }
    .k .h{font-size:12px;color:var(--muted)}
    .k .v{font-size:20px;font-weight:900;margin-top:6px}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .hint{font-size:12px;color:var(--muted)}
    footer{margin:14px 2px 0;color:var(--muted);font-size:12px;line-height:1.6}

    .overlay{
      position:fixed;inset:0;
      background:rgba(16,24,40,.42);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:999;
    }
    .modal{
      width:min(760px,100%);
      background:rgba(255,255,255,.90);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .modal h2{margin:0 0 8px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media(max-width:840px){.two{grid-template-columns:1fr}}

    .stars button{
      border:1px solid var(--line);
      background:rgba(255,255,255,.75);
      color:var(--txt);
      border-radius:999px;
      padding:8px 10px;
      cursor:pointer;
      user-select:none;
    }
    .stars button.active{
      border-color:rgba(14,165,164,.35);
      background:rgba(14,165,164,.10);
    }
    .toast{margin-top:10px;font-size:12px;color:var(--muted)}

    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.70);cursor:pointer;font-size:12px;user-select:none}
    .tab.active{border-color:rgba(14,165,164,.35);background:rgba(14,165,164,.10);font-weight:900}
  </style>
</head>

<body>
<div class="wrap">

  <div class="nav">
    <div class="brand">
      <div class="logo">PP</div>
      <div>
        <div style="font-weight:900">ProfitPilot</div>
        <div class="pill">Estimates only • Independent tool</div>
      </div>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <a class="btn ghost" href="https://ukwebtools.com/">← Ukwebtools</a>
      <a class="btn ghost" href="index.html">Home</a>
      <a class="btn ghost" href="reviews.html">Reviews</a>
      <span class="pill" id="accessPill">Checking access…</span>
      <button class="btn" id="logoutBtn">Log out</button>
    </div>
  </div>

  <div class="grid">

    <!-- CALCULATOR -->
    <div class="card">
      <div class="title">Calculator</div>
      <div class="small">Profit mode = normal calculation. Reverse mode = enter target profit and we estimate the required selling price.</div>

      <div class="tabs">
        <div class="tab active" id="tabProfit">Profit mode</div>
        <div class="tab" id="tabReverse">Reverse mode</div>
      </div>

      <div class="divider"></div>

      <!-- Currency -->
      <div class="title" style="margin:0 0 6px;font-size:14px">Currency</div>
      <div class="small">Pick a display currency. Optional exchange rate for your own conversion (we don’t provide live FX rates).</div>

      <div class="row">
        <div>
          <label>Display currency</label>
          <select id="currency">
            <option value="GBP">GBP (£) — British Pound</option>
            <option value="USD">USD ($) — US Dollar</option>
            <option value="EUR">EUR (€) — Euro</option>
            <option value="AUD">AUD ($) — Australian Dollar</option>
            <option value="CAD">CAD ($) — Canadian Dollar</option>
            <option value="NZD">NZD ($) — New Zealand Dollar</option>
            <option value="AED">AED — UAE Dirham</option>
            <option value="SAR">SAR — Saudi Riyal</option>
            <option value="PKR">PKR (₨) — Pakistani Rupee</option>
            <option value="INR">INR (₹) — Indian Rupee</option>
            <option value="TRY">TRY (₺) — Turkish Lira</option>
            <option value="ZAR">ZAR (R) — South African Rand</option>
            <option value="NGN">NGN (₦) — Nigerian Naira</option>
            <option value="BDT">BDT (৳) — Bangladeshi Taka</option>
            <option value="LKR">LKR (Rs) — Sri Lankan Rupee</option>
          </select>
        </div>
        <div>
          <label>Exchange rate (optional)</label>
          <input id="fxRate" inputmode="decimal" placeholder="e.g., 1 base = 1.25 selected">
        </div>
      </div>

      <div class="divider"></div>

      <label>Platform preset</label>
      <select id="preset">
        <option value="manual">Manual (enter fees yourself)</option>
      </select>

      <div class="row">
        <div>
          <label>Selling price</label>
          <input id="sellPrice" inputmode="decimal" placeholder="0.00" value="0">
        </div>
        <div>
          <label>Product cost</label>
          <input id="productCost" inputmode="decimal" placeholder="0.00" value="0">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Shipping cost</label>
          <input id="shipCost" inputmode="decimal" placeholder="0.00" value="0">
        </div>
        <div>
          <label>Packaging / misc cost</label>
          <input id="miscCost" inputmode="decimal" placeholder="0.00" value="0">
        </div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div>
          <label>Platform fee (%)</label>
          <input id="feePct" inputmode="decimal" placeholder="e.g., 12.8" value="0">
        </div>
        <div>
          <label>Fixed fee (per order)</label>
          <input id="feeFixed" inputmode="decimal" placeholder="0.00" value="0">
        </div>
      </div>

      <div class="row">
        <div>
          <label>Ads / promo cost (%)</label>
          <input id="adsPct" inputmode="decimal" placeholder="e.g., 3" value="0">
        </div>
        <div>
          <label>Return rate (%)</label>
          <input id="returnPct" inputmode="decimal" placeholder="e.g., 5" value="0">
        </div>
      </div>

      <div id="reverseBox" style="display:none">
        <div class="divider"></div>
        <div class="title" style="margin:0 0 6px;font-size:14px">Reverse mode</div>
        <div class="small">Trial can run reverse mode 3 times total. PRO unlimited.</div>
        <label>Target profit</label>
        <input id="targetProfit" inputmode="decimal" placeholder="e.g., 5.00" value="0">
        <div class="small" id="reverseUsesLine" style="margin-top:8px">Reverse uses: —</div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn primary" id="calcBtn">Calculate</button>
        <button class="btn" id="resetBtn">Reset to 0</button>
      </div>

      <!-- Export/Share -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn" id="exportCsvBtn">Export CSV</button>
        <button class="btn" id="exportPdfBtn">Export PDF</button>
        <button class="btn" id="shareBtn">Share link</button>
        <span class="pill" id="shareStatus">—</span>
      </div>

      <div class="kpi">
        <div class="k">
          <div class="h" id="o1h">Estimated profit</div>
          <div class="v" id="o1v">£0.00</div>
          <div class="hint" id="o1hint">—</div>
        </div>
        <div class="k">
          <div class="h" id="o2h">Margin</div>
          <div class="v" id="o2v">0.0%</div>
          <div class="hint" id="o2hint">—</div>
        </div>
      </div>

      <div class="kpi">
        <div class="k">
          <div class="h">Total fees + ads</div>
          <div class="v" id="feesOut">£0.00</div>
          <div class="hint">Platform fee + fixed fee + ad %</div>
        </div>
        <div class="k">
          <div class="h">Return sensitivity (expected)</div>
          <div class="v" id="returnOut">£0.00</div>
          <div class="hint">Expected impact based on return rate</div>
        </div>
      </div>

      <div class="kpi" id="fxRow" style="display:none">
        <div class="k" style="grid-column:1 / -1">
          <div class="h">Converted selling price (your FX)</div>
          <div class="v" id="fxOut">—</div>
          <div class="hint" id="fxNote">—</div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="small">
        <b>Disclaimer:</b> Estimates only, not financial/legal/tax advice. Not affiliated with any platform.
        FX conversion depends on the exchange rate you enter (no live rates).
        See <a href="https://ukwebtools.com/terms.html">Terms</a> and <a href="https://ukwebtools.com/privacy.html">Privacy</a>.
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="card">
      <div class="title">Your workspace</div>
      <div class="small" id="userLine">Loading account…</div>

      <div class="divider"></div>

      <div class="title" style="margin:0 0 6px">Leave a review</div>
      <div class="small">Reviews publish immediately. Spam/abuse may be removed.</div>

      <label>Name (optional)</label>
      <input id="revName" placeholder="Name">

      <label>Category</label>
      <select id="revCat">
        <option>General</option>
        <option>UI/UX</option>
        <option>Accuracy</option>
        <option>Speed</option>
        <option>Features</option>
      </select>

      <label>Rating</label>
      <div class="stars" style="display:flex;gap:8px;flex-wrap:wrap" id="starsRow">
        <button type="button" data-star="1">★ 1</button>
        <button type="button" data-star="2">★ 2</button>
        <button type="button" data-star="3">★ 3</button>
        <button type="button" data-star="4">★ 4</button>
        <button type="button" data-star="5">★ 5</button>
      </div>

      <label>Review</label>
      <input id="revMsg" placeholder="What did you like? What should we improve?">

      <button class="btn primary" id="sendReview">Submit review</button>
      <div class="toast" id="reviewStatus">—</div>

      <div class="divider"></div>

      <div class="title" style="margin:0 0 6px">Quick links</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="reviews.html">Read public reviews</a>
        <a class="btn" href="https://stonevia.gumroad.com/l/goddhg" target="_blank" rel="noopener">Buy PRO</a>
      </div>
    </div>

  </div>

  <footer>© <span id="yr"></span> Ukwebtools • ProfitPilot</footer>
</div>

<!-- PAYWALL -->
<div class="overlay" id="paywall">
  <div class="modal">
    <h2>Unlock ProfitPilot PRO</h2>
    <p class="small">
      Your free trial ended. Unlock PRO with a one-time purchase (no subscription).
      Gumroad emails your license key instantly. Paste it below to unlock.
    </p>

    <div class="two">
      <div class="card" style="padding:14px;box-shadow:none">
        <div class="title">Free Trial</div>
        <ul class="small" style="line-height:1.8;padding-left:16px;margin:8px 0 0">
          <li>5-day access</li>
          <li>Reverse mode: 3 runs total</li>
        </ul>
      </div>

      <div class="card" style="padding:14px;border-color:rgba(14,165,164,.35);box-shadow:none">
        <div class="title">PRO (One-time unlock)</div>
        <ul class="small" style="line-height:1.8;padding-left:16px;margin:8px 0 0">
          <li><b>Unlimited access</b></li>
          <li><b>Unlimited reverse mode</b></li>
          <li><b>Export + share</b></li>
        </ul>
        <div class="pill ok" style="margin-top:10px">One-time purchase • No subscription</div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="row">
      <a class="btn primary" id="buyBtn" href="https://stonevia.gumroad.com/l/goddhg" target="_blank" rel="noopener">Buy PRO (one-time)</a>
      <a class="btn" href="reviews.html">See reviews</a>
    </div>

    <label style="margin-top:12px">Paste Gumroad license key</label>
    <input id="redeemInput" placeholder="e.g., ABCD-1234-EFGH-5678">
    <button class="btn primary" id="redeemBtn">Redeem & unlock</button>
    <div class="toast" id="redeemStatus">—</div>

    <div class="small" style="margin-top:12px">
      Need help? Email <a href="mailto:support@ukwebtools.com">support@ukwebtools.com</a>
    </div>
  </div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://xsigsftvfknefpdfsyae.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzaWdzZnR2ZmtuZWZwZGZzeWFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzY4NjksImV4cCI6MjA4NTg1Mjg2OX0.Jkkh9Jd46saYBVipN8bxbWhjmhG6mgaFgtTpirKUAWg";

  const BUY_URL = "https://stonevia.gumroad.com/l/goddhg";
  const GUMROAD_REDEEM_FN = "https://xsigsftvfknefpdfsyae.supabase.co/functions/v1/gumroad-redeem";

  const TRIAL_DAYS = 5;
  const TRIAL_REVERSE_LIMIT = 3;

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  // UI refs
  const accessPill = document.getElementById("accessPill");
  const userLine = document.getElementById("userLine");
  const paywall = document.getElementById("paywall");
  document.getElementById("buyBtn").href = BUY_URL;
  document.getElementById("yr").textContent = new Date().getFullYear();

  function showPaywall(show){ paywall.style.display = show ? "flex" : "none"; }

  function n(v){ const x = parseFloat(String(v).replace(/,/g,"")); return Number.isFinite(x) ? x : 0; }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // Currency
  const CURRENCY_SYMBOL = {
    GBP:"£", USD:"$", EUR:"€", AUD:"$", CAD:"$", NZD:"$",
    AED:"AED ", SAR:"SAR ", PKR:"₨", INR:"₹", TRY:"₺", ZAR:"R ", NGN:"₦", BDT:"৳", LKR:"Rs "
  };
  const currencyEl = document.getElementById("currency");
  const fxRateEl = document.getElementById("fxRate");
  const fxRow = document.getElementById("fxRow");
  const fxOut = document.getElementById("fxOut");
  const fxNote = document.getElementById("fxNote");

  function sym(){ return CURRENCY_SYMBOL[currencyEl.value || "GBP"] || ""; }
  function money(x){ return sym() + (Number.isFinite(x) ? x : 0).toFixed(2); }
  function pct(x){ return (Number.isFinite(x) ? x : 0).toFixed(1) + "%"; }

  function updateFXLine(sell){
    const r = n(fxRateEl.value);
    if (r > 0 && sell > 0){
      fxRow.style.display = "block";
      fxOut.textContent = (sell * r).toFixed(2);
      fxNote.textContent = `Converted using your rate: ${sell.toFixed(2)} × ${r}`;
    } else {
      fxRow.style.display = "none";
    }
  }

  // Presets
  const PRESETS = [
    { id:"manual", name:"Manual (enter fees yourself)", feePct:0, feeFixed:0, adsPct:0, returnPct:0 },
    { id:"ebay_uk_typical", name:"eBay UK (typical example)", feePct:12.8, feeFixed:0.30, adsPct:0, returnPct:3 },
    { id:"etsy_typical", name:"Etsy (typical example)", feePct:9.5, feeFixed:0.20, adsPct:0, returnPct:3 },
    { id:"shopify_card_only", name:"Shopify (card fee example)", feePct:2.0, feeFixed:0.20, adsPct:0, returnPct:2 },
  ];
  const presetSel = document.getElementById("preset");
  const feePctEl = document.getElementById("feePct");
  const feeFixEl = document.getElementById("feeFixed");
  const adsPctEl = document.getElementById("adsPct");
  const retPctEl = document.getElementById("returnPct");

  PRESETS.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.name;
    presetSel.appendChild(opt);
  });
  presetSel.value = "manual";
  presetSel.addEventListener("change", ()=>{
    const p = PRESETS.find(x=>x.id===presetSel.value) || PRESETS[0];
    if (p.id !== "manual") {
      feePctEl.value = String(p.feePct ?? 0);
      feeFixEl.value = String(p.feeFixed ?? 0);
      adsPctEl.value = String(p.adsPct ?? 0);
      retPctEl.value = String(p.returnPct ?? 0);
    }
    compute();
  });

  // Inputs
  const sellPriceEl = document.getElementById("sellPrice");
  const productCostEl = document.getElementById("productCost");
  const shipCostEl = document.getElementById("shipCost");
  const miscCostEl = document.getElementById("miscCost");
  const targetProfitEl = document.getElementById("targetProfit");

  // Outputs
  const o1h = document.getElementById("o1h");
  const o2h = document.getElementById("o2h");
  const o1v = document.getElementById("o1v");
  const o2v = document.getElementById("o2v");
  const o1hint = document.getElementById("o1hint");
  const o2hint = document.getElementById("o2hint");
  const feesOut = document.getElementById("feesOut");
  const returnOut = document.getElementById("returnOut");

  // Mode
  const tabProfit = document.getElementById("tabProfit");
  const tabReverse = document.getElementById("tabReverse");
  const reverseBox = document.getElementById("reverseBox");
  const reverseUsesLine = document.getElementById("reverseUsesLine");
  let MODE = "profit";

  function setMode(m){
    MODE = m;
    tabProfit.classList.toggle("active", m==="profit");
    tabReverse.classList.toggle("active", m==="reverse");
    reverseBox.style.display = (m==="reverse") ? "block" : "none";

    if (m === "profit"){
      o1h.textContent = "Estimated profit";
      o2h.textContent = "Margin";
    } else {
      o1h.textContent = "Required selling price";
      o2h.textContent = "Implied margin";
    }
    compute();
  }
  tabProfit.addEventListener("click", ()=>setMode("profit"));
  tabReverse.addEventListener("click", ()=>setMode("reverse"));

  function getFees(sell){
    const feePct = clamp(n(feePctEl.value), 0, 99);
    const feeFixed = clamp(n(feeFixEl.value), 0, 999999);
    const adsPct = clamp(n(adsPctEl.value), 0, 99);
    const platformFee = sell * (feePct/100);
    const adsFee = sell * (adsPct/100);
    return { totalFees: platformFee + feeFixed + adsFee, feePct, feeFixed, adsPct };
  }

  function computeProfit(){
    const sell = n(sellPriceEl.value);
    const cost = n(productCostEl.value);
    const ship = n(shipCostEl.value);
    const misc = n(miscCostEl.value);
    const retPct = clamp(n(retPctEl.value), 0, 99);

    const { totalFees } = getFees(sell);
    const expectedReturnImpact = sell * (retPct/100);

    const profit = sell - (cost + ship + misc + totalFees);
    const margin = sell > 0 ? (profit / sell) * 100 : 0;

    o1v.textContent = money(profit);
    o2v.textContent = pct(margin);
    feesOut.textContent = money(totalFees);
    returnOut.textContent = money(expectedReturnImpact);

    if (sell <= 0){
      o1hint.textContent = "Enter a selling price.";
      o2hint.textContent = "—";
      o1hint.style.color = "var(--muted)";
      o2hint.style.color = "var(--muted)";
    } else if (profit < 0){
      o1hint.textContent = "Loss on this pricing. Adjust price or costs.";
      o1hint.style.color = "var(--bad)";
      o2hint.textContent = "Try reducing costs or increasing price.";
      o2hint.style.color = "var(--warn)";
    } else if (profit < sell * 0.05){
      o1hint.textContent = "Thin profit. Small changes can wipe margin.";
      o1hint.style.color = "var(--warn)";
      o2hint.textContent = "Consider building more buffer.";
      o2hint.style.color = "var(--warn)";
    } else {
      o1hint.textContent = "Healthy buffer based on inputs.";
      o1hint.style.color = "var(--ok)";
      o2hint.textContent = "Looks reasonable for many categories.";
      o2hint.style.color = "var(--ok)";
    }

    updateFXLine(sell);
  }

  function reverseSellPriceForTargetProfit(target){
    const cost = n(productCostEl.value);
    const ship = n(shipCostEl.value);
    const misc = n(miscCostEl.value);

    const feePct = clamp(n(feePctEl.value), 0, 99);
    const adsPct = clamp(n(adsPctEl.value), 0, 99);
    const feeFixed = clamp(n(feeFixEl.value), 0, 999999);

    const pctSum = (feePct + adsPct) / 100;
    const denom = 1 - pctSum;
    const baseCosts = cost + ship + misc + feeFixed;

    if (denom <= 0.01) return null;
    return (target + baseCosts) / denom;
  }

  function computeReverse(){
    const target = n(targetProfitEl.value);
    if (target <= 0){
      o1v.textContent = "—";
      o2v.textContent = "—";
      o1hint.textContent = "Enter a target profit.";
      o1hint.style.color = "var(--muted)";
      o2hint.textContent = "—";
      o2hint.style.color = "var(--muted)";
      fxRow.style.display = "none";
      return;
    }

    const sell = reverseSellPriceForTargetProfit(target);
    if (!sell || !Number.isFinite(sell) || sell <= 0){
      o1v.textContent = "—";
      o2v.textContent = "—";
      o1hint.textContent = "Reverse calc failed. Check fee % values (too high).";
      o1hint.style.color = "var(--bad)";
      o2hint.textContent = "—";
      o2hint.style.color = "var(--muted)";
      fxRow.style.display = "none";
      return;
    }

    sellPriceEl.value = sell.toFixed(2);

    const retPct = clamp(n(retPctEl.value), 0, 99);
    const { totalFees } = getFees(sell);
    const expectedReturnImpact = sell * (retPct/100);
    const cost = n(productCostEl.value);
    const ship = n(shipCostEl.value);
    const misc = n(miscCostEl.value);

    const profit = sell - (cost + ship + misc + totalFees);
    const margin = sell > 0 ? (profit / sell) * 100 : 0;

    o1v.textContent = money(sell);
    o2v.textContent = pct(margin);
    feesOut.textContent = money(totalFees);
    returnOut.textContent = money(expectedReturnImpact);

    o1hint.textContent = `Required selling price to target ~${money(target)} profit (estimate).`;
    o1hint.style.color = "var(--ok)";
    o2hint.textContent = "Implied margin at the required selling price.";
    o2hint.style.color = "var(--muted)";

    updateFXLine(sell);
  }

  function compute(){ (MODE === "profit") ? computeProfit() : computeReverse(); }

  // Export + share
  const shareStatus = document.getElementById("shareStatus");
  function payload(){
    return {
      mode: MODE,
      currency: currencyEl.value,
      fxRate: fxRateEl.value || "",
      preset: presetSel.value,
      sellPrice: sellPriceEl.value,
      productCost: productCostEl.value,
      shipCost: shipCostEl.value,
      miscCost: miscCostEl.value,
      feePct: feePctEl.value,
      feeFixed: feeFixEl.value,
      adsPct: adsPctEl.value,
      returnPct: retPctEl.value,
      targetProfit: targetProfitEl.value
    };
  }
  function csvEscape(s){
    const t = String(s ?? "");
    if (/[",\n]/.test(t)) return `"${t.replaceAll('"','""')}"`;
    return t;
  }
  function buildCsv(){
    const p = payload();
    const rows = [
      ["Field","Value"],
      ["Mode", p.mode],
      ["Currency", p.currency],
      ["FX Rate (optional)", p.fxRate],
      ["Preset", p.preset],
      ["Selling price", p.sellPrice],
      ["Product cost", p.productCost],
      ["Shipping cost", p.shipCost],
      ["Packaging/misc", p.miscCost],
      ["Platform fee %", p.feePct],
      ["Fixed fee", p.feeFixed],
      ["Ads %", p.adsPct],
      ["Return %", p.returnPct],
      ["Target profit (reverse)", p.targetProfit],
      ["Output 1", `${o1h.textContent}: ${o1v.textContent}`],
      ["Output 2", `${o2h.textContent}: ${o2v.textContent}`],
      ["Total fees+ads", feesOut.textContent],
      ["Return sensitivity", returnOut.textContent],
    ];
    return rows.map(r=>r.map(csvEscape).join(",")).join("\n");
  }
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  document.getElementById("exportCsvBtn").addEventListener("click", ()=>{
    compute();
    downloadText("profitpilot-export.csv", buildCsv());
    shareStatus.textContent = "CSV exported.";
  });

  document.getElementById("exportPdfBtn").addEventListener("click", ()=>{
    compute();
    const p = payload();
    const html = `
      <html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
      <title>ProfitPilot Export</title>
      <style>
        body{font-family:system-ui;margin:24px;color:#0b1220}
        .h{font-size:20px;font-weight:900;margin-bottom:6px}
        .m{color:#5b6474;margin-bottom:16px}
        table{width:100%;border-collapse:collapse}
        td{border:1px solid rgba(16,24,40,.12);padding:10px;font-size:13px;vertical-align:top}
        .k{font-weight:800;width:38%}
        .out{margin-top:16px;padding:12px;border:1px solid rgba(16,24,40,.12);border-radius:12px}
      </style></head><body>
        <div class="h">ProfitPilot Export</div>
        <div class="m">Estimates only. Generated: ${new Date().toLocaleString()}</div>
        <table>${Object.entries(p).map(([k,v])=>`<tr><td class="k">${k}</td><td>${String(v ?? "")}</td></tr>`).join("")}</table>
        <div class="out">
          <div><b>${o1h.textContent}:</b> ${o1v.textContent}</div>
          <div><b>${o2h.textContent}:</b> ${o2v.textContent}</div>
          <div><b>Total fees + ads:</b> ${feesOut.textContent}</div>
          <div><b>Return sensitivity:</b> ${returnOut.textContent}</div>
        </div>
        <script>window.onload=()=>window.print()</script>
      </body></html>
    `;
    const w = window.open("", "_blank");
    w.document.open(); w.document.write(html); w.document.close();
    shareStatus.textContent = "PDF print opened.";
  });

  function base64urlEncode(str){
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    bytes.forEach(b=>bin += String.fromCharCode(b));
    return btoa(bin).replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
  }

  document.getElementById("shareBtn").addEventListener("click", ()=>{
    compute();
    if (!CURRENT_PROFILE?.paid){
      shareStatus.textContent = "Share link is PRO. Unlock to share scenarios.";
      return;
    }
    const token = base64urlEncode(JSON.stringify(payload()));
    const url = `${location.origin}/share.html#s=${token}`;
    navigator.clipboard?.writeText(url).catch(()=>{});
    shareStatus.textContent = "Share link copied.";
  });

  // Reset
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    [sellPriceEl, productCostEl, shipCostEl, miscCostEl, feePctEl, feeFixEl, adsPctEl, retPctEl, targetProfitEl].forEach(el=>el.value="0");
    fxRateEl.value = "";
    presetSel.value = "manual";
    setMode("profit");
    compute();
    shareStatus.textContent = "—";
  });

  // Reviews submit
  let selectedStars = 5;
  const starsRow = document.getElementById("starsRow");
  const reviewStatus = document.getElementById("reviewStatus");

  function setStars(n){
    selectedStars = n;
    [...starsRow.querySelectorAll("button")].forEach(b=>{
      b.classList.toggle("active", parseInt(b.dataset.star,10) === n);
    });
  }
  setStars(5);
  starsRow.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if (!btn) return;
    setStars(parseInt(btn.dataset.star,10));
  });

  document.getElementById("sendReview").addEventListener("click", async ()=>{
    reviewStatus.textContent = "Submitting…";
    try{
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("Please log in again.");
      const name = document.getElementById("revName").value.trim();
      const category = document.getElementById("revCat").value;
      const message = document.getElementById("revMsg").value.trim();
      if (!message) throw new Error("Write a short review message.");

      const { error } = await supabase.from("reviews").insert([{
        user_id: user.id,
        name: name || null,
        rating: selectedStars,
        category,
        message,
        approved: true
      }]);

      if (error) throw error;
      reviewStatus.textContent = "Thanks! Your review is now public.";
      document.getElementById("revMsg").value = "";
    } catch(e){
      reviewStatus.textContent = e.message || "Failed to submit review.";
    }
  });

  // Auth + access
  let CURRENT_PROFILE = null;
  let CURRENT_USER = null;

  function daysLeft(trialStartISO){
    const start = new Date(trialStartISO).getTime();
    const now = Date.now();
    const elapsedDays = (now - start) / (1000*60*60*24);
    const left = TRIAL_DAYS - elapsedDays;
    return Math.max(0, Math.ceil(left));
  }

  async function ensureProfile(userId){
    const { data: prof, error } = await supabase
      .from("profiles")
      .select("id, trial_start, paid, plan, reverse_uses")
      .eq("id", userId)
      .maybeSingle();

    if (error) throw error;

    if (!prof) {
      const now = new Date().toISOString();
      const { error: insErr } = await supabase.from("profiles").insert([{
        id: userId,
        trial_start: now,
        paid: false,
        plan: "trial",
        reverse_uses: 0
      }]);
      if (insErr) throw insErr;
      return { id:userId, trial_start: now, paid:false, plan:"trial", reverse_uses: 0 };
    }

    if (!prof.trial_start) {
      const now = new Date().toISOString();
      const { error: upErr } = await supabase.from("profiles").update({ trial_start: now }).eq("id", userId);
      if (upErr) throw upErr;
      prof.trial_start = now;
    }

    if (prof.reverse_uses == null){
      const { error: upErr } = await supabase.from("profiles").update({ reverse_uses: 0 }).eq("id", userId);
      if (upErr) throw upErr;
      prof.reverse_uses = 0;
    }

    return prof;
  }

  async function updateAccessUI(profile, email){
    CURRENT_PROFILE = profile;
    userLine.textContent = `Signed in as ${email}`;

    if (profile.paid){
      reverseUsesLine.textContent = `Reverse uses: Unlimited (PRO)`;
    } else {
      reverseUsesLine.textContent = `Reverse uses: ${profile.reverse_uses ?? 0}/${TRIAL_REVERSE_LIMIT} (Trial)`;
    }

    if (profile.paid) {
      accessPill.textContent = "Unlocked (PRO)";
      accessPill.className = "pill ok";
      showPaywall(false);
      return;
    }

    const left = daysLeft(profile.trial_start);
    if (left > 0) {
      accessPill.textContent = `Trial active • ${left} day(s) left`;
      accessPill.className = "pill warn";
      showPaywall(false);
    } else {
      accessPill.textContent = "Trial ended • PRO required";
      accessPill.className = "pill bad";
      showPaywall(true);
    }
  }

  // ✅ IMPORTANT: use p_limit (matches SQL function)
  async function consumeReverseUse(){
    const { data, error } = await supabase.rpc("consume_reverse_use", { p_limit: TRIAL_REVERSE_LIMIT });
    if (error){
      const msg = error.message || "";
      if (msg.toLowerCase().includes("limit_reached")){
        throw new Error(`Trial reverse limit reached (${TRIAL_REVERSE_LIMIT}). Unlock PRO for unlimited reverse mode.`);
      }
      throw new Error(msg || "Reverse limit check failed.");
    }
    const next = Number(data || 0);
    CURRENT_PROFILE.reverse_uses = next;
    reverseUsesLine.textContent = `Reverse uses: ${next}/${TRIAL_REVERSE_LIMIT} (Trial)`;
  }

  // Calculate (with reverse limit)
  document.getElementById("calcBtn").addEventListener("click", async ()=>{
    try{
      if (MODE === "reverse" && !CURRENT_PROFILE?.paid){
        await consumeReverseUse();
      }
      compute();
    } catch(e){
      o1hint.textContent = e.message || "Unable to calculate.";
      o1hint.style.color = "var(--bad)";
    }
  });

  // Gumroad redeem
  async function redeemGumroad(licenseKey){
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) throw new Error("Please log in again.");

    const res = await fetch(GUMROAD_REDEEM_FN, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + session.access_token
      },
      body: JSON.stringify({ license_key: licenseKey })
    });

    const out = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(out.error || "Redeem failed.");
    return out;
  }

  document.getElementById("redeemBtn").addEventListener("click", async ()=>{
    const redeemStatus = document.getElementById("redeemStatus");
    redeemStatus.textContent = "Verifying…";
    try {
      const key = (document.getElementById("redeemInput").value || "").trim();
      if (!key) throw new Error("Paste your Gumroad license key.");
      const out = await redeemGumroad(key);
      redeemStatus.textContent = out.message || "Unlocked.";
      setTimeout(()=>location.reload(), 600);
    } catch(e){
      redeemStatus.textContent = e.message;
    }
  });

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    await supabase.auth.signOut();
    location.href = "login.html";
  });

  // Boot
  async function boot(){
    try{
      accessPill.textContent = "Loading session…";

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { location.href = "login.html"; return; }

      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { location.href = "login.html"; return; }
      CURRENT_USER = user;

      const profile = await ensureProfile(user.id);
      await updateAccessUI(profile, user.email || "user");

      // default compute
      computeProfit();
    } catch(e){
      accessPill.textContent = "Access check failed";
      accessPill.className = "pill bad";
      userLine.textContent = (e && e.message) ? e.message : "Unknown error";
    }
  }

  // init
  setMode("profit");
  await boot();
</script>
</body>
</html>
