<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ProfitPilot — App</title>
  <meta name="description" content="ProfitPilot: profit calculator with reverse pricing, bulk mode, trial limits, export, share and saved presets.">
  <link rel="icon" href="https://ukwebtools.com/favicon.svg" type="image/svg+xml">
  <style>
    :root{
      --bg:#f6f8fb; --bg2:#eef2ff; --txt:#0b1220; --muted:#5b6474;
      --card:rgba(255,255,255,.88); --line:rgba(16,24,40,.10);
      --accent:#0ea5a4; --accent2:#4f46e5; --shadow:0 10px 30px rgba(16,24,40,.08);
      --warn:#f59e0b; --bad:#ef4444; --ok:#0ea5a4;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(14,165,164,.16), transparent 55%),
        radial-gradient(900px 500px at 80% 0%, rgba(79,70,229,.12), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg));
    }
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    .nav{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:linear-gradient(135deg, rgba(14,165,164,.18), rgba(79,70,229,.14));
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;
    }
    .pill{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.72);font-size:12px;color:var(--muted);
      display:inline-flex;gap:8px;align-items:center
    }
    .pill.ok{border-color:rgba(14,165,164,.30);background:rgba(14,165,164,.10);color:var(--txt)}
    .pill.warn{border-color:rgba(245,158,11,.30);background:rgba(245,158,11,.10);color:var(--txt)}
    .pill.bad{border-color:rgba(239,68,68,.30);background:rgba(239,68,68,.10);color:var(--txt)}
    .btn{
      padding:10px 14px;border-radius:999px;border:1px solid var(--line);
      background:rgba(255,255,255,.78);color:var(--txt);
      display:inline-flex;gap:8px;align-items:center;cursor:pointer;
      box-shadow:0 4px 16px rgba(16,24,40,.06);user-select:none;
      white-space:nowrap;
    }
    .btn.primary{border-color:rgba(14,165,164,.30);background:rgba(14,165,164,.10)}
    .btn.ghost{background:transparent;box-shadow:none}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      background:var(--card);border:1px solid var(--line);
      border-radius:18px;padding:16px;box-shadow:var(--shadow);
    }
    .title{font-weight:900;margin:0 0 8px}
    .small{font-size:12px;color:var(--muted);line-height:1.6}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:560px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(255,255,255,.92);color:var(--txt);outline:none;
    }
    textarea{min-height:110px;resize:vertical}
    input:focus,select:focus,textarea:focus{border-color:rgba(14,165,164,.35)}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .kpi{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
    @media(max-width:560px){.kpi{grid-template-columns:1fr}}
    .k{border:1px solid var(--line);background:rgba(255,255,255,.72);border-radius:16px;padding:12px}
    .k .h{font-size:12px;color:var(--muted)}
    .k .v{font-size:20px;font-weight:900;margin-top:6px}
    .hint{font-size:12px;color:var(--muted)}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.72);cursor:pointer;font-size:12px;user-select:none}
    .tab.active{border-color:rgba(14,165,164,.35);background:rgba(14,165,164,.10);font-weight:900}
    .toast{margin-top:10px;font-size:12px;color:var(--muted)}
    footer{margin:14px 2px 0;color:var(--muted);font-size:12px;line-height:1.6}
    .good{color:var(--ok);font-weight:800}
    .bad{color:var(--bad);font-weight:800}

    /* Import banner */
    .banner{
      display:none;
      margin-top:12px;
      border:1px solid rgba(14,165,164,.28);
      background:rgba(14,165,164,.10);
      border-radius:16px;
      padding:10px 12px;
      color:var(--txt);
      font-size:12px;
      line-height:1.5;
    }
    .banner b{font-weight:900}

    /* Bulk grid */
    .bulkWrap{overflow:auto;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.72)}
    table{width:100%;border-collapse:collapse;font-size:12px;min-width:980px}
    th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:middle}
    th{color:var(--muted);font-weight:800;position:sticky;top:0;background:rgba(255,255,255,.92)}
    td input{padding:10px;border-radius:12px}
    .mini{padding:8px 10px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.92)}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .note{
      border:1px dashed rgba(16,24,40,.16);
      background:rgba(255,255,255,.65);
      border-radius:16px;
      padding:12px;
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      line-height:1.6;
    }

    @media print{
      body{background:#fff}
      .nav, #controlsRow, #reviewsCard, #proCard, #logoutBtn, .btn.ghost, .tabs, #bulkTools, #bulkPasteBox, #importBanner {display:none !important}
      .wrap{margin:0;max-width:none}
      .card{box-shadow:none}
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="nav">
    <div class="brand">
      <div class="logo">PP</div>
      <div>
        <div style="font-weight:900">ProfitPilot</div>
        <div class="pill">Estimates only • Independent tool</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <a class="btn ghost" href="index.html">Home</a>
      <a class="btn ghost" href="reviews.html">Reviews</a>
      <span class="pill" id="accessPill">Loading…</span>
      <button class="btn" id="logoutBtn">Log out</button>
    </div>
  </div>

  <div class="banner" id="importBanner">Imported shared calculation ✅</div>

  <div class="grid">

    <!-- LEFT -->
    <div class="card" id="calcCard">
      <div class="title">Calculator</div>
      <div class="small">Profit = normal. Reverse = target profit → required selling price. Bulk = multiple items (trial limited).</div>

      <div class="tabs">
        <div class="tab active" id="tabProfit">Profit</div>
        <div class="tab" id="tabReverse">Reverse</div>
        <div class="tab" id="tabBulk">Bulk</div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <div>
          <label>Display currency</label>
          <select id="currency">
            <option value="GBP">GBP (£)</option>
            <option value="USD">USD ($)</option>
            <option value="EUR">EUR (€)</option>
            <option value="AUD">AUD ($)</option>
            <option value="CAD">CAD ($)</option>
            <option value="NZD">NZD ($)</option>
            <option value="AED">AED</option>
            <option value="SAR">SAR</option>
            <option value="PKR">PKR (₨)</option>
            <option value="INR">INR (₹)</option>
          </select>
        </div>
        <div>
          <label>Exchange rate (optional)</label>
          <input id="fxRate" inputmode="decimal" placeholder="e.g., 1 base = 1.25 selected">
        </div>
      </div>

      <!-- SINGLE -->
      <div id="singleBox">
        <div class="divider"></div>

        <label>Platform preset</label>
        <select id="preset">
          <option value="manual">Manual (enter fees yourself)</option>
        </select>

        <div class="row">
          <div><label>Selling price</label><input id="sellPrice" inputmode="decimal" value="0"></div>
          <div><label>Product cost</label><input id="productCost" inputmode="decimal" value="0"></div>
        </div>
        <div class="row">
          <div><label>Shipping cost</label><input id="shipCost" inputmode="decimal" value="0"></div>
          <div><label>Packaging / misc</label><input id="miscCost" inputmode="decimal" value="0"></div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div><label>Platform fee (%)</label><input id="feePct" inputmode="decimal" value="0"></div>
          <div><label>Fixed fee</label><input id="feeFixed" inputmode="decimal" value="0"></div>
        </div>
        <div class="row">
          <div><label>Ads (%)</label><input id="adsPct" inputmode="decimal" value="0"></div>
          <div><label>Return rate (%)</label><input id="returnPct" inputmode="decimal" value="0"></div>
        </div>

        <div id="reverseBox" style="display:none">
          <div class="divider"></div>
          <div class="title" style="margin:0 0 6px;font-size:14px">Reverse mode</div>
          <div class="small">Trial: 3 reverse calculations total. PRO: unlimited.</div>
          <label>Target profit</label>
          <input id="targetProfit" inputmode="decimal" value="0">
          <div class="small" id="reverseUsesLine" style="margin-top:8px">Reverse uses: —</div>
        </div>

        <div class="divider"></div>

        <div class="row" id="controlsRow">
          <button class="btn primary" id="calcBtn">Calculate</button>
          <button class="btn" id="resetBtn">Reset</button>
        </div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn" id="exportCsvBtn">Export CSV</button>
          <button class="btn" id="pdfBtn">Export PDF (PRO)</button>
          <button class="btn" id="shareBtn">Share link (PRO)</button>
          <span class="pill" id="shareStatus">—</span>
        </div>

        <div class="kpi">
          <div class="k">
            <div class="h" id="o1h">Estimated profit</div>
            <div class="v" id="o1v">£0.00</div>
            <div class="hint" id="o1hint">—</div>
          </div>
          <div class="k">
            <div class="h" id="o2h">Margin</div>
            <div class="v" id="o2v">0.0%</div>
            <div class="hint" id="o2hint">—</div>
          </div>
        </div>

        <div class="kpi">
          <div class="k"><div class="h">Total fees + ads</div><div class="v" id="feesOut">£0.00</div><div class="hint">Platform fee + fixed + ads</div></div>
          <div class="k"><div class="h">Return sensitivity (expected)</div><div class="v" id="returnOut">£0.00</div><div class="hint">Expected impact from return %</div></div>
        </div>

        <div class="kpi" id="fxRow" style="display:none">
          <div class="k" style="grid-column:1 / -1">
            <div class="h">Converted selling price (your FX)</div>
            <div class="v" id="fxOut">—</div>
            <div class="hint" id="fxNote">—</div>
          </div>
        </div>
      </div>

      <!-- BULK -->
      <div id="bulkBox" style="display:none">
        <div class="small" id="bulkLimitLine">Loading bulk limits…</div>

        <div class="divider"></div>

        <div id="bulkPasteBox">
          <div class="title" style="margin:0 0 6px;font-size:14px">Paste rows</div>
          <div class="small">Paste lines like: <b>Sell, Cost, Ship, Misc</b> (comma or tab separated). Fees will use your current fields unless included.</div>
          <textarea id="bulkPaste" placeholder="Example:
12.99, 6.20, 0.00, 0.20
19.99, 9.50, 0.00, 0.30"></textarea>
          <div class="actions" style="margin-top:10px">
            <button class="btn" id="bulkImportBtn">Import into table</button>
            <button class="btn" id="bulkFillExampleBtn">Fill example</button>
            <span class="pill" id="bulkImportStatus">—</span>
          </div>
        </div>

        <div class="divider"></div>

        <div class="actions" id="bulkTools">
          <button class="btn primary" id="bulkRunBtn">Run bulk</button>
          <button class="btn" id="bulkAddRowBtn">+ Add row</button>
          <button class="btn" id="bulkClearBtn">Clear rows</button>
          <button class="btn" id="bulkApplyFeesBtn">Apply current fees to all</button>
          <button class="btn" id="bulkExportBtn">Export bulk CSV</button>
          <span class="pill" id="bulkStatus">—</span>
        </div>

        <div style="margin-top:10px" class="bulkWrap">
          <table id="bulkTable">
            <thead>
              <tr>
                <th style="width:56px">#</th>
                <th>Sell</th>
                <th>Cost</th>
                <th>Ship</th>
                <th>Misc</th>
                <th>Fee %</th>
                <th>Fixed</th>
                <th>Ads %</th>
                <th>Return %</th>
                <th>Profit</th>
                <th>Margin</th>
                <th style="width:90px">Action</th>
              </tr>
            </thead>
            <tbody id="bulkTbody"></tbody>
          </table>
        </div>

        <div class="note">
          <b>Trial rules:</b> max <b>3 rows</b> and <b>1 bulk run per day</b>. PRO is unlimited.
        </div>
      </div>

      <div class="divider"></div>
      <div class="small">
        <b>Disclaimer:</b> estimates only (not financial/legal/tax advice). Not affiliated with any platform.
        FX depends on your entered rate (no live rates). See
        <a href="https://ukwebtools.com/terms.html" target="_blank" rel="noopener">Terms</a> and
        <a href="https://ukwebtools.com/privacy.html" target="_blank" rel="noopener">Privacy</a>.
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card" id="proCard">
        <div class="title">PRO features</div>
        <div class="small">Unlimited reverse, bulk unlimited, PDF export, share links, saved presets. One-time unlock.</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <a class="btn primary" href="https://stonevia.gumroad.com/l/goddhg" target="_blank" rel="noopener">Buy PRO</a>
          <a class="btn" href="reviews.html">See reviews</a>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="title">My presets (PRO)</div>
        <div class="small">Save your own fee presets and reuse them instantly.</div>

        <label>Saved presets</label>
        <select id="myPresetSel"><option value="">—</option></select>

        <div class="row">
          <button class="btn" id="loadMyPresetBtn">Load</button>
          <button class="btn" id="deleteMyPresetBtn">Delete</button>
        </div>

        <div class="divider"></div>

        <label>Preset name</label>
        <input id="myPresetName" placeholder="e.g., eBay UK promoted listings">

        <div class="row">
          <button class="btn primary" id="saveMyPresetBtn">Save current fees</button>
          <span class="pill" id="presetStatus">—</span>
        </div>

        <div class="small" style="margin-top:10px">
          Trial users can use example presets only. PRO users can save unlimited presets.
        </div>
      </div>

      <div class="card" id="reviewsCard" style="margin-top:14px">
        <div class="title">Leave a review</div>
        <div class="small">Reviews publish immediately. Spam/abuse may be removed.</div>

        <label>Name (optional)</label>
        <input id="revName" placeholder="Name">

        <label>Category</label>
        <select id="revCat">
          <option>General</option>
          <option>UI/UX</option>
          <option>Accuracy</option>
          <option>Speed</option>
          <option>Features</option>
        </select>

        <label>Rating</label>
        <div style="display:flex;gap:8px;flex-wrap:wrap" id="starsRow">
          <button class="btn" type="button" data-star="1">★ 1</button>
          <button class="btn" type="button" data-star="2">★ 2</button>
          <button class="btn" type="button" data-star="3">★ 3</button>
          <button class="btn" type="button" data-star="4">★ 4</button>
          <button class="btn" type="button" data-star="5">★ 5</button>
        </div>

        <label>Review</label>
        <input id="revMsg" placeholder="What did you like? What should we improve?">

        <button class="btn primary" id="sendReview">Submit review</button>
        <div class="toast" id="reviewStatus">—</div>
      </div>
    </div>
  </div>

  <footer>© <span id="yr"></span> Ukwebtools • ProfitPilot</footer>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const SUPABASE_URL = "https://xsigsftvfknefpdfsyae.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzaWdzZnR2ZmtuZWZwZGZzeWFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyNzY4NjksImV4cCI6MjA4NTg1Mjg2OX0.Jkkh9Jd46saYBVipN8bxbWhjmhG6mgaFgtTpirKUAWg";

  const TRIAL_DAYS = 5;
  const TRIAL_REVERSE_LIMIT = 3;
  const TRIAL_BULK_MAX_ROWS = 3;
  const TRIAL_BULK_RUNS_PER_DAY = 1;

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON);

  // UI
  const accessPill = document.getElementById("accessPill");
  const reverseUsesLine = document.getElementById("reverseUsesLine");
  const bulkLimitLine = document.getElementById("bulkLimitLine");
  const shareStatus = document.getElementById("shareStatus");
  const presetStatus = document.getElementById("presetStatus");
  const bulkStatus = document.getElementById("bulkStatus");
  const bulkImportStatus = document.getElementById("bulkImportStatus");
  const importBanner = document.getElementById("importBanner");

  document.getElementById("yr").textContent = new Date().getFullYear();

  // Inputs
  const currencyEl = document.getElementById("currency");
  const fxRateEl = document.getElementById("fxRate");
  const presetSel = document.getElementById("preset");

  const sellPriceEl = document.getElementById("sellPrice");
  const productCostEl = document.getElementById("productCost");
  const shipCostEl = document.getElementById("shipCost");
  const miscCostEl = document.getElementById("miscCost");
  const feePctEl = document.getElementById("feePct");
  const feeFixedEl = document.getElementById("feeFixed");
  const adsPctEl = document.getElementById("adsPct");
  const returnPctEl = document.getElementById("returnPct");
  const targetProfitEl = document.getElementById("targetProfit");

  // Outputs
  const o1h = document.getElementById("o1h");
  const o2h = document.getElementById("o2h");
  const o1v = document.getElementById("o1v");
  const o2v = document.getElementById("o2v");
  const o1hint = document.getElementById("o1hint");
  const o2hint = document.getElementById("o2hint");
  const feesOut = document.getElementById("feesOut");
  const returnOut = document.getElementById("returnOut");

  const fxRow = document.getElementById("fxRow");
  const fxOut = document.getElementById("fxOut");
  const fxNote = document.getElementById("fxNote");

  // Buttons
  const pdfBtn = document.getElementById("pdfBtn");
  const shareBtn = document.getElementById("shareBtn");

  const bulkRunBtn = document.getElementById("bulkRunBtn");
  const bulkAddRowBtn = document.getElementById("bulkAddRowBtn");
  const bulkClearBtn = document.getElementById("bulkClearBtn");
  const bulkApplyFeesBtn = document.getElementById("bulkApplyFeesBtn");
  const bulkExportBtn = document.getElementById("bulkExportBtn");

  const bulkPasteEl = document.getElementById("bulkPaste");
  const bulkImportBtn = document.getElementById("bulkImportBtn");
  const bulkFillExampleBtn = document.getElementById("bulkFillExampleBtn");

  // Bulk table
  const bulkTbody = document.getElementById("bulkTbody");

  const myPresetSel = document.getElementById("myPresetSel");
  const myPresetName = document.getElementById("myPresetName");
  const saveMyPresetBtn = document.getElementById("saveMyPresetBtn");
  const loadMyPresetBtn = document.getElementById("loadMyPresetBtn");
  const deleteMyPresetBtn = document.getElementById("deleteMyPresetBtn");

  // Modes boxes
  const tabProfit = document.getElementById("tabProfit");
  const tabReverse = document.getElementById("tabReverse");
  const tabBulk = document.getElementById("tabBulk");
  const singleBox = document.getElementById("singleBox");
  const reverseBox = document.getElementById("reverseBox");
  const bulkBox = document.getElementById("bulkBox");

  const CURRENCY_SYMBOL = { GBP:"£", USD:"$", EUR:"€", AUD:"$", CAD:"$", NZD:"$", AED:"AED ", SAR:"SAR ", PKR:"₨", INR:"₹" };
  function sym(){ return CURRENCY_SYMBOL[currencyEl.value || "GBP"] || ""; }
  function n(v){ const x = parseFloat(String(v).replace(/,/g,"")); return Number.isFinite(x) ? x : 0; }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function money(x){ return sym() + (Number.isFinite(x) ? x : 0).toFixed(2); }
  function pct(x){ return (Number.isFinite(x) ? x : 0).toFixed(1) + "%"; }

  function todayKey(){
    const d = new Date();
    const y = d.getUTCFullYear();
    const m = String(d.getUTCMonth()+1).padStart(2,"0");
    const day = String(d.getUTCDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }
  function daysLeft(trialStartISO){
    const start = new Date(trialStartISO).getTime();
    const elapsedDays = (Date.now() - start) / (1000*60*60*24);
    return Math.max(0, Math.ceil(TRIAL_DAYS - elapsedDays));
  }
  function updateFXLine(sell){
    const r = n(fxRateEl.value);
    if (r > 0 && sell > 0){
      fxRow.style.display = "block";
      fxOut.textContent = (sell * r).toFixed(2);
      fxNote.textContent = `Converted using your rate: ${sell.toFixed(2)} × ${r}`;
    } else fxRow.style.display = "none";
  }

  // Example presets
  const PRESETS = [
    { id:"manual", name:"Manual (enter fees yourself)", feePct:0, feeFixed:0, adsPct:0, returnPct:0 },
    { id:"ebay_uk_typical", name:"eBay UK (typical example)", feePct:12.8, feeFixed:0.30, adsPct:0, returnPct:3 },
    { id:"etsy_typical", name:"Etsy (typical example)", feePct:9.5, feeFixed:0.20, adsPct:0, returnPct:3 },
    { id:"shopify_card_only", name:"Shopify (card fee example)", feePct:2.0, feeFixed:0.20, adsPct:0, returnPct:2 },
  ];
  PRESETS.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.id; opt.textContent = p.name;
    presetSel.appendChild(opt);
  });
  presetSel.value = "manual";
  presetSel.addEventListener("change", ()=>{
    const p = PRESETS.find(x=>x.id===presetSel.value) || PRESETS[0];
    if (p.id !== "manual"){
      feePctEl.value = String(p.feePct ?? 0);
      feeFixedEl.value = String(p.feeFixed ?? 0);
      adsPctEl.value = String(p.adsPct ?? 0);
      returnPctEl.value = String(p.returnPct ?? 0);
    }
    compute();
  });

  function totalFees(sell, feePct, feeFixed, adsPct){
    return sell * (feePct/100) + feeFixed + sell * (adsPct/100);
  }
  function computeRowProfit(sell,cost,ship,misc,feePct,feeFixed,adsPct,returnPct){
    const fees = totalFees(sell, feePct, feeFixed, adsPct);
    const expectedReturnImpact = sell * (returnPct/100);
    const profit = sell - (cost + ship + misc + fees);
    const margin = sell > 0 ? (profit/sell)*100 : 0;
    return { profit, margin, fees, expectedReturnImpact };
  }

  function computeProfit(){
    const sell = n(sellPriceEl.value);
    const cost = n(productCostEl.value);
    const ship = n(shipCostEl.value);
    const misc = n(miscCostEl.value);
    const feePct = clamp(n(feePctEl.value),0,99);
    const feeFixed = clamp(n(feeFixedEl.value),0,999999);
    const adsPct = clamp(n(adsPctEl.value),0,99);
    const returnPct = clamp(n(returnPctEl.value),0,99);

    const r = computeRowProfit(sell,cost,ship,misc,feePct,feeFixed,adsPct,returnPct);

    o1v.textContent = money(r.profit);
    o2v.textContent = pct(r.margin);
    feesOut.textContent = money(r.fees);
    returnOut.textContent = money(r.expectedReturnImpact);

    if (sell<=0){ o1hint.textContent="Enter a selling price."; o2hint.textContent="—"; }
    else if (r.profit<0){ o1hint.textContent="Loss on this pricing."; o2hint.textContent="Adjust price or costs."; }
    else { o1hint.textContent="OK (based on your inputs)."; o2hint.textContent="—"; }

    updateFXLine(sell);
  }

  function reverseSellPriceForTargetProfit(target){
    const cost = n(productCostEl.value);
    const ship = n(shipCostEl.value);
    const misc = n(miscCostEl.value);
    const feePct = clamp(n(feePctEl.value),0,99);
    const adsPct = clamp(n(adsPctEl.value),0,99);
    const feeFixed = clamp(n(feeFixedEl.value),0,999999);

    const denom = 1 - ((feePct + adsPct)/100);
    if (denom <= 0.01) return null;
    return (target + cost + ship + misc + feeFixed) / denom;
  }

  function computeReverse(){
    const target = n(targetProfitEl.value);
    if (target<=0){
      o1v.textContent="—"; o2v.textContent="—";
      o1hint.textContent="Enter a target profit.";
      o2hint.textContent="—";
      return;
    }
    const sell = reverseSellPriceForTargetProfit(target);
    if (!sell){
      o1hint.textContent="Reverse calc failed. Check fee % values.";
      o2hint.textContent="—";
      return;
    }
    sellPriceEl.value = sell.toFixed(2);
    computeProfit();

    o1v.textContent = money(sell);
    o1hint.textContent = `Required selling price to target ~${money(target)} profit (estimate).`;
    o2hint.textContent = "Implied margin at that selling price.";
    updateFXLine(sell);
  }

  // Modes
  let MODE = "profit";
  function setMode(m){
    MODE = m;
    tabProfit.classList.toggle("active", m==="profit");
    tabReverse.classList.toggle("active", m==="reverse");
    tabBulk.classList.toggle("active", m==="bulk");

    singleBox.style.display = (m==="bulk") ? "none" : "block";
    bulkBox.style.display = (m==="bulk") ? "block" : "none";
    reverseBox.style.display = (m==="reverse") ? "block" : "none";

    if (m==="profit"){ o1h.textContent="Estimated profit"; o2h.textContent="Margin"; }
    if (m==="reverse"){ o1h.textContent="Required selling price"; o2h.textContent="Implied margin"; }
    if (m==="bulk"){ refreshBulkLimitLine(); }
    compute();
  }
  tabProfit.addEventListener("click", ()=>setMode("profit"));
  tabReverse.addEventListener("click", ()=>setMode("reverse"));
  tabBulk.addEventListener("click", ()=>setMode("bulk"));

  function compute(){
    if (MODE==="profit") computeProfit();
    if (MODE==="reverse") computeReverse();
  }

  // Access + profile
  let CURRENT_PROFILE = null;
  let CURRENT_USER = null;

  async function ensureProfile(userId){
    const { data: prof, error } = await supabase
      .from("profiles")
      .select("id, trial_start, paid, reverse_uses, bulk_day, bulk_runs_today")
      .eq("id", userId)
      .maybeSingle();
    if (error) throw error;

    const now = new Date().toISOString();
    const base = {
      id:userId,
      trial_start: prof?.trial_start || now,
      paid: !!prof?.paid,
      reverse_uses: prof?.reverse_uses ?? 0,
      bulk_day: prof?.bulk_day ?? null,
      bulk_runs_today: prof?.bulk_runs_today ?? 0
    };

    if (!prof){
      const { error: insErr } = await supabase.from("profiles").insert([base]);
      if (insErr) throw insErr;
      return base;
    }

    const patch = {};
    if (!prof.trial_start) patch.trial_start = now;
    if (prof.reverse_uses == null) patch.reverse_uses = 0;
    if (prof.bulk_runs_today == null) patch.bulk_runs_today = 0;
    if (prof.bulk_day == null) patch.bulk_day = null;

    if (Object.keys(patch).length){
      const { error: upErr } = await supabase.from("profiles").update(patch).eq("id", userId);
      if (upErr){ /* ok */ }
      Object.assign(base, patch);
    }
    return base;
  }

  function enableProUI(isPro){
    pdfBtn.disabled = !isPro;
    shareBtn.disabled = !isPro;

    presetStatus.textContent = isPro ? "PRO enabled" : "Unlock PRO to use My Presets + PDF + Share.";
    saveMyPresetBtn.disabled = !isPro;
    loadMyPresetBtn.disabled = !isPro;
    deleteMyPresetBtn.disabled = !isPro;
    myPresetSel.disabled = !isPro;
    myPresetName.disabled = !isPro;
  }

  function updateAccessUI(profile){
    CURRENT_PROFILE = profile;

    if (profile.paid){
      accessPill.textContent = "Unlocked (PRO)";
      accessPill.className = "pill ok";
      reverseUsesLine.textContent = "Reverse uses: Unlimited (PRO)";
      enableProUI(true);
      refreshBulkLimitLine();
      return;
    }

    enableProUI(false);
    reverseUsesLine.textContent = `Reverse uses: ${(profile.reverse_uses ?? 0)}/${TRIAL_REVERSE_LIMIT} (Trial)`;

    const left = daysLeft(profile.trial_start);
    if (left > 0){
      accessPill.textContent = `Trial active • ${left} day(s) left`;
      accessPill.className = "pill warn";
    } else {
      accessPill.textContent = "Trial ended • PRO required";
      accessPill.className = "pill bad";
    }
    refreshBulkLimitLine();
  }

  async function consumeReverseUseIfTrial(){
    if (!CURRENT_USER || !CURRENT_PROFILE) throw new Error("Session missing. Refresh and log in again.");
    if (CURRENT_PROFILE.paid) return;

    const used = Number(CURRENT_PROFILE.reverse_uses || 0);
    if (used >= TRIAL_REVERSE_LIMIT){
      throw new Error(`Trial reverse limit reached (${TRIAL_REVERSE_LIMIT}). Unlock PRO for unlimited.`);
    }

    const next = used + 1;
    const { error } = await supabase
      .from("profiles")
      .update({ reverse_uses: next })
      .eq("id", CURRENT_USER.id);

    if (error) throw new Error(error.message || "Could not update reverse uses.");

    CURRENT_PROFILE.reverse_uses = next;
    reverseUsesLine.textContent = `Reverse uses: ${next}/${TRIAL_REVERSE_LIMIT} (Trial)`;
  }

  function refreshBulkLimitLine(){
    if (!CURRENT_PROFILE){
      bulkLimitLine.textContent = "Loading bulk limits…";
      return;
    }
    if (CURRENT_PROFILE.paid){
      bulkLimitLine.textContent = "PRO: unlimited rows • unlimited runs.";
      return;
    }

    const left = daysLeft(CURRENT_PROFILE.trial_start);
    if (left <= 0){
      bulkLimitLine.textContent = "Trial ended. Unlock PRO to use Bulk mode.";
      return;
    }

    const day = todayKey();
    const usedToday = (CURRENT_PROFILE.bulk_day === day) ? Number(CURRENT_PROFILE.bulk_runs_today || 0) : 0;
    const runsLeft = Math.max(0, TRIAL_BULK_RUNS_PER_DAY - usedToday);

    bulkLimitLine.textContent = `Trial: max ${TRIAL_BULK_MAX_ROWS} rows • ${runsLeft}/${TRIAL_BULK_RUNS_PER_DAY} bulk run(s) left today.`;
  }

  async function consumeBulkRunIfTrial(){
    if (!CURRENT_USER || !CURRENT_PROFILE) throw new Error("Session missing. Refresh and log in again.");
    if (CURRENT_PROFILE.paid) return;

    const left = daysLeft(CURRENT_PROFILE.trial_start);
    if (left <= 0) throw new Error("Trial ended. Unlock PRO to run bulk scans.");

    const day = todayKey();
    let usedToday = 0;
    if (CURRENT_PROFILE.bulk_day === day) usedToday = Number(CURRENT_PROFILE.bulk_runs_today || 0);

    if (usedToday >= TRIAL_BULK_RUNS_PER_DAY){
      throw new Error("Trial bulk limit reached for today. Try again tomorrow or unlock PRO.");
    }

    const next = usedToday + 1;
    const { error } = await supabase
      .from("profiles")
      .update({ bulk_day: day, bulk_runs_today: next })
      .eq("id", CURRENT_USER.id);

    if (error){
      throw new Error("Bulk daily limit storage missing in database. Add columns bulk_day + bulk_runs_today in profiles.");
    }

    CURRENT_PROFILE.bulk_day = day;
    CURRENT_PROFILE.bulk_runs_today = next;
    refreshBulkLimitLine();
  }

  // Calculate click
  document.getElementById("calcBtn").addEventListener("click", async ()=>{
    try{
      o1hint.style.color = "";
      if (MODE==="reverse") await consumeReverseUseIfTrial();
      compute();
    } catch(e){
      o1hint.textContent = e.message || "Error.";
      o1hint.style.color = "var(--bad)";
    }
  });

  // Reset
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    [sellPriceEl, productCostEl, shipCostEl, miscCostEl, feePctEl, feeFixedEl, adsPctEl, returnPctEl, targetProfitEl].forEach(el=>el.value="0");
    fxRateEl.value = "";
    presetSel.value = "manual";
    shareStatus.textContent = "—";
    bulkPasteEl.value = "";
    clearBulkRows();
    importBanner.style.display = "none";
    setMode("profit");
  });

  // CSV export (single)
  function payload(){
    return {
      mode: MODE,
      currency: currencyEl.value,
      fxRate: fxRateEl.value || "",
      preset: presetSel.value,
      sellPrice: sellPriceEl.value,
      productCost: productCostEl.value,
      shipCost: shipCostEl.value,
      miscCost: miscCostEl.value,
      feePct: feePctEl.value,
      feeFixed: feeFixedEl.value,
      adsPct: adsPctEl.value,
      returnPct: returnPctEl.value,
      targetProfit: targetProfitEl.value
    };
  }
  function csvEscape(s){ const t = String(s ?? ""); return /[",\n]/.test(t) ? `"${t.replaceAll('"','""')}"` : t; }
  function downloadText(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  document.getElementById("exportCsvBtn").addEventListener("click", ()=>{
    const p = payload();
    const rows = Object.entries(p).map(([k,v])=>[k,String(v ?? "")]);
    rows.unshift(["Field","Value"]);
    const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n");
    downloadText("profitpilot-export.csv", csv);
    shareStatus.textContent = "CSV exported.";
  });

  // PDF export (PRO)
  pdfBtn.addEventListener("click", ()=>{
    if (!CURRENT_PROFILE?.paid){ shareStatus.textContent="PDF is PRO."; return; }
    shareStatus.textContent="Preparing PDF…";
    setTimeout(()=>window.print(), 150);
  });

  // Share (PRO)
  function base64urlEncode(str){
    const bytes = new TextEncoder().encode(str);
    let bin=""; bytes.forEach(b=>bin+=String.fromCharCode(b));
    return btoa(bin).replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
  }
  shareBtn.addEventListener("click", ()=>{
    if (!CURRENT_PROFILE?.paid){ shareStatus.textContent="Share is PRO."; return; }
    const token = base64urlEncode(JSON.stringify(payload()));
    const url = `${location.origin}/share.html#s=${token}`;
    navigator.clipboard?.writeText(url).catch(()=>{});
    shareStatus.textContent="Share link copied.";
  });

  // ---- BULK TABLE MODE ----
  let bulkLastRows = [];

  function mkCellInput(value="0"){
    const inp = document.createElement("input");
    inp.className = "mini";
    inp.inputMode = "decimal";
    inp.value = String(value ?? "0");
    return inp;
  }
  function renumberBulkRows(){
    [...bulkTbody.children].forEach((tr,i)=> tr.children[0].textContent = String(i+1));
  }
  function rowCount(){ return bulkTbody.children.length; }
  function canAddRow(){
    if (!CURRENT_PROFILE) return false;
    if (CURRENT_PROFILE.paid) return true;
    return rowCount() < TRIAL_BULK_MAX_ROWS;
  }

  function addBulkRow(initial={}){
    const tr = document.createElement("tr");

    const idxTd = document.createElement("td");
    idxTd.textContent = String(rowCount() + 1);
    tr.appendChild(idxTd);

    const sell = mkCellInput(initial.sell ?? "0");
    const cost = mkCellInput(initial.cost ?? "0");
    const ship = mkCellInput(initial.ship ?? "0");
    const misc = mkCellInput(initial.misc ?? "0");
    const feePct = mkCellInput(initial.feePct ?? feePctEl.value);
    const feeFixed = mkCellInput(initial.feeFixed ?? feeFixedEl.value);
    const adsPct = mkCellInput(initial.adsPct ?? adsPctEl.value);
    const retPct = mkCellInput(initial.returnPct ?? returnPctEl.value);

    [sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct].forEach(inp=>{
      const td = document.createElement("td");
      td.appendChild(inp);
      tr.appendChild(td);
      inp.addEventListener("input", ()=> previewRow(tr));
    });

    const profitTd = document.createElement("td"); profitTd.textContent = "—"; tr.appendChild(profitTd);
    const marginTd = document.createElement("td"); marginTd.textContent = "—"; tr.appendChild(marginTd);

    const actTd = document.createElement("td");
    const delBtn = document.createElement("button");
    delBtn.className = "btn";
    delBtn.textContent = "Remove";
    delBtn.onclick = ()=>{
      tr.remove();
      renumberBulkRows();
      bulkStatus.textContent = "Row removed.";
      refreshBulkLimitLine();
    };
    actTd.appendChild(delBtn);
    tr.appendChild(actTd);

    tr._pp = { sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct, profitTd, marginTd };
    bulkTbody.appendChild(tr);
    renumberBulkRows();
    previewRow(tr);
  }

  function clearBulkRows(){
    bulkTbody.innerHTML = "";
    bulkLastRows = [];
    bulkStatus.textContent = "—";
    refreshBulkLimitLine();
  }

  function applyFeesToAll(){
    [...bulkTbody.children].forEach(tr=>{
      const r = tr._pp;
      r.feePct.value = feePctEl.value;
      r.feeFixed.value = feeFixedEl.value;
      r.adsPct.value = adsPctEl.value;
      r.retPct.value = returnPctEl.value;
      previewRow(tr);
    });
    bulkStatus.textContent = "Applied current fees to all rows.";
  }

  function computeRow(sell,cost,ship,misc,feePct,feeFixed,adsPct,returnPct){
    const fees = sell*(feePct/100) + feeFixed + sell*(adsPct/100);
    const profit = sell - (cost+ship+misc+fees);
    const margin = sell>0 ? (profit/sell)*100 : 0;
    return { profit, margin, fees };
  }

  function previewRow(tr){
    if (!tr?._pp) return;
    const r = tr._pp;
    const sell = n(r.sell.value);
    const cost = n(r.cost.value);
    const ship = n(r.ship.value);
    const misc = n(r.misc.value);
    const feePct = clamp(n(r.feePct.value),0,99);
    const feeFixed = clamp(n(r.feeFixed.value),0,999999);
    const adsPct = clamp(n(r.adsPct.value),0,99);
    const retPct = clamp(n(r.retPct.value),0,99);

    const res = computeRow(sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct);
    r.profitTd.textContent = money(res.profit);
    r.profitTd.className = res.profit >= 0 ? "good" : "bad";
    r.marginTd.textContent = pct(res.margin);
    r.marginTd.className = res.margin >= 10 ? "good" : (res.margin < 0 ? "bad" : "");
  }

  bulkAddRowBtn.addEventListener("click", ()=>{
    if (!CURRENT_PROFILE){ bulkStatus.textContent="Loading…"; return; }
    if (!canAddRow()){
      bulkStatus.textContent = `Trial limit: max ${TRIAL_BULK_MAX_ROWS} rows. Unlock PRO for unlimited.`;
      return;
    }
    addBulkRow();
    bulkStatus.textContent = "Row added.";
    refreshBulkLimitLine();
  });

  bulkClearBtn.addEventListener("click", ()=>{
    clearBulkRows();
    const initial = CURRENT_PROFILE?.paid ? 5 : TRIAL_BULK_MAX_ROWS;
    for (let i=0;i<initial;i++) addBulkRow();
    bulkStatus.textContent = "Reset rows.";
  });

  bulkApplyFeesBtn.addEventListener("click", ()=>applyFeesToAll());

  bulkRunBtn.addEventListener("click", async ()=>{
    try{
      if (!CURRENT_PROFILE){ bulkStatus.textContent="Loading…"; return; }

      if (!CURRENT_PROFILE.paid){
        const left = daysLeft(CURRENT_PROFILE.trial_start);
        if (left <= 0) throw new Error("Trial ended. Unlock PRO to use Bulk mode.");
        if (rowCount() > TRIAL_BULK_MAX_ROWS) throw new Error(`Trial allows max ${TRIAL_BULK_MAX_ROWS} rows.`);
        await consumeBulkRunIfTrial();
      }

      const trs = [...bulkTbody.children];
      if (!trs.length) throw new Error("Add at least 1 row.");

      const out = [];
      trs.forEach(tr=>{
        const r = tr._pp;
        const sell = n(r.sell.value);
        const cost = n(r.cost.value);
        const ship = n(r.ship.value);
        const misc = n(r.misc.value);
        const feePct = clamp(n(r.feePct.value),0,99);
        const feeFixed = clamp(n(r.feeFixed.value),0,999999);
        const adsPct = clamp(n(r.adsPct.value),0,99);
        const retPct = clamp(n(r.retPct.value),0,99);

        const res = computeRow(sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct);
        r.profitTd.textContent = money(res.profit);
        r.profitTd.className = res.profit >= 0 ? "good" : "bad";
        r.marginTd.textContent = pct(res.margin);
        r.marginTd.className = res.margin >= 10 ? "good" : (res.margin < 0 ? "bad" : "");

        out.push({ sell,cost,ship,misc,feePct,feeFixed,adsPct,retPct, fees:res.fees, profit:res.profit, margin:res.margin });
      });

      bulkLastRows = out;
      bulkStatus.textContent = `Processed ${out.length} row(s).`;
      refreshBulkLimitLine();
    } catch(e){
      bulkStatus.textContent = e.message || "Bulk failed.";
      refreshBulkLimitLine();
    }
  });

  bulkExportBtn.addEventListener("click", ()=>{
    if (!bulkLastRows.length){ bulkStatus.textContent = "Run bulk first."; return; }
    const rows = [["sell","cost","ship","misc","feePct","feeFixed","adsPct","returnPct","fees","profit","margin"]];
    bulkLastRows.forEach(r=> rows.push([r.sell,r.cost,r.ship,r.misc,r.feePct,r.feeFixed,r.adsPct,r.retPct,r.fees,r.profit,r.margin]));
    const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n");
    downloadText("profitpilot-bulk.csv", csv);
    bulkStatus.textContent = "Bulk CSV exported.";
  });

  function parseLines(text){
    const lines = text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    const rows = [];
    for (const line of lines){
      const parts = line.includes("\t") ? line.split("\t") : line.split(",");
      const p = parts.map(x=>x.trim()).filter(x=>x.length>0);
      if (p.length < 2) continue;
      rows.push({
        sell: p[0] ?? "0",
        cost: p[1] ?? "0",
        ship: p[2] ?? "0",
        misc: p[3] ?? "0",
        feePct: p[4] ?? feePctEl.value,
        feeFixed: p[5] ?? feeFixedEl.value,
        adsPct: p[6] ?? adsPctEl.value,
        returnPct: p[7] ?? returnPctEl.value
      });
    }
    return rows;
  }

  bulkFillExampleBtn.addEventListener("click", ()=>{
    bulkPasteEl.value = "12.99, 6.20, 0.00, 0.20\n19.99, 9.50, 0.00, 0.30\n29.99, 14.00, 0.00, 0.50";
    bulkImportStatus.textContent = "Example filled.";
  });

  bulkImportBtn.addEventListener("click", ()=>{
    bulkImportStatus.textContent = "Importing…";
    const rows = parseLines(bulkPasteEl.value || "");
    if (!rows.length){ bulkImportStatus.textContent = "Nothing to import."; return; }

    const allowed = (CURRENT_PROFILE?.paid) ? rows.length : Math.min(rows.length, TRIAL_BULK_MAX_ROWS);
    clearBulkRows();
    for (let i=0;i<allowed;i++) addBulkRow(rows[i]);

    bulkImportStatus.textContent = (!CURRENT_PROFILE?.paid && rows.length > allowed)
      ? `Imported ${allowed}. Trial limit is ${TRIAL_BULK_MAX_ROWS} rows.`
      : `Imported ${allowed} row(s).`;

    bulkStatus.textContent = "Review values, then Run bulk.";
    refreshBulkLimitLine();
  });

  // ---- My presets (PRO) ----
  async function loadMyPresets(){
    if (!CURRENT_PROFILE?.paid || !CURRENT_USER) return;
    const { data, error } = await supabase
      .from("user_presets")
      .select("id,name,fee_pct,fee_fixed,ads_pct,return_pct,created_at")
      .eq("user_id", CURRENT_USER.id)
      .order("created_at", { ascending:false });
    if (error){ presetStatus.textContent="Failed to load presets."; return; }
    myPresetSel.innerHTML = `<option value="">—</option>`;
    (data||[]).forEach(p=>{
      const opt = document.createElement("option");
      opt.value=p.id; opt.textContent=p.name;
      opt.dataset.feePct=p.fee_pct; opt.dataset.feeFixed=p.fee_fixed; opt.dataset.adsPct=p.ads_pct; opt.dataset.returnPct=p.return_pct;
      myPresetSel.appendChild(opt);
    });
    presetStatus.textContent = `Loaded ${data?.length||0} preset(s).`;
  }

  saveMyPresetBtn.addEventListener("click", async ()=>{
    if (!CURRENT_PROFILE?.paid || !CURRENT_USER) return;
    const name = myPresetName.value.trim();
    if (!name){ presetStatus.textContent="Enter a preset name."; return; }
    presetStatus.textContent="Saving…";
    const row = {
      user_id: CURRENT_USER.id,
      name,
      fee_pct: clamp(n(feePctEl.value),0,99),
      fee_fixed: clamp(n(feeFixedEl.value),0,999999),
      ads_pct: clamp(n(adsPctEl.value),0,99),
      return_pct: clamp(n(returnPctEl.value),0,99)
    };
    const { error } = await supabase.from("user_presets").insert([row]);
    if (error){ presetStatus.textContent=error.message||"Save failed."; return; }
    myPresetName.value="";
    await loadMyPresets();
    presetStatus.textContent="Saved.";
  });

  loadMyPresetBtn.addEventListener("click", ()=>{
    if (!CURRENT_PROFILE?.paid) return;
    const opt = myPresetSel.options[myPresetSel.selectedIndex];
    if (!opt || !opt.value){ presetStatus.textContent="Select a preset."; return; }
    feePctEl.value = String(opt.dataset.feePct ?? 0);
    feeFixedEl.value = String(opt.dataset.feeFixed ?? 0);
    adsPctEl.value = String(opt.dataset.adsPct ?? 0);
    returnPctEl.value = String(opt.dataset.returnPct ?? 0);
    presetSel.value = "manual";
    applyFeesToAll();
    compute();
    presetStatus.textContent="Loaded into fields.";
  });

  deleteMyPresetBtn.addEventListener("click", async ()=>{
    if (!CURRENT_PROFILE?.paid || !CURRENT_USER) return;
    const id = myPresetSel.value;
    if (!id){ presetStatus.textContent="Select a preset."; return; }
    presetStatus.textContent="Deleting…";
    const { error } = await supabase.from("user_presets").delete().eq("id", id).eq("user_id", CURRENT_USER.id);
    if (error){ presetStatus.textContent=error.message||"Delete failed."; return; }
    await loadMyPresets();
    presetStatus.textContent="Deleted.";
  });

  // Reviews submit
  let selectedStars = 5;
  const starsRow = document.getElementById("starsRow");
  const reviewStatus = document.getElementById("reviewStatus");
  function setStars(nv){
    selectedStars = nv;
    [...starsRow.querySelectorAll("button")].forEach(b=>{
      b.style.borderColor = (parseInt(b.dataset.star,10)===nv) ? "rgba(14,165,164,.45)" : "rgba(16,24,40,.10)";
      b.style.background = (parseInt(b.dataset.star,10)===nv) ? "rgba(14,165,164,.10)" : "rgba(255,255,255,.78)";
    });
  }
  setStars(5);
  starsRow.addEventListener("click",(e)=>{
    const btn=e.target.closest("button"); if(!btn) return;
    setStars(parseInt(btn.dataset.star,10));
  });

  document.getElementById("sendReview").addEventListener("click", async ()=>{
    reviewStatus.textContent="Submitting…";
    try{
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) throw new Error("Please log in again.");
      const name = document.getElementById("revName").value.trim();
      const category = document.getElementById("revCat").value;
      const message = document.getElementById("revMsg").value.trim();
      if (!message) throw new Error("Write a short review message.");
      const { error } = await supabase.from("reviews").insert([{
        user_id:user.id, name:name||null, rating:selectedStars, category, message, approved:true
      }]);
      if (error) throw error;
      reviewStatus.textContent="Thanks! Your review is public.";
      document.getElementById("revMsg").value="";
    } catch(e){
      reviewStatus.textContent=e.message||"Failed.";
    }
  });

  // Logout
  document.getElementById("logoutBtn").addEventListener("click", async ()=>{
    await supabase.auth.signOut();
    location.href = "login.html";
  });

  // ---- IMPORT FROM SHARE ----
  function base64urlDecodeToString(b64url){
    let s = (b64url||"").replace(/-/g, "+").replace(/_/g, "/");
    while (s.length % 4) s += "=";
    const bin = atob(s);
    const bytes = new Uint8Array([...bin].map(ch => ch.charCodeAt(0)));
    return new TextDecoder().decode(bytes);
  }

  function applyImportedData(data){
    // Defensive: only fill known fields
    if (data.currency) currencyEl.value = data.currency;
    fxRateEl.value = data.fxRate || "";

    presetSel.value = data.preset || "manual";

    sellPriceEl.value = String(data.sellPrice ?? "0");
    productCostEl.value = String(data.productCost ?? "0");
    shipCostEl.value = String(data.shipCost ?? "0");
    miscCostEl.value = String(data.miscCost ?? "0");

    feePctEl.value = String(data.feePct ?? "0");
    feeFixedEl.value = String(data.feeFixed ?? "0");
    adsPctEl.value = String(data.adsPct ?? "0");
    returnPctEl.value = String(data.returnPct ?? "0");

    targetProfitEl.value = String(data.targetProfit ?? "0");

    const m = (data.mode || "profit");
    if (m === "bulk") setMode("bulk");
    else if (m === "reverse") setMode("reverse");
    else setMode("profit");

    compute();

    importBanner.style.display = "block";
    importBanner.textContent = "Imported shared calculation ✅";
    setTimeout(()=>{ importBanner.style.display = "none"; }, 5500);

    // clean the hash so refresh doesn't keep re-importing
    history.replaceState(null, "", location.pathname);
  }

  function tryImportFromHash(){
    const h = location.hash || "";
    const m = h.match(/[#&]import=([^&]+)/);
    if (!m) return;
    try{
      const token = decodeURIComponent(m[1]);
      const jsonStr = base64urlDecodeToString(token);
      const data = JSON.parse(jsonStr);
      applyImportedData(data);
    } catch(e){
      importBanner.style.display = "block";
      importBanner.textContent = "Import failed (invalid link).";
      setTimeout(()=>{ importBanner.style.display = "none"; }, 7000);
      history.replaceState(null, "", location.pathname);
    }
  }

  // Boot
  (async ()=>{
    try{
      accessPill.textContent="Checking session…";
      const { data: { session } } = await supabase.auth.getSession();
      if (!session){ location.href="login.html"; return; }

      const { data: { user } } = await supabase.auth.getUser();
      if (!user){ location.href="login.html"; return; }
      CURRENT_USER = user;

      const profile = await ensureProfile(user.id);
      updateAccessUI(profile);

      if (profile.paid) await loadMyPresets();

      // Init bulk rows
      clearBulkRows();
      const initialRows = profile.paid ? 5 : TRIAL_BULK_MAX_ROWS;
      for (let i=0;i<initialRows;i++) addBulkRow();

      setMode("profit");
      computeProfit();

      // Import if present
      tryImportFromHash();

    } catch(e){
      accessPill.textContent="Access check failed";
      accessPill.className="pill bad";
    }
  })();
</script>
</body>
</html>
